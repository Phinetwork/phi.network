const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/jszip.min-Bb-dHT90.js","assets/jszip.min-CqUqA6n-.js","assets/index-DnnXc9Gf.js","assets/index-B0qmjPUx.css","assets/html2canvas-Cts9xj26.js","assets/html2canvas-Bcv-u-Yb.js","assets/svgMeta-DgHerpdT.js","assets/svgMeta-f-nPps_q.js"])))=>i.map(i=>d[i]);
import{C as e,E as t,M as n,O as r,S as i,T as a,b as o,c as s,d as c,j as l,l as u,t as d,v as f,w as p,x as m,y as h}from"./index-DnnXc9Gf.js";import{t as g}from"./html2canvas-Bcv-u-Yb.js";import{a as _,f as v,o as y,p as b}from"./sigilUrl-CnKlYdM0.js";import"./helpers-87occzUu.js";import{t as x}from"./SealMomentModal-m5VaL0TF.js";import{a as S,c as C,d as w,f as T,h as E,l as D,m as O,n as k,o as A,p as j,r as M,s as N,u as P}from"./valuation-fobxj7Zk.js";import{t as F}from"./SealMomentModal-Bw1OmBtH.js";import{_ as I,b as L,c as ee,d as R,f as z,i as te,l as ne,m as re,r as B,t as ie}from"./SovereignSolar-Bw39bWZB.js";import{n as ae,t as oe}from"./phi-issuance-DI2TeLq4.js";import{s as se,t as ce}from"./with-selector-BYkcW07l.js";import{t as V}from"./useFastPress-BW8cYo9c.js";import{a as le,d as H,f as ue,i as U,n as W,p as G,r as de,s as K,t as fe,u as pe}from"./svgMeta-f-nPps_q.js";var me=n(g(),1),he=n(p(),1),q=n(a(),1),J=n(d(),1);function ge(e){(0,q.useEffect)(()=>{let e=`sigilheader-authbadgefx-v3`;if(document.getElementById(e))return;let t=document.createElement(`style`);t.id=e,t.textContent=`
`).map(e=>e.trim()).filter(e=>e.length>0&&lC(e)).slice(0,6),[x.mediaLines]),E=x.text.trim().length,D=x.title.trim().length,O=!!n&&E>0&&E<=4e3&&D<=140&&b.length>0,k=(0,q.useCallback)(e=>{(e.ctrlKey||e.metaKey)&&e.key===`Enter`&&O&&(e.preventDefault(),(async()=>ee())())},[O]),A=(0,q.useCallback)(e=>{p(e),m.current&&(m.current.textContent=e)},[]),j=(0,q.useCallback)(e=>{let t=e.currentTarget.value;S(e=>({...e,title:t}))},[S]),M=(0,q.useCallback)(e=>{let t=e.currentTarget.value;S(e=>({...e,text:t}))},[S]),N=(0,q.useCallback)(e=>{let t=e.currentTarget.value;S(e=>({...e,mediaLines:t}))},[S]),P=(0,q.useCallback)(e=>{let t=e.currentTarget.checked;S(e=>({...e,shareToLocalFeed:t}))},[S]),I=(0,q.useCallback)(e=>{let t=e.currentTarget.checked;S(e=>({...e,includeCanonicalHash:t}))},[S]),L=(0,q.useCallback)(()=>{if(!i)return;let e={url:i,hash:o,appId:b,pulse:r.pulse,beat:r.beat,stepIndex:r.stepIndex,title:x.title.trim()||void 0,text:x.text.trim()||void 0,tags:w.length?w:void 0,media:T,timestamp:new Date().toISOString()},t=new Blob([JSON.stringify(e,null,2)],{type:`application/json`}),n=document.createElement(`a`),a=URL.createObjectURL(t);n.href=a,n.download=`sigil-mint-${o||`post`}.json`,document.body.appendChild(n),n.click(),n.remove(),URL.revokeObjectURL(a)},[i,o,b,r.pulse,r.beat,r.stepIndex,x.title,x.text,w,T]),ee=(0,q.useCallback)(async()=>{if(!n){alert(`Login with your user glyph first.`);return}if(!O){alert(`Please write something first.`);return}if(n.expiresAtPulse&&r.pulse>n.expiresAtPulse){alert(`Login glyph expired (pulse window). Re-mint login.`);return}d(!0),A(`Sealing capsule…`);try{let e=`post`,t=typeof crypto<`u`&&`randomUUID`in crypto?crypto.randomUUID().slice(0,8):Math.random().toString(36).slice(2,10),i=(await sC(`${b}|${n.userPhiKey}|${r.pulse}|${r.beat}|${r.stepIndex}|${e}|${t}`)).slice(0,16),o=T.length>0?T.map(e=>({kind:`url`,url:e})):void 0,c={v:1,kind:e,appId:b,userId:n.userPhiKey,pulse:r.pulse,beat:r.beat,stepIndex:r.stepIndex,userPhiKey:n.userPhiKey,kaiSignature:n.kaiSignature,post:{title:x.title.trim()||void 0,text:x.text.trim(),tags:w.length?w:void 0,media:o},nonce:t,timestamp:new Date().toISOString(),...x.includeCanonicalHash?{canonicalHash:b}:{}},u=iC(`/s/${b}/${n.userPhiKey}/${r.pulse}/${r.beat}/${r.stepIndex}/${e}/${i}`,c);if(x.shareToLocalFeed)try{let e=`sigil:feed:sources`,t=typeof localStorage<`u`&&localStorage.getItem(e)||`[]`,n=JSON.parse(t),r=Array.isArray(n)?n.filter(e=>typeof e==`string`):[],i=Array.from(new Set([u,...r]));typeof localStorage<`u`&&localStorage.setItem(e,JSON.stringify(i)),typeof window<`u`&&window.dispatchEvent(new CustomEvent(`sigil:published`,{detail:{url:u}}))}catch(e){console.warn(`Local feed cache/broadcast failed:`,e instanceof Error?e.message:String(e))}a(u),s(i),l(!0),A(`Minted ✓`),S(e=>({...e,text:``,mediaLines:``}))}catch(e){A(`Mint failed: ${e instanceof Error?e.message:String(e)}`),console.error(e)}finally{d(!1),window.setTimeout(()=>A(``),1400)}},[n,O,b,r.pulse,r.beat,r.stepIndex,T,x.title,x.text,x.shareToLocalFeed,x.includeCanonicalHash,S,A,w.length]),R=(0,q.useMemo)(()=>r.stepIndex/43*100,[r.stepIndex]),z=(0,q.useMemo)(()=>n?b?x.text.trim()?n.expiresAtPulse&&r.pulse>n.expiresAtPulse?`Session expired; re-login.`:``:`Write something first.`:`Missing app glyph context.`:`Login with your glyph to mint.`,[n,b,x.text,r.pulse]);return(0,J.jsxs)(J.Fragment,{children:[(0,J.jsxs)(`section`,{className:`publisher ks-panel`,"data-beat":r.beat,children:[(0,J.jsxs)(`header`,{className:`ks-head`,children:[(0,J.jsxs)(`div`,{className:`ks-head-left`,children:[(0,J.jsx)(`h3`,{className:`ks-title`,children:`Publish to Glyph Stream (Coming SOON!)`}),(0,J.jsxs)(`p`,{className:`ks-meta`,children:[`App: `,(0,J.jsx)(`span`,{className:`mono`,children:cC(b)}),n?(0,J.jsxs)(J.Fragment,{children:[` `,`• User: `,(0,J.jsx)(`span`,{className:`mono`,children:cC(n.userPhiKey)})]}):null]})]}),(0,J.jsx)(`div`,{className:`ks-head-right`,children:(0,J.jsxs)(`div`,{className:`ks-pulse`,role:`img`,"aria-label":`Pulse ${r.pulse}, Beat ${r.beat}, Step ${r.stepIndex}, Chakra ${r.chakraDay}`,title:`Pulse ${r.pulse} • Beat ${r.beat} • Step ${r.stepIndex} • ${r.chakraDay}`,children:[(0,J.jsx)(`div`,{className:`ks-pulse-bar`,children:(0,J.jsx)(`div`,{className:`ks-pulse-fill`,style:{width:`${R.toFixed(1)}%`}})}),(0,J.jsxs)(`div`,{className:`ks-pulse-meta`,children:[(0,J.jsxs)(`span`,{children:[`u`,r.pulse]}),(0,J.jsxs)(`span`,{children:[`b`,r.beat]}),(0,J.jsxs)(`span`,{children:[`s`,r.stepIndex]}),(0,J.jsx)(`span`,{className:`ks-chakra`,children:r.chakraDay})]})]})})]}),(0,J.jsxs)(`div`,{className:`ks-form`,children:[(0,J.jsxs)(`div`,{className:`ks-row`,children:[(0,J.jsxs)(`label`,{htmlFor:h,className:`ks-label`,children:[`Title `,(0,J.jsx)(`span`,{className:`ks-optional`,children:`(optional)`})]}),(0,J.jsx)(`input`,{id:h,className:`ks-input`,type:`text`,value:x.title,onChange:j,onKeyDown:k,maxLength:140,placeholder:`A crisp resonance headline…`,"aria-describedby":`${h}-count`}),(0,J.jsxs)(`div`,{id:`${h}-count`,className:`ks-count`,children:[D,`/140`]})]}),(0,J.jsxs)(`div`,{className:`ks-row`,children:[(0,J.jsx)(`label`,{htmlFor:g,className:`ks-label`,children:`Post`}),(0,J.jsx)(`textarea`,{id:g,className:`ks-textarea`,rows:5,value:x.text,onChange:M,onKeyDown:k,maxLength:4e3,placeholder:`Breathe once, then write…  (#tags supported)`,"aria-describedby":`${g}-count`}),(0,J.jsxs)(`div`,{id:`${g}-count`,className:`ks-count`,children:[E,`/4000`]})]}),(0,J.jsxs)(`div`,{className:`ks-row`,children:[(0,J.jsxs)(`label`,{htmlFor:_,className:`ks-label`,children:[`Media URLs `,(0,J.jsx)(`span`,{className:`ks-optional`,children:`(optional)`})]}),(0,J.jsx)(`textarea`,{id:_,className:`ks-textarea mono`,rows:2,value:x.mediaLines,onChange:N,onKeyDown:k,placeholder:`https://… (one per line, up to 6)`}),T.length>0&&(0,J.jsx)(`div`,{className:`ks-media-preview`,children:T.map(e=>(0,J.jsx)(`a`,{className:`ks-chip`,href:e,target:`_blank`,rel:`noreferrer`,title:e,children:new URL(e).host},e))})]}),(0,J.jsxs)(`div`,{className:`ks-row ks-options`,children:[(0,J.jsxs)(`label`,{className:`ks-check`,children:[(0,J.jsx)(`input`,{id:v,type:`checkbox`,checked:x.shareToLocalFeed,onChange:P}),(0,J.jsx)(`span`,{children:`Mirror to local feed pool`})]}),(0,J.jsxs)(`label`,{className:`ks-check`,children:[(0,J.jsx)(`input`,{id:y,type:`checkbox`,checked:x.includeCanonicalHash,onChange:I}),(0,J.jsx)(`span`,{children:`Embed canonicalHash for sanity`})]}),w.length>0&&(0,J.jsx)(`div`,{className:`ks-tags`,children:w.map(e=>(0,J.jsxs)(`span`,{className:`ks-tag`,children:[`#`,e]},e))})]}),(0,J.jsxs)(`div`,{className:`ks-actions`,children:[(0,J.jsxs)(`button`,{type:`button`,className:`ks-btn primary`,onClick:ee,disabled:!O||u,title:z,children:[u?`Minting…`:`Mint Post Glyph`,(0,J.jsxs)(`span`,{className:`ks-kbd`,children:[`⌘/Ctrl `,(0,J.jsx)(`span`,{className:`plus`,children:`+`}),` Enter`]})]}),(0,J.jsx)(`button`,{type:`button`,className:`ks-btn ghost`,onClick:C,disabled:u||!x.title&&!x.text&&!x.mediaLines,title:`Clear draft`,children:`Clear Draft`}),i&&(0,J.jsxs)(J.Fragment,{children:[(0,J.jsx)(`a`,{className:`ks-btn`,href:i,target:`_blank`,rel:`noreferrer`,children:`Open`}),(0,J.jsx)(`button`,{type:`button`,className:`ks-btn`,onClick:async()=>{try{await navigator.clipboard.writeText(i),A(`URL copied`),window.setTimeout(()=>A(``),1e3)}catch(e){console.warn(`Remember failed:`,e instanceof Error?e.message:String(e))}},children:`Remember`})]})]}),(0,J.jsx)(`div`,{className:`ks-status`,role:`status`,"aria-live":`polite`,ref:m,children:f}),i&&(0,J.jsx)(`div`,{className:`ks-minted mono`,"data-testid":`minted-url`,children:i})]})]}),(0,J.jsx)(F,{open:c,url:i,hash:o,onClose:()=>l(!1),onDownloadZip:L})]})}const yC=e=>e===`verified`?`ok`:e;var bC=e=>typeof e==`number`&&Number.isFinite(e),xC=(e,t=0)=>{if(bC(e))return e;if(typeof e==`string`&&e.trim()!==``){let n=Number(e);return Number.isFinite(n)?n:t}return t},SC=e=>e===`mint`||e===`transfer`||e===`claim`;function CC(e,t){let n=t??xC(e.pulse,0);return(Array.isArray(e.provenance)?e.provenance:[]).flatMap(e=>{if(!e||typeof e!=`object`)return[];let t=e,r=typeof t.ownerPhiKey==`string`?t.ownerPhiKey:``,i=typeof t.kaiSignature==`string`?t.kaiSignature:void 0,a=xC(t.pulse,n),o=xC(t.beat,0),s;if(bC(t.stepIndex))s=t.stepIndex;else if(typeof t.stepIndex==`string`&&t.stepIndex.trim()!==``){let e=xC(t.stepIndex,NaN);Number.isFinite(e)&&(s=e)}let c=typeof t.atPulse==`string`&&t.atPulse.trim()!==``||bC(t.atPulse)?xC(t.atPulse,a):a,l=typeof t.attachmentName==`string`?t.attachmentName:void 0,u=SC(t.action)?t.action:`mint`;return[{ownerPhiKey:r,kaiSignature:i,pulse:a,beat:o,stepIndex:s,atPulse:c,attachmentName:l,action:u}]})}function wC(e,t,n,r,i,a){let o=n.stepsPerBeat??44,s=ue(n.pulse,o);return{ownerPhiKey:e,kaiSignature:t,pulse:n.pulse,beat:n.beat,stepIndex:s,atPulse:a,attachmentName:i,action:r}}function TC(e,t){let n=document.head.querySelectorAll(`meta[name], meta[property]`);for(let r of n)if(r.getAttribute(e)===t)return r;return null}function EC(e,t){let n=TC(e,t);return n||(n=document.createElement(`meta`),n.setAttribute(e,t),document.head.appendChild(n)),n}function DC(e,t,n){let r=EC(e,t);n==null?r.removeAttribute(`content`):r.setAttribute(`content`,n)}function OC(e){let t=document.head.querySelectorAll(`link[rel]`);for(let n of t)if((n.getAttribute(`rel`)||``).toLowerCase()===e.toLowerCase())return n;return null}function kC(e){let t=OC(e);return t||(t=document.createElement(`link`),t.setAttribute(`rel`,e),document.head.appendChild(t)),t}function AC(e,t){let n=document.getElementById(e);n||(n=document.createElement(`script`),n.id=e,n.type=`application/ld+json`,document.head.appendChild(n)),n.textContent=JSON.stringify(t)}const jC={Root:{hue:0,accent:`#CC3F3F`},Sacral:{hue:24,accent:`#E86428`},"Solar Plexus":{hue:48,accent:`#E6B844`},Heart:{hue:140,accent:`#2CCB99`},Throat:{hue:190,accent:`#00D5AA`},"Third Eye":{hue:260,accent:`#6B4AC0`},Crown:{hue:300,accent:`#C25AA4`}},MC=()=>/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform===`MacIntel`&&(navigator.maxTouchPoints??0)>1;function NC(){let[e,t]=(0,q.useState)(null),[n,r]=(0,q.useState)(s),i=(0,q.useRef)(null),a=(0,q.useRef)(null);return(0,q.useEffect)(()=>{let e=null,n=()=>{let e=c(new Date),n=Date.now();if(a.current==null||e.pulse!==a.current)a.current=e.pulse,i.current=n,t(e.pulse),r(s);else{let a=i.current,o=a==null?s:Math.max(0,s-(n-a));t(e.pulse),r(o)}};return e=window.setInterval(n,50),n(),()=>{e!=null&&window.clearInterval(e)}},[]),{pulse:e,msToNextPulse:n}}function PC(e){if(!e||typeof e!=`object`)return!1;let t=e;return typeof t.name==`string`&&typeof t.mime==`string`&&typeof t.dataUri==`string`&&typeof t.size==`number`}function FC(e){if(!e||typeof e!=`object`)return!1;let t=e,n=t.action,r=n===`mint`||n===`transfer`||n===`claim`;return typeof t.ownerPhiKey==`string`&&typeof t.pulse==`number`&&typeof t.beat==`number`&&typeof t.atPulse==`number`&&r}function IC(e){return!!e&&typeof e==`object`}function LC(e){if(!e)return{};if(typeof e==`object`)return e;if(typeof e==`string`)try{let t=JSON.parse(e);if(t&&typeof t==`object`)return t}catch{}return{}}function RC(e){try{let t=new URLSearchParams(e),n=t.get(`p`);if(!n)return null;let r=y(n);if(!r||typeof r!=`object`)return null;let i=r.stepsPerBeat,a=i!=null&&!Number.isNaN(Number(i))?Math.max(1,Math.floor(Number(i))):44,o=r.stepIndex,s=o!=null&&!Number.isNaN(Number(o))?Math.max(0,Math.min(a-1,Math.floor(Number(o)))):void 0,c=typeof r.stepPct==`number`?Math.max(0,Math.min(1,r.stepPct)):s==null?0:(s+1e-9)/a,l=r.expiresAtPulse==null?NaN:Number(r.expiresAtPulse),u=r.exportedAtPulse==null?NaN:Number(r.exportedAtPulse),d=(r.claimExtendUnit||``).toString().toLowerCase(),f=d===`steps`?`steps`:d===`breaths`?`breaths`:void 0,p=r.claimExtendAmount!=null&&!Number.isNaN(Number(r.claimExtendAmount))?Math.max(0,Math.floor(Number(r.claimExtendAmount))):void 0,m=Array.isArray(r.provenance)?r.provenance.filter(FC):void 0,h=PC(r.attachment)?r.attachment:void 0,g=typeof r.zkPoseidonHash==`string`?r.zkPoseidonHash:`0x`,_=IC(r.zkProof)?r.zkProof:{},v=LC(r.ownerPubKey),b=typeof r.ownerSig==`string`?r.ownerSig:``,x=r.eternalRecord??null,S=typeof r.creatorResolved==`boolean`?r.creatorResolved:!1,C=typeof r.origin==`string`?r.origin:``,w=Array.isArray(r.proofHints)?r.proofHints??[]:[],T={pulse:Number(r.pulse)||0,beat:Number(r.beat)||0,chakraDay:r.chakraDay,stepIndex:s,stepPct:c,kaiSignature:typeof r.kaiSignature==`string`?r.kaiSignature:void 0,userPhiKey:typeof r.userPhiKey==`string`?r.userPhiKey:void 0,stepsPerBeat:a,provenance:m,attachment:h,expiresAtPulse:Number.isFinite(l)?l:void 0,canonicalHash:typeof r.canonicalHash==`string`?r.canonicalHash:void 0,transferNonce:typeof r.transferNonce==`string`?r.transferNonce:void 0,exportedAtPulse:Number.isFinite(u)?u:void 0,claimExtendUnit:f,claimExtendAmount:p,zkPoseidonHash:g,zkProof:_,ownerPubKey:v,ownerSig:b,eternalRecord:x,creatorResolved:S,origin:C,proofHints:w},E=t.get(`t`);return E&&!T.transferNonce&&(T.transferNonce=E),T}catch{return null}}function zC(e,t){try{let n=RC(e);return n?{payload:n,verified:`ok`,error:null,loading:!1}:{payload:null,verified:t?`notfound`:`checking`,error:null,loading:!1}}catch(e){return{payload:null,verified:`error`,error:e instanceof Error?e.message:`Failed to decode payload`,loading:!1}}}function BC(e,t=null){let[n,r]=(0,q.useState)(void 0),[i,a]=(0,q.useState)(void 0),o=(0,q.useMemo)(()=>zC(e,t),[e,t]),s=n===void 0?o.payload:n,c=i===void 0?o.loading:i;return{payload:s,loading:c,verified:o.verified,error:o.error,setPayload:e=>{r(()=>typeof e==`function`?e(s):e)},setLoading:e=>{a(()=>typeof e==`function`?e(c):e)}}}const VC=e=>typeof window>`u`?``:window.btoa(String.fromCharCode(...new Uint8Array(e)));function HC(e,t){e(t),window.setTimeout(()=>e(``),1400)}async function UC(){return(await i(()=>import(`./jszip.min-BrJa-2Ue.js`).then(l(1)),__vite__mapDeps([0,1,2,3]))).default}const WC=(e,t=600)=>{let n=window;return typeof n.requestIdleCallback==`function`?n.requestIdleCallback(e,{timeout:t}):window.setTimeout(()=>e({didTimeout:!0,timeRemaining:()=>0}),90)},GC=e=>{let t=window;typeof t.cancelIdleCallback==`function`?t.cancelIdleCallback(e):window.clearTimeout(e)},KC=async e=>{let t=new TextEncoder().encode(e),n=await crypto.subtle.digest(`SHA-256`,t);return Array.from(new Uint8Array(n)).map(e=>e.toString(16).padStart(2,`0`)).join(``)};function qC(e,t,n){return`hsl(${e} ${t}% ${n}%)`}function JC(e){if(!e)return 0;let t=parseInt(e.slice(-2),16);return Number.isFinite(t)?t%12:0}function YC(e,t,n){return qC(((jC[e]?.hue??180)+JC(n||void 0)*2.5)%360,100,50+15*Math.sin(t*2*Math.PI))}const XC=e=>e.toFixed(6);function ZC(e){let t=String(e||``);return t.startsWith(`h:`)?t:`h:${t}`}var QC=`123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz`;const $C=e=>Array.from(e).map(e=>e.toString(16).padStart(2,`0`)).join(``);function ew(e){let t=e.buffer;if(t instanceof ArrayBuffer)return e.byteOffset===0&&e.byteLength===t.byteLength?t:t.slice(e.byteOffset,e.byteOffset+e.byteLength);let n=new ArrayBuffer(e.byteLength);return new Uint8Array(n).set(e),n}async function tw(e){let t=typeof e==`string`?new TextEncoder().encode(e):e,n=await crypto.subtle.digest(`SHA-256`,ew(t));return $C(new Uint8Array(n))}function nw(e){let t=0n;for(let n of e)t=(t<<8n)+BigInt(n);let n=``;for(;t>0n;)n=QC[Number(t%58n)]+n,t/=58n;for(let t=0;t<e.length&&e[t]===0;t++)n=`1`+n;return n}async function rw(e,t=0){let n=new Uint8Array(1+e.length);n[0]=t,n.set(e,1);let r=await crypto.subtle.digest(`SHA-256`,ew(n)),i=await crypto.subtle.digest(`SHA-256`,r),a=new Uint8Array(i).slice(0,4),o=new Uint8Array(n.length+4);return o.set(n),o.set(a,n.length),nw(o)}async function iw(e){let t=await tw(e+`φ`),n=new Uint8Array(20);for(let e=0;e<20;e++)n[e]=parseInt(t.slice(e*2,e*2+2),16);return rw(n,0)}function aw(e,t,n,r,i){return`${e}|${t}|${n}|${r}|${i??``}`}function ow(e){if(typeof e!=`object`||!e)return;let t=e.intentionSigil;return typeof t==`string`?t:void 0}function sw(e){return typeof e==`object`&&!!e&&!Array.isArray(e)}function cw(e){if(!e)return null;try{let t=JSON.parse(e);return sw(t)?t:null}catch{return null}}function lw(e){try{let t=Array.from(e.querySelectorAll(`metadata`));if(!t.length)return;let n=t.find(e=>e.getAttribute(`data-noncanonical`)!==`1`&&e.id!==`sigil-display`)??t[0];n&&e.firstChild!==n&&e.insertBefore(n,e.firstChild)}catch(e){console.debug(`ensureCanonicalMetadataFirst failed:`,e)}}function uw(e){let t=Array.from(e.querySelectorAll(`metadata`));return t.length?t.find(e=>e.getAttribute(`data-noncanonical`)!==`1`&&e.id!==`sigil-display`)??t[0]:null}function dw(e,t){try{let n=uw(e);if(!n)return;let r=cw(n.textContent?.trim()??``)??{},i=t(Object.freeze(r));n.textContent=JSON.stringify(i),e.firstChild!==n&&e.insertBefore(n,e.firstChild)}catch(e){console.debug(`rewriteCanonicalMetadata failed:`,e)}}function fw(e,t,n,r){try{let i=`ks-${t}-${n}-`,a=`${i}${r}`,o=a;e.setAttribute(`id`,o),e.setAttribute(`aria-describedby`,`${o}-desc`);let s=e.querySelector(`desc`);s&&s.setAttribute(`id`,`${o}-desc`),e.setAttribute(`data-step-index`,String(r));let c=new Map,l=RegExp(`^${i}(\\d+)(.*)$`);e.querySelectorAll(`[id]`).forEach(e=>{let t=e.getAttribute(`id`)||``,n=l.exec(t);if(!n)return;let i=n[1],o=n[2]||``;if(i!==String(r)){let e=`${a}${o}`;c.set(t,e)}});let u=e.getAttribute(`id`)||``,d=l.exec(u);d&&d[1]!==String(r)&&c.set(u,o),c.forEach((t,n)=>{let r=e.querySelector(`[id="${n}"]`);r&&r.setAttribute(`id`,t)});let f=[`href`,`xlink:href`,`filter`,`mask`,`fill`,`stroke`,`style`,`aria-describedby`],p=(e,t,n)=>e.indexOf(t)===-1?e:e.split(t).join(n);e.querySelectorAll(`*`).forEach(e=>{for(let t of f){let n=e.getAttribute(t);if(!n)continue;let r=n;c.forEach((e,t)=>{r=p(r,`url(#${t}`,`url(#${e}`),r=p(r,`"#${t}"`,`"#${e}"`),r=p(r,`'#${t}'`,`'#${e}'`),r=p(r,`#${t}`,`#${e}`),r=p(r,`&quot;#${t}&quot;`,`&quot;#${e}&quot;`)}),r!==n&&e.setAttribute(t,r)}});let m=RegExp(`(Day\\s+Seal:\\s*${n}\\s*:)\\s*\\d+`);e.querySelectorAll(`text`).forEach(e=>{let t=e.textContent||``,n=t.replace(m,`$1${r}`);n!==t&&(e.textContent=n)});let h=44;try{let t=uw(e),n=t?cw(t.textContent?.trim()):null,r=Number(n?.stepsPerBeat);Number.isFinite(r)&&r>0&&(h=Math.max(1,Math.floor(r)))}catch{}let g=Number(e.getAttribute(`data-steps-per-beat`));Number.isFinite(g)&&g>0&&(h=Math.max(1,Math.floor(g))),dw(e,e=>{let i={...e};if(i.pulse=t,i.kaiPulse=t,i.beat=n,i.stepIndex=r,i.stepsPerBeat=h,typeof i.eternalRecord==`string`){let e=RegExp(`(Day\\s*Seal:\\s*${n}\\s*:)\\s*\\d+`);i.eternalRecord=i.eternalRecord.replace(e,`$1${r}`)}return i}),lw(e)}catch(e){console.debug(`retagSvgIdsForStep failed:`,e)}}function pw(){let e=`sigilpage-crystal-styles`;if(document.getElementById(e))return;let t=document.createElement(`style`);t.id=e,t.innerHTML=`
`;return typeof a==`function`&&a(null,p),p}})),vT=n(t((e=>{var t=Gw(),n=mT(),r=gT(),i=_T();function a(e,r,i,a,o){let s=[].slice.call(arguments,1),c=s.length,l=typeof s[c-1]==`function`;if(!l&&!t())throw Error(`Callback required as last argument`);if(l){if(c<2)throw Error(`Too few arguments provided`);c===2?(o=i,i=r,r=a=void 0):c===3&&(r.getContext&&o===void 0?(o=a,a=void 0):(o=a,a=i,i=r,r=void 0))}else{if(c<1)throw Error(`Too few arguments provided`);return c===1?(i=r,r=a=void 0):c===2&&!r.getContext&&(a=i,i=r,r=void 0),new Promise(function(t,o){try{t(e(n.create(i,a),r,a))}catch(e){o(e)}})}try{let t=n.create(i,a);o(null,e(t,r,a))}catch(e){o(e)}}e.create=n.create,e.toCanvas=a.bind(null,r.render),e.toDataURL=a.bind(null,r.renderToDataURL),e.toString=a.bind(null,function(e,t,n){return i.render(e,n)})}))(),1);const yT=1024,bT=2048,xT=1200;function ST(e,t){let n=e.querySelector(`defs`);n||(n=e.ownerDocument.createElementNS(fe.SVG_NS,`defs`),e.insertBefore(n,e.firstChild));let r=`ep-neon-glow`;if(!e.querySelector(`#${r}`)){let t=e.ownerDocument.createElementNS(fe.SVG_NS,`filter`);t.setAttribute(`id`,r),t.setAttribute(`x`,`-50%`),t.setAttribute(`y`,`-50%`),t.setAttribute(`width`,`200%`),t.setAttribute(`height`,`200%`);let i=e.ownerDocument.createElementNS(fe.SVG_NS,`feGaussianBlur`);i.setAttribute(`stdDeviation`,`3`),i.setAttribute(`result`,`b1`);let a=e.ownerDocument.createElementNS(fe.SVG_NS,`feGaussianBlur`);a.setAttribute(`in`,`SourceGraphic`),a.setAttribute(`stdDeviation`,`1.2`),a.setAttribute(`result`,`b2`);let o=e.ownerDocument.createElementNS(fe.SVG_NS,`feMerge`),s=e.ownerDocument.createElementNS(fe.SVG_NS,`feMergeNode`);s.setAttribute(`in`,`b1`);let c=e.ownerDocument.createElementNS(fe.SVG_NS,`feMergeNode`);c.setAttribute(`in`,`b2`);let l=e.ownerDocument.createElementNS(fe.SVG_NS,`feMergeNode`);l.setAttribute(`in`,`SourceGraphic`),o.appendChild(s),o.appendChild(c),o.appendChild(l),t.appendChild(i),t.appendChild(a),t.appendChild(o),n.appendChild(t)}let i=`ep-gloss-gradient`;if(!e.querySelector(`#${i}`)){let t=e.ownerDocument.createElementNS(fe.SVG_NS,`linearGradient`);t.setAttribute(`id`,i),t.setAttribute(`x1`,`0`),t.setAttribute(`y1`,`0`),t.setAttribute(`x2`,`0`),t.setAttribute(`y2`,`1`);let r=e.ownerDocument.createElementNS(fe.SVG_NS,`stop`);r.setAttribute(`offset`,`0%`),r.setAttribute(`stop-color`,`rgba(255,255,255,0.15)`);let a=e.ownerDocument.createElementNS(fe.SVG_NS,`stop`);a.setAttribute(`offset`,`100%`),a.setAttribute(`stop-color`,`rgba(255,255,255,0.05)`),t.appendChild(r),t.appendChild(a),n.appendChild(t)}let a=`ep-bar-outer-glow`;if(!e.querySelector(`#${a}`)){let r=e.ownerDocument.createElementNS(fe.SVG_NS,`filter`);r.setAttribute(`id`,a),r.setAttribute(`x`,`-50%`),r.setAttribute(`y`,`-50%`),r.setAttribute(`width`,`200%`),r.setAttribute(`height`,`200%`);let i=e.ownerDocument.createElementNS(fe.SVG_NS,`feFlood`);i.setAttribute(`flood-color`,t),i.setAttribute(`flood-opacity`,`0.5`),i.setAttribute(`result`,`c`);let o=e.ownerDocument.createElementNS(fe.SVG_NS,`feComposite`);o.setAttribute(`in`,`c`),o.setAttribute(`in2`,`SourceAlpha`),o.setAttribute(`operator`,`in`),o.setAttribute(`result`,`glow`);let s=e.ownerDocument.createElementNS(fe.SVG_NS,`feGaussianBlur`);s.setAttribute(`in`,`glow`),s.setAttribute(`stdDeviation`,`4`),s.setAttribute(`result`,`blurGlow`);let c=e.ownerDocument.createElementNS(fe.SVG_NS,`feMerge`),l=e.ownerDocument.createElementNS(fe.SVG_NS,`feMergeNode`);l.setAttribute(`in`,`blurGlow`);let u=e.ownerDocument.createElementNS(fe.SVG_NS,`feMergeNode`);u.setAttribute(`in`,`SourceGraphic`),c.appendChild(l),c.appendChild(u),r.appendChild(i),r.appendChild(o),r.appendChild(s),r.appendChild(c),n.appendChild(r)}return{neonId:`ep-neon-glow`,glossId:`ep-gloss-gradient`,barGlowId:`ep-bar-outer-glow`}}async function CT(e,t){let{accent:n,qrUrl:r}=t,i=(e.getAttribute(`viewBox`)||`0 0 ${e.getAttribute(`width`)||1024} ${e.getAttribute(`height`)||1024}`).trim().split(/\s+/).map(Number),a=i[0]||0,o=i[1]||0,s=i[2]||1024,c=i[3]||1024,l=e.ownerDocument.createElementNS(fe.SVG_NS,`g`);l.setAttribute(`data-export-qr`,`1`);let u=Math.min(s,c),d=Math.max(u*.035,18),f=Math.max(u*.1,96),p=await vT.toDataURL(r,{margin:0,color:{dark:n,light:`#00000000`},scale:8}),m=e.ownerDocument.createElementNS(fe.SVG_NS,`image`);m.setAttributeNS(fe.XLINK_NS,`xlink:href`,p),m.setAttribute(`href`,p),m.setAttribute(`x`,String(a+d)),m.setAttribute(`y`,String(o+c-f-d)),m.setAttribute(`width`,String(f)),m.setAttribute(`height`,String(f)),m.setAttribute(`preserveAspectRatio`,`xMidYMid meet`),l.appendChild(m),e.appendChild(l)}async function wT(e,t=yT,n){let r=e.cloneNode(!0);if(U(r,t),le(r),de(r,n?.title||`Kairos Sigil-Glyph — Sealed Kairos Moment`,n?.desc||`Deterministic sigil-glyph with sovereign metadata.`),n?.metaOverride){let e=W(r);e.textContent=JSON.stringify(n.metaOverride)}if(r.querySelectorAll(`[data-export-qr="1"],[data-export-pulsebar="1"]`).forEach(e=>e.parentNode?.removeChild(e)),n?.addQR&&await CT(r,n.addQR),n?.addPulseBar){let{accent:e,pulseNumber:i}=n.addPulseBar,{barGlowId:a,neonId:o,glossId:s}=ST(r,e),c=(r.getAttribute(`viewBox`)||`0 0 ${t} ${t}`).split(/\s+/).map(Number),[l,u,d,f]=[c[0]||0,c[1]||0,c[2]||t,c[3]||t],p=r.ownerDocument.createElementNS(fe.SVG_NS,`g`);p.setAttribute(`data-export-pulsebar`,`1`);let m=Math.min(d,f),h=Math.max(m*.035,18),g=Math.max(m*.34,320),_=Math.max(m*.085,96),v=Math.max(_*.22,18),y=l+d-g-h,b=u+f-_-h,x=r.ownerDocument.createElementNS(fe.SVG_NS,`rect`);x.setAttribute(`x`,String(y)),x.setAttribute(`y`,String(b)),x.setAttribute(`rx`,String(v)),x.setAttribute(`ry`,String(v)),x.setAttribute(`width`,String(g)),x.setAttribute(`height`,String(_)),x.setAttribute(`fill`,`url(#${s})`),x.setAttribute(`stroke`,`rgba(255,255,255,0.16)`),x.setAttribute(`stroke-width`,String(Math.max(1.5,m*.0018))),x.setAttribute(`filter`,`url(#${a})`),p.appendChild(x);let S=r.ownerDocument.createElementNS(fe.SVG_NS,`text`);S.setAttribute(`x`,String(y+g/2)),S.setAttribute(`y`,String(b+_/2+Math.max(6,_*.06))),S.setAttribute(`text-anchor`,`middle`),S.setAttribute(`dominant-baseline`,`middle`),S.setAttribute(`fill`,e),S.setAttribute(`filter`,`url(#${o})`),S.setAttribute(`font-weight`,`900`),S.setAttribute(`font-family`,`Inter, ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica Neue, Arial`),S.setAttribute(`font-size`,String(Math.floor(_*.46))),S.textContent=i.toLocaleString(),p.appendChild(S),r.appendChild(p)}let i=new XMLSerializer().serializeToString(r),a=i.startsWith(`<?xml`)?i:`<?xml version="1.0" encoding="UTF-8"?>\n${i}`;return new Blob([a],{type:`image/svg+xml;charset=utf-8`})}async function TT(e,t=yT){let n=URL.createObjectURL(e);try{let e=new Image;await new Promise((t,r)=>{e.onload=()=>t(),e.onerror=r,e.src=n});let r=document.createElement(`canvas`);r.width=t,r.height=t;let i=r.getContext(`2d`);if(!i)throw Error(`Canvas unsupported`);return i.drawImage(e,0,0,t,t),await new Promise((e,t)=>r.toBlob(n=>n?e(n):t(Error(`PNG encode failed`)),`image/png`))}finally{URL.revokeObjectURL(n)}}const ET=`sigil-debits-v1`,DT=(e,t)=>t?`sigil:debits:${e}:t:${t}`:`sigil:debits:${e}`,OT=(e,t)=>e===DT(t)||e.startsWith(`${DT(t)}:t:`),kT=(e,t)=>{let n=`sigil:debits:${t}`;if(e===n)return null;let r=`${n}:t:`;return e.startsWith(r)?e.slice(r.length):void 0};function AT(e){let t=new TextEncoder().encode(e),n=``;for(let e=0;e<t.length;e++)n+=String.fromCharCode(t[e]);return btoa(n).replace(/\+/g,`-`).replace(/\//g,`_`).replace(/=+$/g,``)}function jT(e){let t=(4-e.length%4)%4,n=e.replace(/-/g,`+`).replace(/_/g,`/`)+`=`.repeat(t),r=atob(n),i=new Uint8Array(r.length);for(let e=0;e<r.length;e++)i[e]=r.charCodeAt(e);return new TextDecoder().decode(i)}function MT(e){try{let t={originalAmount:typeof e.originalAmount==`number`&&Number.isFinite(e.originalAmount)?e.originalAmount:null,debits:Array.isArray(e.debits)?e.debits:[]};return AT(JSON.stringify(t))}catch{return``}}function NT(e){if(typeof e!=`object`||!e)return!1;let t=e;return typeof t.nonce==`string`&&t.nonce.length>0&&typeof t.recipientPhiKey==`string`&&t.recipientPhiKey.length>0&&typeof t.amount==`number`&&Number.isFinite(t.amount)&&t.amount>0&&typeof t.timestamp==`number`&&Number.isFinite(t.timestamp)}function PT(e){if(!e)return null;try{let t=JSON.parse(jT(e));if(typeof t!=`object`||!t)return null;let n={},r=t;if(typeof r.originalAmount==`number`&&Number.isFinite(r.originalAmount)&&(n.originalAmount=r.originalAmount),Array.isArray(r.debits)){let e=[];for(let t of r.debits)NT(t)&&e.push(t);e.length&&(n.debits=e)}return n}catch{return null}}function FT(e,t){try{let n=new URL(window.location.href),r=typeof e.originalAmount==`number`&&Number.isFinite(e.originalAmount),i=Array.isArray(e.debits)&&e.debits.length>0;!r&&!i?n.searchParams.delete(`d`):n.searchParams.set(`d`,MT(e));let a=`${n.pathname}${n.search}${n.hash}`;t?.navigate?window.location.replace(a):window.history.replaceState(null,``,a)}catch{}}function IT(e,t){let n=(e||``).toLowerCase();if(!n)return null;try{let e=t?localStorage.getItem(DT(n,t)):null;if(e)return PT(e);let r=localStorage.getItem(DT(n));return r?PT(r):null}catch{return null}}function LT(e,t,n){let r=(e||``).toLowerCase();if(r)try{localStorage.setItem(DT(r,n),MT(t))}catch{}}function RT(e){let t=new Set,n=[];for(let r of e)!r||typeof r.nonce!=`string`||t.has(r.nonce)||(t.add(r.nonce),n.push(r));return n.sort((e,t)=>(e.timestamp||0)-(t.timestamp||0))}function zT(e,t){let n={},r=typeof e?.originalAmount==`number`?e.originalAmount:void 0,i=typeof t?.originalAmount==`number`?t.originalAmount:void 0;n.originalAmount=typeof r==`number`?r:typeof i==`number`?i:void 0;let a=Array.isArray(e?.debits)?e.debits:[],o=Array.isArray(t?.debits)?t.debits:[],s=RT([...a,...o]);return s.length&&(n.debits=s),n}function BT(e,t){let n=typeof e?.originalAmount==`number`&&Number.isFinite(e.originalAmount)?Number(e.originalAmount):NaN,r=typeof t?.originalAmount==`number`&&Number.isFinite(t.originalAmount)?Number(t.originalAmount):NaN,i=Number.isNaN(n)&&Number.isNaN(r)||Math.abs(n-r)<1e-12,a=new Set((Array.isArray(e?.debits)?e.debits:[]).map(e=>e?.nonce)),o=new Set((Array.isArray(t?.debits)?t.debits:[]).map(e=>e?.nonce));if(!i||a.size!==o.size)return!1;for(let e of a)if(!o.has(e))return!1;return!0}function VT(e,t,n,r){FT(e,{navigate:!!r?.navigate});let i=(t||``).toLowerCase();if(i&&(LT(i,e,n??null),r?.broadcast!==!1))try{let t=new BroadcastChannel(ET),r={type:`debits`,canonical:i,qs:MT(e),stamp:Date.now(),token:n??null};t.postMessage(r),t.close()}catch{}}function HT(e,t,n){let r=PT(t.get(`d`)),i=zT(n?IT(e,n):IT(e,null),r);return{merged:i,urlIsStale:!BT(i,r)}}function UT(e){try{let t=new URL(e,window.location.origin).pathname.match(/\/s\/([0-9a-fA-F]+)/);return t?t[1].toLowerCase():null}catch{return null}}function WT(e){if(typeof e==`string`)switch(e.trim().toLowerCase().replace(/\s+/g,` `)){case`root`:return`Root`;case`sacral`:return`Sacral`;case`solar plexus`:case`solarplexus`:return`Solar Plexus`;case`heart`:return`Heart`;case`throat`:return`Throat`;case`third eye`:case`thirdeye`:return`Third Eye`;case`crown`:return`Crown`;default:return}}function GT(e){return e===`breaths`||e===`steps`?e:void 0}var KT=e=>!!e&&typeof e==`object`,qT=e=>{if(!KT(e))return!1;let t=`u`in e&&`b`in e,n=`d`in e;return t||n},JT=e=>typeof e==`number`&&Number.isFinite(e)?e:void 0,YT=e=>typeof e==`string`&&e.trim()?e:void 0;function XT(e){if(!e)return{};try{let t=String(e).trim(),n=!1;/^c:/i.test(t)&&(t=t.slice(2),n=!0);let r=JSON.parse(jT(t));if(n||qT(r)){let e=r,t={},n=JT(e.u),i=JT(e.b),a=JT(e.d),o=JT(e.s),s=WT(e.c);return n!==void 0&&(t.pulse=n),i!==void 0&&(t.beat=i),a!==void 0&&(t.stepsPerBeat=a),o!==void 0&&(t.stepIndex=o),s!==void 0&&(t.chakraDay=s),t}if(KT(r)){let e=r,t={},n=JT(e.pulse),i=JT(e.beat),a=JT(e.stepsPerBeat),o=JT(e.stepIndex),s=WT(e.chakraDay),c=YT(e.canonicalHash),l=YT(e.kaiSignature),u=YT(e.userPhiKey),d=YT(e.transferNonce),f=JT(e.expiresAtPulse),p=GT(e.claimExtendUnit),m=JT(e.claimExtendAmount);return n!==void 0&&(t.pulse=n),i!==void 0&&(t.beat=i),a!==void 0&&(t.stepsPerBeat=a),o!==void 0&&(t.stepIndex=o),s!==void 0&&(t.chakraDay=s),c!==void 0&&(t.canonicalHash=c.toLowerCase()),l!==void 0&&(t.kaiSignature=l),u!==void 0&&(t.userPhiKey=u),d!==void 0&&(t.transferNonce=d),f!==void 0&&(t.expiresAtPulse=f),p!==void 0&&(t.claimExtendUnit=p),m!==void 0&&(t.claimExtendAmount=m),Array.isArray(e.lineage)&&(t.lineage=e.lineage),t}return{}}catch{return{}}}function ZT(e,t){let n={...e};typeof t.expiresAtPulse==`number`&&(n.expiresAtPulse=t.expiresAtPulse),t.claimExtendUnit!=null&&(n.claimExtendUnit=t.claimExtendUnit),typeof t.claimExtendAmount==`number`&&(n.claimExtendAmount=t.claimExtendAmount),typeof t.pulse==`number`&&(n.pulse=t.pulse),typeof t.beat==`number`&&(n.beat=t.beat),typeof t.stepsPerBeat==`number`&&(n.stepsPerBeat=t.stepsPerBeat),t.chakraDay!==void 0&&(n.chakraDay=t.chakraDay),t.canonicalHash&&(n.canonicalHash=String(t.canonicalHash).toLowerCase()),t.kaiSignature&&(n.kaiSignature=t.kaiSignature),t.userPhiKey&&(n.userPhiKey=t.userPhiKey),t.transferNonce&&(n.transferNonce=t.transferNonce),Array.isArray(t.lineage)&&(n.lineage=t.lineage);let r=typeof n.stepsPerBeat==`number`&&Number.isFinite(n.stepsPerBeat)?n.stepsPerBeat:44,i=JT(t?.stepIndex),a=JT(n.stepIndex);return i===void 0?a===void 0?typeof n.pulse==`number`&&Number.isFinite(n.pulse)&&(n.stepIndex=L(n.pulse,r)):n.stepIndex=a:n.stepIndex=i,n}function QT(e,t){try{let n=new URL(e,window.location.origin),r=ZT(XT(n.searchParams.get(`p`)),t);return r.canonicalHash&&=String(r.canonicalHash).toLowerCase(),n.searchParams.set(`p`,AT(JSON.stringify(r))),n.toString()}catch{return e}}function $T(e,t,n){let r=[e?.canonicalHash,t,n?.matchedHash];for(let e of r)if(typeof e==`string`&&e.trim())return e.toLowerCase();return null}function eE(e,t){return typeof e==`string`&&e.trim()?e:typeof t?.transferNonce==`string`&&t.transferNonce.trim()?t.transferNonce:null}async function tE(e){let{stageEl:t,payload:n,localHash:r,routeHash:a,qr:o,onToast:s}=e;if(!t)return s(`No stage found`);try{let e=(await i(async()=>{let{default:e}=await import(`./html2canvas-BBwqEG7X.js`).then(l(1));return{default:e}},__vite__mapDeps([4,5,2,3]))).default,u=await e(t,{backgroundColor:null}),d=document.createElement(`canvas`);d.width=bT,d.height=bT;let f=d.getContext(`2d`);if(!f)throw Error(`No canvas context`);f.clearRect(0,0,d.width,d.height);let p=Math.floor(bT*.06),m=bT-p*2,h=bT-p*2,g=u.width,_=u.height,v=Math.min(m/g,h/_),y=Math.floor(g*v),b=Math.floor(_*v),x=Math.floor((bT-y)/2),S=Math.floor((bT-b)/2);f.drawImage(u,x,S,y,b);let C=n?.chakraDay??`Throat`,w=jC[C]?.accent||`#00FFD0`,T=YC(C,typeof n?.stepPct==`number`?n.stepPct:n?n.pulse%11/11:0,r||void 0),E=Math.max(bT*.33,720),D=Math.max(bT*.08,160),O=Math.max(D*.24,30),k=bT-E-p,A=bT-D-p;f.save(),f.shadowColor=w,f.shadowBlur=Math.max(18,Math.floor(bT*.012));let j=f.createLinearGradient(0,A,0,A+D);j.addColorStop(0,`rgba(255,255,255,0.16)`),j.addColorStop(1,`rgba(255,255,255,0.05)`),c(f,k,A,E,D,O),f.fillStyle=j,f.fill(),f.shadowBlur=0,f.lineWidth=Math.max(2,Math.floor(bT*.0016)),f.strokeStyle=`rgba(255,255,255,0.18)`,f.stroke();let M=(n?.pulse??0).toLocaleString();f.textBaseline=`alphabetic`,f.fillStyle=T,f.font=`900 ${Math.floor(D*.48)}px Inter, ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica Neue, Arial`,f.shadowColor=T,f.shadowBlur=Math.max(16,Math.floor(bT*.008));let N=f.measureText(M).width,P=Math.floor(k+E/2-N/2),F=Math.floor(A+D/2+D*.18);f.fillText(M,P,F),f.restore();let I=Math.floor(bT*.32),L=Math.floor((bT-I)/2),ee=Math.floor((bT-I)/2),R=nE({provided:o.url,payload:n,localHash:r,routeHash:a}),z=(0,_w.renderToStaticMarkup)((0,J.jsx)(`svg`,{xmlns:`http://www.w3.org/2000/svg`,viewBox:`0 0 1000 1000`,children:(0,J.jsx)(Ww,{uid:o.uid,url:R,size:800,phaseHue:o.hue,phaseColor:o.accent,animate:!1,pulseMs:5236})})),te=new Blob([z],{type:`image/svg+xml;charset=utf-8`}),ne=URL.createObjectURL(te);await new Promise((e,t)=>{let n=new Image;n.onload=()=>{try{f.drawImage(n,L,ee,I,I)}finally{URL.revokeObjectURL(ne),e()}},n.onerror=e=>{URL.revokeObjectURL(ne),t(e)},n.src=ne});let re=d.toDataURL(`image/png`),B=document.createElement(`a`);B.href=re,B.download=`sigil_poster_${(r||a||`mint`).slice(0,16)}.png`,document.body.appendChild(B),B.click(),B.remove(),s(`Public key PNG saved`)}catch(e){console.error(e),s(`Poster export failed`)}function c(e,t,n,r,i,a){e.beginPath(),e.moveTo(t+a,n),e.lineTo(t+r-a,n),e.quadraticCurveTo(t+r,n,t+r,n+a),e.lineTo(t+r,n+i-a),e.quadraticCurveTo(t+r,n+i,t+r-a,n+i),e.lineTo(t+a,n+i),e.quadraticCurveTo(t,n+i,t,n+i-a),e.lineTo(t,n+a),e.quadraticCurveTo(t,n,t+a,n),e.closePath()}}function nE(e){let{provided:t,payload:n,localHash:r,routeHash:i}=e,a=t&&rE(t)?t:(typeof window<`u`?window.location.href:``)||``;if(!n)return a;try{let e=(n.canonicalHash||r||i||``).toLowerCase();if(!e)return a;let t=new URL(a,typeof window<`u`?window.location.origin:`https://local.test`);t.pathname=`/s/${e}`;let o=n.transferNonce||t.searchParams.get(`t`);o&&t.searchParams.set(`t`,o);let s=`${t.pathname}${t.search}${t.hash}`;return QT(s,n)||s}catch{return a}}function rE(e){try{let t=new URL(e,typeof window<`u`?window.location.origin:`https://local.test`);return t.protocol===`http:`||t.protocol===`https:`}catch{return!1}}function iE(e){let t=JSON.stringify(e);return btoa(unescape(encodeURIComponent(t))).replace(/\+/g,`-`).replace(/\//g,`_`).replace(/=+$/g,``)}function aE(e,t,n){let r=new URL(e,typeof window<`u`?window.location.origin:`http://localhost`);return r.searchParams.set(`p`,iE(t)),n&&r.searchParams.set(`t`,n),r.toString()}function oE(e){switch(String(e??``).trim().toLowerCase()){case`root`:return`Root`;case`sacral`:return`Sacral`;case`solar plexus`:case`solar_plexus`:case`solar-plexus`:return`Solar Plexus`;case`heart`:return`Heart`;case`throat`:return`Throat`;case`third eye`:case`third_eye`:case`third-eye`:return`Third Eye`;case`crown`:return`Crown`;default:return`Root`}}function sE(e,t){let n={pulse:e.pulse,beat:e.beat,chakraDay:oE(e.chakraDay),stepsPerBeat:e.stepsPerBeat??void 0,stepIndex:t,userPhiKey:e.userPhiKey??void 0,kaiSignature:e.kaiSignature??void 0,canonicalHash:e.canonicalHash??void 0,transferNonce:e.transferNonce??void 0,expiresAtPulse:e.expiresAtPulse??void 0,claimExtendUnit:e.claimExtendUnit??void 0,claimExtendAmount:e.claimExtendAmount??void 0,attachment:e.attachment??void 0,provenance:e.provenance??void 0};return Object.keys(n).forEach(e=>{n[e]===void 0&&delete n[e]}),n}function cE(e){return{pulse:e.pulse,beat:e.beat,stepIndex:e.stepIndex,chakraDay:oE(e.chakraDay),stepsPerBeat:e.stepsPerBeat??void 0,userPhiKey:e.userPhiKey??void 0,kaiSignature:e.kaiSignature??void 0}}function lE(e,t){e.setAttribute(`data-share-url`,t),e.querySelectorAll(`a`).forEach(e=>{e.setAttribute(`href`,t);try{e.setAttributeNS(`http://www.w3.org/1999/xlink`,`xlink:href`,t)}catch{}});let n=/\bu=([^·\n\r]+?)(?=\s*·|$)/;e.querySelectorAll(`text`).forEach(e=>{let r=e.textContent||``;n.test(r)&&(e.textContent=r.replace(n,`u=${t}`))})}async function uE(e){let{expired:t,exporting:n,setExporting:r,svgEl:a,payload:o,isFutureSealed:s,linkStatus:c,setToast:l,expiryUnit:u,expiryAmount:d,localHash:f,routeHash:p,transferToken:m,getKaiPulseEternalInt:h,stepIndexFromPulse:g,STEPS_PER_BEAT:_}=e;if(t)return HC(l,`Seal window closed`);if(!n){if(!a)return HC(l,`No SVG found`);if(!o)return HC(l,`No payload`);if(s)return HC(l,`Opens after the moment—claim unlocks then`);if(c!==`active`)return HC(l,`Archived link — cannot claim from here`);try{r(!0);let e=`sigil_${(f||p||`mint`).slice(0,16)}`,t=o.stepsPerBeat??_,n=g(o.pulse,t),s=h(new Date),c=g(s,t),v=sE(o,n),y={...wC(o.userPhiKey||``,o.kaiSignature??void 0,v,`claim`,o.attachment?.name??void 0,s),stepIndex:n,atStepIndex:c},x={...o,exportedAtPulse:s,stepIndex:n,stepsPerBeat:t,provenance:[...o.provenance??[],y],claimExtendUnit:o.claimExtendUnit??u,claimExtendAmount:o.claimExtendAmount??d,canonicalHash:(f||o.canonicalHash||p||null)?.toString()??null},S=await tw(aw(x.pulse,x.beat,n,String(x.chakraDay??``),ow(sE(x,n)))),C=await iw(S),w={...x,kaiSignature:S,userPhiKey:x.userPhiKey||C},T=(f||p||``).toLowerCase(),E=cE({pulse:w.pulse,beat:w.beat,stepIndex:n,chakraDay:w.chakraDay??null,stepsPerBeat:t,userPhiKey:w.userPhiKey??null,kaiSignature:w.kaiSignature??null}),D=aE(b(T,E),E,w.transferNonce??m??void 0),{putMetadata:O}=await i(async()=>{let{putMetadata:e}=await import(`./svgMeta-DH_5v_0c.js`);return{putMetadata:e}},__vite__mapDeps([6,7,2,3])),k={...w,stepsPerBeat:t,shareUrl:D,fullUrl:D};O(a,k);try{a.setAttribute(`data-step-index`,String(n));let e=a.querySelector(`metadata#sigil-display`);e||(e=document.createElementNS(`http://www.w3.org/2000/svg`,`metadata`),e.setAttribute(`id`,`sigil-display`),e.setAttribute(`data-noncanonical`,`1`),a.appendChild(e)),e.textContent=JSON.stringify({stepIndex:n,stepsPerBeat:t})}catch{console.debug(`Display metadata write failed`)}fw(a,w.pulse,w.beat,n),lw(a),lE(a,D);let A=null,j=null;try{let e=new URL(D);A=e.searchParams.get(`p`),j=e.searchParams.get(`t`)}catch{console.debug(`URL parse failed`)}let M=await wT(a,yT,{metaOverride:k,addQR:!1,addPulseBar:!1,title:`Kairos Sigil-Glyph — Sealed KairosMoment`,desc:`Deterministic sigil-glyph with sovereign metadata. Exported as archived key.`}),N=await TT(M,yT),P=new(await(UC()));P.file(`${e}.svg`,M),P.file(`${e}.png`,N);let F={hash:f||p||``,canonicalHash:w.canonicalHash??null,pulse:w.pulse,beat:w.beat,stepIndex:n,atStepIndex:c,chakraDay:w.chakraDay??null,userPhiKey:w.userPhiKey??null,kaiSignature:w.kaiSignature??null,transferNonce:w.transferNonce??null,expiresAtPulse:w.expiresAtPulse??null,exportedAtPulse:w.exportedAtPulse??null,claimedAtPulse:s,overlays:{qr:!1,eternalPulseBar:!1},claimExtendUnit:w.claimExtendUnit??null,claimExtendAmount:w.claimExtendAmount??null,fullUrl:D,p:A,urlQuery:{p:A,t:j}};P.file(`${e}.manifest.json`,JSON.stringify(F,null,2));let I=await P.generateAsync({type:`blob`}),L=URL.createObjectURL(I),ee=document.createElement(`a`);ee.href=L,ee.download=`${e}.zip`,document.body.appendChild(ee),ee.click(),ee.remove(),requestAnimationFrame(()=>URL.revokeObjectURL(L)),HC(l,`Access key generated`)}catch(e){console.error(e),HC(l,`Claim failed`)}finally{r(!1)}}}function dE(){return(0,q.useMemo)(()=>async e=>{let t=new TextEncoder().encode(e),n=await crypto.subtle.digest(`SHA-256`,t);return Array.from(new Uint8Array(n)).map(e=>e.toString(16).padStart(2,`0`)).join(``)},[])}function fE({payload:e,urlSearchParams:t,currentPulse:n}){let[r,i]=(0,q.useState)(null),[a,o]=(0,q.useState)(null),[s,c]=(0,q.useState)(null),l=(0,q.useRef)(null),u=(0,q.useRef)(null),d=dE(),f=t?.get(`vpol`)??``;(0,q.useEffect)(()=>{let t=!0;return(async()=>{if(!e||!Number.isFinite(n??NaN)){if(!t)return;i(e=>e===null?e:null),o(e=>e===null?e:null),c(e=>e===null?e:null),l.current=null,u.current=null;return}let{seal:r}=await k({pulse:e.pulse,kaiPulse:e.pulse,beat:e.beat,stepIndex:e.stepIndex,stepsPerBeat:e.stepsPerBeat,seriesSize:e.seriesSize,quality:e.quality,creatorVerified:e.creatorVerified,creatorRep:e.creatorRep,frequencyHz:e.frequencyHz,chakraDay:e.chakraDay,chakraGate:e.chakraGate,transfers:e.transfers,cumulativeTransfers:e.cumulativeTransfers,segments:e.segments,segmentsMerkleRoot:e.segmentsMerkleRoot,transfersWindowRoot:e.transfersWindowRoot,ip:e.ip,kaiSignature:e.kaiSignature,userPhiKey:e.userPhiKey,valuationPolicyId:f||void 0},n,d);if(!t)return;u.current!==r.stamp&&(i(e=>e&&e.stamp===r.stamp?e:r),u.current=r.stamp);let a=r.valuePhi,s=l.current;s!==a&&(o(e=>e===a?e:a),s!=null&&Math.abs(a-s)>1e-9?c(e=>e===`up`&&a>s?e:a>s?`up`:`down`):c(e=>e===null?e:null),l.current=a)})(),()=>{t=!1}},[e,n,f,d]);let p=(0,q.useMemo)(()=>e?.pulse,[e]),m=(0,q.useMemo)(()=>Number.isFinite(p??NaN)?{score:P(p),lines:C(p)}:{score:null,lines:[]},[p]),h=(0,q.useMemo)(()=>{if(!Number.isFinite(p??NaN)||!Number.isFinite(n??NaN))return null;let t=r?.inputs?.pulsesPerBeat?Math.max(1,Math.round(r.inputs.pulsesPerBeat/11)):e?.stepsPerBeat??44,i=r?.inputs?.cadenceRegularity??1,a=r?.inputs?.resonancePhi??.5,o=e?.stepIndex;return N(p,n,{stepsPerBeat:t,cadenceRegularity:i,resonancePhi:a,stepIndexClaimOverride:o})},[p,n,r,e]),g=(0,q.useMemo)(()=>{let t=e?.transfers;return!t||!t.length?[`No closed transfers yet — lineage still forming.`]:A(t,{stepsPerBeat:e?.stepsPerBeat??44})},[e]);return{valSeal:r,livePrice:a,priceFlash:s,rarity:m,oscillation:h,lineageNarrative:g,trust:(0,q.useMemo)(()=>r?S(r.inputs):null,[r]),marketTier:(0,q.useMemo)(()=>Number.isFinite(p??NaN)?M(p,r??void 0):null,[p,r]),kairos:(0,q.useMemo)(()=>Number.isFinite(n??NaN)?{window:O(n,144,1,{stepsPerBeat:e?.stepsPerBeat??44})}:{window:[]},[n,e]),visuals:(0,q.useMemo)(()=>{if(!r||!Number.isFinite(p??NaN))return{spiralSVG:null,scrollSVG:null,scrollText:null,scrollHTML:null};let e=w(p),{scrollSVG:t,scrollText:n}=E(r,{title:`Kai-Sigil Valuation Scroll`});return{spiralSVG:e,scrollSVG:t,scrollText:n,scrollHTML:T(r,{title:`Kai-Sigil Valuation Scroll`})}},[r,p]),audio:(0,q.useMemo)(()=>{if(!Number.isFinite(p??NaN))return{dataURI:null,renderWav:void 0};let{dataURI:e}=j(p,2,44100,{stereo:!0});return{dataURI:e,renderWav:(e=2,t=44100,n)=>j(p,e,t,n)}},[p]),motifSimilarityWith:(0,q.useMemo)(()=>e=>!Number.isFinite(e??NaN)||!Number.isFinite(p??NaN)?null:D(p,e),[p]),helpers:(0,q.useMemo)(()=>({explainRarity:()=>m.lines,explainLineage:()=>g,scanKairos:(t,n,r=1,i)=>O(t,n,r,{stepsPerBeat:i??e?.stepsPerBeat??44}),makeScroll:e=>r?E(r,{title:e??`Kai-Sigil Valuation Scroll`}):null,makeScrollHTML:e=>r?T(r,{title:e}):null,makeSpiral:e=>Number.isFinite(e??p)?w(e??p):null}),[m.lines,g,e,r,p])}}function pE(e){let{stageId:t,payload:n,localHash:r,setOgImgUrl:i,setMeta:a,seoTitle:o,seoDesc:s}=e,c=!1,l=null,u=async()=>{let e=document.getElementById(t);if(!e||!n){i(null),a(`property`,`og:image`,``),a(`property`,`og:image:alt`,``),a(`property`,`og:image:width`,``),a(`property`,`og:image:height`,``),a(`name`,`twitter:image`,``);return}try{let t=n.chakraDay??`Throat`,l=jC[t]?.accent||`#00FFD0`,u=n.pulse||0,f=n.stepsPerBeat??44,p=Math.floor(n.pulse%(f*11)/11),m=YC(t,typeof n.stepPct==`number`?n.stepPct:n.pulse%11/11,r||void 0),h=`Pulse ${u.toLocaleString()} • Beat ${n.beat}/36 • Step ${p+1}/${f} • ${t}`,g=await(0,me.default)(e),_=document.createElement(`canvas`);_.width=xT,_.height=630;let v=_.getContext(`2d`);if(!v)throw Error(`Canvas unsupported`);let y=v.createLinearGradient(0,0,xT,630);y.addColorStop(0,`rgba(0,0,0,0.92)`),y.addColorStop(1,`rgba(0,0,0,0.70)`),v.fillStyle=y,v.fillRect(0,0,xT,630),v.save(),v.globalCompositeOperation=`lighter`;let b=v.createRadialGradient(xT*.8,630*.2,20,xT*.8,630*.2,600);b.addColorStop(0,`${l}CC`),b.addColorStop(1,`rgba(0,0,0,0)`),v.fillStyle=b,v.beginPath(),v.arc(xT*.8,630*.2,600,0,Math.PI*2),v.fill(),v.restore();let x=Math.floor(xT*.52),S=Math.min(x/g.width,558/g.height),C=Math.floor(g.width*S),w=Math.floor(g.height*S),T=36+Math.floor((x-C)/2),E=36+Math.floor((558-w)/2);v.drawImage(g,T,E,C,w);let D=36+x+32,O=xT-D-36;v.fillStyle=`#EAFBFF`,v.font=`700 38px Inter, ui-sans-serif, -apple-system, Segoe UI, Roboto`,v.fillText(`Kairos Sigil-Glyph — Sealed Kairos Moment`,D,94),v.fillStyle=`rgba(255,255,255,0.82)`,v.font=`400 24px Inter, ui-sans-serif, -apple-system, Segoe UI, Roboto`,d(v,`“${o}” — ${s}`,D,136,O,30);let k=`${u.toLocaleString()}`;v.textBaseline=`alphabetic`,v.font=`900 120px Inter, ui-sans-serif, -apple-system, Segoe UI, Roboto`,v.shadowColor=m,v.shadowBlur=20,v.fillStyle=m;let A=v.measureText(k).width,j=D+Math.floor((O-A)/2);v.fillText(k,j,554),v.shadowBlur=0;let M=_.toDataURL(`image/png`);if(c)return;i(M),a(`property`,`og:image`,M),a(`property`,`og:image:alt`,h),a(`property`,`og:image:type`,`image/png`),a(`property`,`og:image:width`,`1200`),a(`property`,`og:image:height`,`630`),a(`name`,`twitter:image`,M)}catch{if(c)return;i(null)}};return l=WC(()=>{c||u()}),()=>{c=!0,l!=null&&GC(l)};function d(e,t,n,r,i,a){let o=t.split(` `),s=``;for(let t=0;t<o.length;t++){let c=s+o[t]+` `;e.measureText(c).width>i&&t>0?(e.fillText(s,n,r),s=o[t]+` `,r+=a):s=c}e.fillText(s.trim(),n,r)}}function mE(e){switch(String(e??``).trim().toLowerCase()){case`root`:case`earth`:case`earth gate`:return`Root`;case`sacral`:return`Sacral`;case`solar plexus`:case`solar_plexus`:case`solar-plexus`:return`Solar Plexus`;case`heart`:return`Heart`;case`throat`:return`Throat`;case`third eye`:case`third_eye`:case`third-eye`:return`Third Eye`;case`crown`:return`Crown`;default:return`Root`}}function hE(){return crypto.getRandomValues(new Uint32Array(4)).join(``)}function gE(e){let{meta:t,stepIndex:n,stepsPerBeat:r}=e;return{pulse:t.pulse,beat:t.beat,stepIndex:n,chakraDay:mE(t.chakraDay),stepsPerBeat:r,userPhiKey:t.userPhiKey??void 0,kaiSignature:t.kaiSignature??void 0}}function _E(e,t,n){let r=e.stepIndex;return typeof r==`number`&&Number.isFinite(r)&&r>=0&&r<t&&Math.floor(r)===r?r:n.stepIndexFromPulse(e.pulse,t)}function vE(e,t,n){let r=(e.canonicalHash??n.localHash??n.routeHash??``).toLowerCase();if(!r)return null;let i=t??hE(),a=e.stepsPerBeat??n.stepsPerBeat,o=_E(e,a,n),s=gE({meta:e,stepIndex:o,stepsPerBeat:a});return{url:QT(aE(b(r,s),s,i),{pulse:e.pulse,beat:e.beat,stepsPerBeat:a,stepIndex:o,chakraDay:mE(e.chakraDay),canonicalHash:r,kaiSignature:e.kaiSignature??void 0,userPhiKey:e.userPhiKey??void 0,transferNonce:i,expiresAtPulse:e.expiresAtPulse??void 0,claimExtendUnit:e.claimExtendUnit??void 0,claimExtendAmount:e.claimExtendAmount??void 0}),token:i}}function yE(e,t,n){let r=n.getKaiPulseEternalInt(new Date)+n.breathsToPulses(11),i=hE(),a={...e,canonicalHash:t,transferNonce:i,expiresAtPulse:r,claimExtendUnit:`breaths`,claimExtendAmount:11},o=n.shareTransferLink(a,i,{localHash:n.localHash,routeHash:n.routeHash,stepsPerBeat:n.stepsPerBeat,stepIndexFromPulse:n.stepIndexFromPulse});if(!o?.url)return null;t&&i&&n.publishRotation([t],i);try{n.navigate(o.url)}catch{try{window.location.href=o.url}catch{}}return o.url}var bE=[`canonicalHash`,`token`,`expiresAtPulse`,`issuedAt`,`version`],xE=e=>JSON.stringify({canonicalHash:e.canonicalHash,token:e.token,expiresAtPulse:e.expiresAtPulse,issuedAt:e.issuedAt,version:e.version},bE),SE=e=>btoa(String.fromCharCode(...e)).replace(/\+/g,`-`).replace(/\//g,`_`).replace(/=+$/g,``);const CE=e=>SE(new TextEncoder().encode(xE(e)));async function wE(e){try{let t=await fetch(`/api/sign-claim`,{method:`POST`,headers:{"content-type":`text/plain;charset=UTF-8`},body:xE(e)});if(!t.ok)return null;let n=await t.json();return!n||!n.s||!n.kid?null:{r:n.r??CE(e),s:n.s,kid:n.kid}}catch{return null}}function TE(e,t,n,r){e.searchParams.set(`r`,t),e.searchParams.set(`s`,n),e.searchParams.set(`kid`,r)}function EE(e,t,n,r){K(e,{registryClaim:CE(t),registrySig:n,registryKid:r})}function DE(e,t,n){return{canonicalHash:t.toLowerCase(),token:n,expiresAtPulse:e.expiresAtPulse??null,issuedAt:Math.floor(Date.now()/1e3),version:1}}function OE(){if(typeof window>`u`||typeof document>`u`){let e=()=>{},t=()=>{};return{openModal:t,closeModal:t,disable:e,teardown:e,destroy:e}}let e=document,t=e.body,n=[`.sp-breathproof__backdrop`,`.stargate-overlay`,`.valuechart-backdrop`,`.sp-modal`,`.ownership-overlay`],r={".sp-breathproof__backdrop":`.sp-breathproof`,".valuechart-backdrop":`.valuechart`,".ownership-overlay":`.ownership-panel`,".stargate-overlay":`.stargate-content, .stargate-frame, .stargate__content`,".sp-modal":`.sp-modal__content, .sp-modal__card, .sp-card`},i={capture:!0,passive:!1},a={capture:!0},o=0,s=0,c=0,l=``,u=``,d=``,f=``,p=``,m=()=>{o===0&&(s=window.scrollY||e.documentElement.scrollTop||0,c=window.scrollX||e.documentElement.scrollLeft||0,l=t.style.top,u=t.style.left,d=t.style.width,f=t.style.position,p=t.style.overflow,t.style.position=`fixed`,t.style.top=`-${s}px`,t.style.left=`-${c}px`,t.style.width=`100%`,t.style.overflow=`hidden`,t.classList.add(`modal-open`,`bp-open`)),o++},h=()=>{o=Math.max(0,o-1),!(o>0)&&(t.style.position=f,t.style.top=l,t.style.left=u,t.style.width=d,t.style.overflow=p,requestAnimationFrame(()=>{window.scrollTo(c,s)}),t.classList.remove(`modal-open`),t.classList.remove(`bp-open`))},g=e=>{if(!e)return!1;let t=window.getComputedStyle(e);return!(t.display===`none`||t.visibility===`hidden`||e.hasAttribute(`hidden`))},_=()=>{let t=[];return n.forEach(n=>{e.querySelectorAll(n).forEach(e=>{g(e)&&t.push(e)})}),t},v=t=>{if(!t)return null;let r=t;for(;r&&r!==e.documentElement;){for(let e of n)if(r.matches(e))return r;r=r.parentElement}return null},y=(e,t)=>{if(!e||!t)return!1;let i=n.find(t=>e.matches(t))||``,a=i?r[i]:``;return a&&e.querySelector(a)?!t.closest(a):t===e},b=()=>{_().length>0?m():h()},x=e=>{e&&(e.classList.add(`is-open`),e.removeAttribute(`hidden`),b())},S=e=>{e&&(e.classList.remove(`is-open`),e.setAttribute(`hidden`,``),b())},C=e=>{let t=e.target;if(!t)return;let n=t.closest(`.sp-breathproof__close, .stargate-exit, .sp-modal__close, .sealmoment__close, [data-modal-close], [data-dismiss="modal"], button[aria-label="Close"], button[aria-label="close"]`);if(n){let t=v(n);t&&(S(t),e.preventDefault(),e.stopPropagation());return}let r=v(t);if(r&&y(r,t)&&r.getAttribute(`data-backdrop-dismiss`)!==`false`){S(r),e.preventDefault(),e.stopPropagation();return}},w=e=>{if(_().length===0)return;let t=e.target;if(!t)return;let n=t.closest(`[data-scroll], .sp-breathproof, .valuechart, .ownership-panel, .sp-modal__content, .sp-card, .stargate-content`);if(!n){e.preventDefault(),e.stopPropagation();return}if(!(n.scrollHeight>n.clientHeight)){e.preventDefault(),e.stopPropagation();return}},T=e=>{if(e.key!==`Escape`)return;let t=_();if(t.length===0)return;let n=t[t.length-1];n.getAttribute(`data-escape-dismiss`)!==`false`&&(S(n),e.preventDefault(),e.stopPropagation())};e.addEventListener(`click`,C,i),e.addEventListener(`pointerup`,C,i),e.addEventListener(`touchend`,C,i),e.addEventListener(`touchmove`,w,i),e.addEventListener(`keydown`,T,i),b();let E=()=>{e.removeEventListener(`click`,C,a),e.removeEventListener(`pointerup`,C,a),e.removeEventListener(`touchend`,C,a),e.removeEventListener(`touchmove`,w,a),e.removeEventListener(`keydown`,T,a);try{o=1,h()}catch{}};return{openModal:x,closeModal:S,disable:E,teardown:E,destroy:E}}var kE=n(g(),1),AE=1e-9,jE=`sigil-sendlock-v1`,ME=(e,t)=>`sigil:sendlock:${e}:t:${t}`,NE=15e3,PE=()=>Date.now(),FE={"--phi-url":`url(/assets/phi.svg)`},IE=e=>{try{return new URL(e,window.location.origin).toString()}catch{return e}},LE=(e,t)=>{let n=crypto.getRandomValues(new Uint32Array(4)).join(``);if(!e||!t)return{ok:!1,id:n};let r=ME(e.toLowerCase(),t);try{let i=localStorage.getItem(r),a=i?JSON.parse(i):null,o=!a||!Number.isFinite(a.at)||PE()-a.at>NE;if(!a||o){localStorage.setItem(r,JSON.stringify({id:n,at:PE()}));try{let r=new BroadcastChannel(jE),i={type:`lock`,canonical:e.toLowerCase(),token:t,id:n,at:PE()};r.postMessage(i),r.close()}catch{}return{ok:!0,id:n}}}catch{}return{ok:!1,id:n}},RE=(e,t,n)=>{if(!e||!t)return;let r=ME(e.toLowerCase(),t);try{let i=localStorage.getItem(r),a=i?JSON.parse(i):null;if(!a||a.id===n){localStorage.removeItem(r);try{let r=new BroadcastChannel(jE),i={type:`unlock`,canonical:e.toLowerCase(),token:t,id:n,at:PE()};r.postMessage(i),r.close()}catch{}}}catch{}},zE=e=>{if(!e||typeof e!=`object`)return!1;let t=e;return typeof t.amount==`number`&&Number.isFinite(t.amount)&&t.amount>0&&typeof t.nonce==`string`&&t.nonce.length>0&&typeof t.timestamp==`number`&&Number.isFinite(t.timestamp)&&(typeof t.recipientPhiKey==`string`||t.recipientPhiKey===void 0)},BE=e=>{if(!Array.isArray(e))return 0;let t=0;for(let n of e)zE(n)&&(t+=n.amount);return t},VE=e=>[...e].sort((e,t)=>{let n=(e.timestamp||0)-(t.timestamp||0);return n===0?e.nonce.localeCompare(t.nonce):n}),HE=e=>{let t=new Set,n=[];for(let r of e)zE(r)&&(t.has(r.nonce)||(t.add(r.nonce),n.push(r)));return n},UE=e=>{let t=typeof e.originalAmount==`number`&&Number.isFinite(e.originalAmount)?e.originalAmount:NaN,n=VE(Array.isArray(e.debits)?HE(e.debits):[]);if(!Number.isFinite(t))return{originalAmount:e.originalAmount,debits:n.length?n:void 0};let r=[],i=0;for(let e of n)zE(e)&&i+e.amount<=t+AE&&(r.push(e),i+=e.amount);return{originalAmount:t,debits:r.length?r:void 0}},WE=e=>e===`breaths`||e===`steps`,GE=`sigil-lineage-v1`,KE=(e,t)=>t?`sigil:desc:${e}:t:${t}`:`sigil:desc:${e}`,qE=`sigil-xfer-v1`,JE=e=>`sigil:rotated:${e}`,YE=(e,t)=>{Array.from(new Set(e.map(e=>e.toLowerCase()).filter(Boolean))).forEach(e=>{try{localStorage.setItem(JE(e),`${t}@${Date.now()}`)}catch{}try{let n=new BroadcastChannel(qE);n.postMessage({type:`rotated`,canonical:e,token:t}),n.close()}catch{}try{window.dispatchEvent(new CustomEvent(`sigil:transfer-rotated`,{detail:{canonical:e,token:t}}))}catch{}})};function XE(e,t){let n=(e||``).toLowerCase();if(!n||!t)return[];try{let e=localStorage.getItem(KE(n,t));if(!e)return[];let r=JSON.parse(e);return Array.isArray(r)?r:[]}catch{return[]}}function ZE(e,t,n){let r=(e||``).toLowerCase();if(!(!r||!t))try{localStorage.setItem(KE(r,t),JSON.stringify(n||[]))}catch{}}function QE(e,t,n){try{let r=new BroadcastChannel(GE),i={type:`descendants`,canonical:e.toLowerCase(),token:t,list:n,stamp:Date.now()};r.postMessage(i),r.close()}catch{}}function $E(){let{hash:e}=m(),t=h(),n=o(),r=(e??``).toLowerCase(),i=(0,q.useMemo)(()=>new URLSearchParams(t.search),[t.search]),a=i.get(`t`),[s,c]=(0,q.useState)(`checking`),[l,u]=(0,q.useState)(`checking`),[d,f]=(0,q.useState)(!1),[p,g]=(0,q.useState)(`Awaiting Proof Of Breath™`),[v,y]=(0,q.useState)(``),[b,S]=(0,q.useState)(320),C=(0,q.useRef)(null),{payload:w,setPayload:T,loading:E,setLoading:D}=BC(t.search),O=w,{pulse:k,msToNextPulse:A}=NC(),[j,M]=(0,q.useState)(null),[N,P]=(0,q.useState)(null),[z,te]=(0,q.useState)(!1),[ne,re]=(0,q.useState)(``),[B,ie]=(0,q.useState)(``),[ce,le]=(0,q.useState)(`breaths`),[ue,U]=(0,q.useState)(44),[W,de]=(0,q.useState)(``),[fe,me]=(0,q.useState)(!1),ve=(0,q.useRef)(``),ye=(0,q.useMemo)(()=>r?`sigil:legacy-upgraded:${r}`:``,[r]),[be,xe]=(0,q.useState)(!1),[Se,Ce]=(0,q.useState)(!1);(0,q.useEffect)(()=>{if(ye)try{Ce(localStorage.getItem(ye)===`1`)}catch{}},[ye]);let we=(0,q.useCallback)(()=>{if(ye){try{localStorage.setItem(ye,`1`)}catch{}Ce(!0),HC(y,`Upgraded — legacy link locked`)}},[ye]),[Te,Ee]=(0,q.useState)(!1),[De,Oe]=(0,q.useState)(``),[ke,Ae]=(0,q.useState)(``),[je,Me]=(0,q.useState)(`checking`),[Ne,Pe]=(0,q.useState)(null);(0,q.useEffect)(()=>{let e=Array.from(new Set([O?.canonicalHash,r,W].filter(Boolean).map(e=>e.toLowerCase())));if(e.length===0)return;let t=()=>{let t=null;try{for(let n of e){let e=localStorage.getItem(JE(n)),r=e?String(e).split(`@`)[0]:null;if(r){t=r;break}}}catch{}Pe(t)};t();let n=null;try{n=new BroadcastChannel(qE),n.onmessage=t=>{let n=t.data;if(n?.type===`rotated`){let t=(n.canonical||``).toLowerCase();e.includes(t)&&Pe(n.token||null)}}}catch{}let i=n=>{if(n.key){for(let r of e)if(n.key===JE(r)){t();break}}};return window.addEventListener(`storage`,i,{passive:!0}),()=>{if(window.removeEventListener(`storage`,i),n&&typeof n.close==`function`)try{n.close()}catch{}}},[O?.canonicalHash,r,W]);let Fe=(0,q.useCallback)(async(e,t,n,r,i)=>{try{let a=DE(e,t,n),o=await wE(a);if(!o)return r;let s=new URL(r,window.location.origin);return TE(s,o.r,o.s,o.kid),i&&EE(i,a,o.s,o.kid),s.toString()}catch{return r}},[]);(0,q.useEffect)(()=>{let e=null;try{e=new BroadcastChannel(jE),e.onmessage=()=>{}}catch{}return()=>{if(e&&typeof e.close==`function`)try{e.close()}catch{}}},[]),(0,q.useEffect)(()=>{let e=OE();return()=>{e.destroy?.(),e.teardown?.(),e.disable?.()}},[]);let[Ie,ze]=(0,q.useState)(0),[Be,Ve]=(0,q.useState)(!1),[He,Ue]=(0,q.useState)(null),We=(0,q.useMemo)(()=>{let e=[O?.canonicalHash,W,j?.canonicalHash,He?.matchedHash].filter(Boolean).map(e=>e.toLowerCase());return Array.from(new Set(e))},[O?.canonicalHash,W,j?.canonicalHash,He]);(0,q.useLayoutEffect)(()=>{pw()},[]),(0,q.useEffect)(()=>{let e=jC[O?.chakraDay??`Throat`]??{hue:180,accent:`#00FFD0`},t=document.querySelector(`.sigilpage`);t&&(t.style.setProperty(`--crystal-hue`,String(e.hue)),t.style.setProperty(`--crystal-accent`,e.accent))},[O?.chakraDay]);let[Ge,Ke]=(0,q.useState)(null),{valSeal:qe,livePrice:Je,priceFlash:Ye}=fE({payload:O,urlSearchParams:i,currentPulse:k,routeHash:r}),Xe=i.get(`h`)??``;(0,q.useEffect)(()=>{if(!Xe){Ke(e=>e===null?e:null);return}try{let e=_(ZC(Xe.trim()));Ke(t=>Array.isArray(t)&&Array.isArray(e)&&t.length===e.length&&t.every((t,n)=>t===e[n])?t:e)}catch{Ke(e=>e===null?e:null)}},[Xe]);let Ze=(0,q.useCallback)((e,t)=>{let n=e.stepsPerBeat??44,r=t.stepsPerBeat??44,i=L(e.pulse,n),a=L(t.pulse,r);return e.pulse===t.pulse&&e.beat===t.beat&&i===a&&e.chakraDay===t.chakraDay},[]),Qe=(0,q.useMemo)(()=>typeof window<`u`?new URL(window.location.href).toString():`${`/s/${encodeURIComponent(e??``)}`}${t.search||``}${t.hash||``}`,[e,t.search,t.hash]),$e=(0,q.useMemo)(()=>e?e.slice(0,16):`—`,[e]),et=(0,q.useCallback)(async(e,t=`Copied`)=>{try{return await navigator.clipboard.writeText(e),HC(y,t),!0}catch{return HC(y,`Copy failed`),!1}},[]),tt=(0,q.useCallback)(async()=>{try{let e=navigator;typeof e?.share==`function`?(await e.share({title:`Kairos Sigil-glyph`,text:`Sealed Kairos Moment`,url:Qe}),HC(y,`Share sheet opened`)):await et(Qe,`Link copied`)}catch{}},[Qe,et]);(0,q.useEffect)(()=>{let e=Date.now(),t=(r||``).toLowerCase();if(Ie>e||!t||We.length===0)return;let n=We.includes(t),i=l,a=s;!n&&W&&t!==W&&!He||!n&&(He||je===`archived`)?i=`authentic`:(i=n?`authentic`:`forged`,s!==`verified`&&(a=n?`ok`:`mismatch`)),i!==l&&u(i),a!==s&&c(a)},[We,r,je,Ie,He,W,l,s]);let[nt,rt]=(0,q.useState)(null),it=(0,q.useDeferredValue)(O),at=(0,q.useMemo)(()=>{let t=it?.stepsPerBeat??44,n=it?L(it.pulse,t):0,r=it?.chakraDay??`Throat`,i=(it?.userPhiKey??``).slice(0,12),a=(it?.pulse??0).toLocaleString();return{title:`Kai Sigil — ${e?e.slice(0,16):`—`}`,desc:it?`Sealed Sigil-Glyph • Pulse ${a} • Beat ${it.beat}/36 • Step ${n+1}/${t} • ${r}${i?` • Owner ${i}…`:``}.`:`Sealed Sigil-Glyph`}},[it,e]);(0,q.useEffect)(()=>{let e=Qe;document.title=at.title;let t=kC(`canonical`);t.href=e,DC(`name`,`theme-color`,jC[O?.chakraDay??`Throat`]?.accent||`#00FFD0`),DC(`property`,`og:title`,at.title),DC(`property`,`og:description`,at.desc),DC(`property`,`og:type`,`website`),DC(`property`,`og:url`,e),DC(`name`,`twitter:card`,`summary_large_image`),DC(`name`,`twitter:title`,at.title),DC(`name`,`twitter:description`,at.desc),DC(`property`,`og:site_name`,`Kairos Harmonik Kingdom`);let n=O?.stepsPerBeat??44,r=O?L(O.pulse,n):0,i=O,a=O??{},o={"@context":`https://schema.org`,"@type":`VisualArtwork`,name:at.title,description:at.desc,url:e,image:nt||void 0,genre:`Sigil-Glyph`,identifier:[{"@type":`PropertyValue`,name:`pulse`,value:O?.pulse??null},{"@type":`PropertyValue`,name:`beat`,value:O?.beat??null},{"@type":`PropertyValue`,name:`stepIndex`,value:r},{"@type":`PropertyValue`,name:`stepsPerBeat`,value:n},{"@type":`PropertyValue`,name:`chakraDay`,value:O?.chakraDay??null},{"@type":`PropertyValue`,name:`userPhiKey`,value:O?.userPhiKey??null},{"@type":`PropertyValue`,name:`kaiSignature`,value:O?.kaiSignature??null},{"@type":`PropertyValue`,name:`canonicalHash`,value:(O?.canonicalHash??W)||null},{"@type":`PropertyValue`,name:`expiresAtPulse`,value:O?.expiresAtPulse??null},{"@type":`PropertyValue`,name:`transferNonce`,value:new URLSearchParams(location.search).get(`t`)??O?.transferNonce??null},{"@type":`PropertyValue`,name:`claimExtendUnit`,value:WE(a.claimExtendUnit)?a.claimExtendUnit:null},{"@type":`PropertyValue`,name:`claimExtendAmount`,value:a.claimExtendAmount??null},{"@type":`PropertyValue`,name:`historyLiteCount`,value:Ge?.length??0}].filter(e=>e.value!=null)};i?.lineage?.length&&o.identifier.push({"@type":`PropertyValue`,name:`lineageDepth`,value:i.lineage.length}),AC(`sigil-jsonld`,o)},[Qe,at.title,at.desc,O,nt,W,Ge?.length]),(0,q.useEffect)(()=>pE({stageId:`sigil-stage`,payload:O?{...O}:null,localHash:W,setOgImgUrl:rt,setMeta:DC,seoTitle:at.title,seoDesc:at.desc}),[O,W,b,at.title,at.desc]),(0,q.useLayoutEffect)(()=>(document.documentElement.classList.add(`sigil-scroll`),()=>document.documentElement.classList.remove(`sigil-scroll`)),[]),(0,q.useEffect)(()=>{let e=0,t=()=>{cancelAnimationFrame(e),e=requestAnimationFrame(()=>{let e=window.innerWidth,t=window.innerHeight,n=e<640?Math.max(220,Math.min(360,t*.48)):Math.max(160,Math.min(320,t*.35)),r=Math.max(160,Math.min(640,Math.min(e,t-n))),i=C.current?.clientWidth??e,a=Math.max(160,Math.min(640,i-24));S(Math.round(Math.min(r,a)))})},n=C.current??document.body,r=new ResizeObserver(()=>t());return r.observe(n),window.addEventListener(`resize`,t,{passive:!0}),t(),()=>{r.disconnect(),window.removeEventListener(`resize`,t),cancelAnimationFrame(e)}},[]),(0,q.useEffect)(()=>{E?(c(e=>e===`verified`?`verified`:`checking`),u(e=>e===`authentic`?`authentic`:`checking`),f(!1),g(`Awaiting Verifikation`)):O||(c(e=>e===`verified`?`verified`:r?`notfound`:`checking`),u(e=>e===`authentic`?`authentic`:r?`forged`:`checking`))},[E,O,r]);let ot=e=>Array.isArray(e)?[...e].map(e=>({nonce:e.nonce,amount:Number.isFinite(e.amount)?Number(e.amount):0,recipient:e.recipientPhiKey??``,ts:e.timestamp??``})).sort((e,t)=>e.nonce.localeCompare(t.nonce)).map(e=>`${e.nonce}:${e.amount}:${e.recipient}:${e.ts}`).join(`|`):``;(0,q.useEffect)(()=>{let e=PT(i.get(`d`));if(!e)return;let t=$T(O??null,W,He),n=eE(a,O??null),r=UE(e);t&&LT(t,r,n);let o=typeof r.originalAmount==`number`?r.originalAmount:void 0,s=Array.isArray(r.debits)?r.debits:void 0;T(e=>{if(!e)return e;let t=e,n=(t.originalAmount??void 0)===o,r=ot(t.debits)===ot(s);if(n&&r)return e;let i={...e};return o!==void 0&&(i.originalAmount=o),s&&(i.debits=s,i.totalDebited=BE(s)),i})},[i,O,W,He,a,T]);let[st,ct]=(0,q.useState)(!1);(0,q.useEffect)(()=>{let e=$T(O??null,W,He);if(!e)return;let t=eE(a,O??null),{merged:n,urlIsStale:r}=HT(e,i,t),o=UE(n);r&&ct(!0),VT(o,e,t,{broadcast:!1,navigate:r});let s=typeof o.originalAmount==`number`?o.originalAmount:void 0,c=Array.isArray(o.debits)?o.debits:void 0;T(e=>{if(!e)return e;let t=e,n=(t.originalAmount??void 0)===s,r=ot(t.debits)===ot(c);if(n&&r)return e;let i={...e};return s!==void 0&&(i.originalAmount=s),c&&(i.debits=c,i.totalDebited=BE(c)),i})},[O?.canonicalHash,W,He,i,a,T]),(0,q.useEffect)(()=>{if(!O?.canonicalHash)return;let e=O.canonicalHash.toLowerCase();if(r&&e&&e!==r&&je===`active`&&!He){let t=new URL(window.location.href);t.pathname=`/s/${e}`,n(`${t.pathname}${t.search}${t.hash}`,{replace:!0})}},[O?.canonicalHash,r,je,He,n]),(0,q.useEffect)(()=>{if(O&&!O.canonicalHash&&W&&r&&W!==r&&je===`active`&&!He){let e=new URL(window.location.href);e.pathname=`/s/${W}`,n(`${e.pathname}${e.search}${e.hash}`,{replace:!0})}},[O?.canonicalHash,W,r,je,He,n]),(0,q.useEffect)(()=>{let e=We;if(!e.length)return;let t=eE(a,O??null),n=(e,t)=>{let n={};typeof e?.originalAmount==`number`&&(n.originalAmount=e.originalAmount),n.originalAmount===void 0&&typeof t?.originalAmount==`number`&&(n.originalAmount=t.originalAmount);let r=Array.isArray(e?.debits)?e.debits:[],i=Array.isArray(t?.debits)?t.debits:[],a=HE([...r,...i]);return UE({originalAmount:n.originalAmount,debits:a})},r=(e,t)=>{let n=UE(e??{}),r=UE(t??{}),i=typeof n.originalAmount==`number`?n.originalAmount:NaN,a=typeof r.originalAmount==`number`?r.originalAmount:NaN,o=Number.isNaN(i)&&Number.isNaN(a)||Math.abs(i-a)<AE,s=new Set((Array.isArray(n.debits)?n.debits:[]).map(e=>e.nonce)),c=new Set((Array.isArray(r.debits)?r.debits:[]).map(e=>e.nonce));if(!o||s.size!==c.size)return!1;for(let e of s)if(!c.has(e))return!1;return!0},i=(i,a,o)=>{let s=i.toLowerCase();if(!e.includes(s))return;let c=t??null;if(c!==(o??null))return;let l=PT(a);if(!l)return;let u=PT(new URLSearchParams(window.location.search).get(`d`)),d=n(u,l);r(u,d)||(VT(d,s,c,{broadcast:!1}),T(e=>{if(!e)return e;let t={...e};return typeof d.originalAmount==`number`&&(t.originalAmount=d.originalAmount),Array.isArray(d.debits)&&(t.debits=d.debits,t.totalDebited=BE(d.debits)),t}))},o=null;try{o=new BroadcastChannel(ET),o.onmessage=e=>{let t=e.data;t?.type===`debits`&&t.canonical&&t.qs&&i(t.canonical,t.qs,t.token)}}catch{}let s=t=>{if(!(!t.key||typeof t.newValue!=`string`))for(let n of e){if(!OT(t.key,n))continue;let e=kT(t.key,n);i(n,t.newValue,e);break}};return window.addEventListener(`storage`,s,{passive:!0}),()=>{if(window.removeEventListener(`storage`,s),o&&typeof o.close==`function`)try{o.close()}catch{}}},[We,a,O,T]);let lt=(0,q.useMemo)(()=>O?typeof O.expiresAtPulse==`number`?O.expiresAtPulse:O.pulse+11:null,[O]),dt=(0,q.useMemo)(()=>k==null||lt==null?null:Math.max(0,lt-k),[k,lt]),ft=(0,q.useMemo)(()=>dt===0,[dt]),pt=(0,q.useMemo)(()=>k==null||!O?null:Math.max(0,O.pulse-k),[O,k]),mt=(0,q.useMemo)(()=>k==null||!O?!1:O.pulse>k,[O,k]),ht=O?.chakraDay??`Throat`,gt=O?.stepsPerBeat??44,_t=L(O?.pulse??0,gt),vt=typeof O?.stepPct==`number`?Math.max(0,Math.min(1,O.stepPct)):I(O?.pulse??0),yt=(0,q.useMemo)(()=>`hsl(${((jC[ht]?.hue??180)+(W&&/^[0-9a-f]+$/i.test(W)?parseInt(W.slice(-2),16)%12:0)*2.5)%360} 100% ${50+15*Math.sin(vt*2*Math.PI)}%)`,[ht,vt,W]),bt=jC[ht]?.hue??180,xt=(0,q.useMemo)(()=>`qr-${(W||r||`seed`).slice(0,12)}-${ht}-${_t}`,[W,r,ht,_t]),[St,Ct]=(0,q.useState)(!1),[Tt,Et]=(0,q.useState)(null);(0,q.useEffect)(()=>{let e=!1;return(async()=>{try{if(!O){Et(null);return}let t=O.stepsPerBeat??44,n=L(O.pulse,t),r=ow(O),i=aw(O.pulse,O.beat,n,String(O.chakraDay??``),r),a=await tw(i),o=await iw(a),s=typeof O.kaiSignature==`string`?O.kaiSignature.toLowerCase()===a.toLowerCase():!0,c=typeof O.userPhiKey==`string`?O.userPhiKey.toLowerCase()===o.toLowerCase():!0,l={pulse:O.pulse,beat:O.beat,stepsPerBeat:t,stepIndex:n,chakraDay:String(O.chakraDay??``),intention:r??null,sigmaString:i,sigmaHash:a,derivedPhiKey:o,payloadKaiSignature:O.kaiSignature??null,payloadUserPhiKey:O.userPhiKey??null,matches:{sigma:s,phi:c}};e||Et(l)}catch{e||Et(null)}})(),()=>{e=!0}},[O]);let Dt=V(()=>{tE({stageEl:document.getElementById(`sigil-stage`),payload:O,localHash:W,routeHash:r,qr:{uid:xt,url:Qe,hue:bt,accent:yt},onToast:e=>HC(y,e)})}),[Ot,kt]=(0,q.useState)(!1),[At,jt]=(0,q.useState)(``),Mt=(0,q.useCallback)(async()=>{let e=C.current;e&&(jt((await(0,kE.default)(e,{backgroundColor:null})).toDataURL(`image/png`)),kt(!0),MC()||document.querySelector(`.stargate-overlay`)?.requestFullscreen?.().catch(()=>{}))},[]),Nt=(0,q.useCallback)(()=>{kt(!1),document.fullscreenElement&&!MC()&&document.exitFullscreen?.().catch(()=>{})},[]),Pt=V(()=>{Mt()}),Ft=V(()=>{Nt()}),It=V(()=>Ct(e=>!e)),Lt=V(()=>Ve(!0)),Rt=(0,q.useCallback)(async e=>{let t=await e.arrayBuffer(),n=e.type||`application/octet-stream`,r=`data:${n};base64,${VC(t)}`;P({name:e.name,mime:n,size:e.size,dataUri:r}),HC(y,`Remembered ${e.name}`)},[]),zt=(0,q.useCallback)((e,t)=>{let n=e.stepsPerBeat??44,i=L(e.pulse,n),a=(e.canonicalHash||W||``).toLowerCase(),o=e.claimExtendUnit,s=WE(o)?o:null,c=e.claimExtendAmount,l=typeof c==`number`?c:null,u=vE({pulse:e.pulse,beat:e.beat,chakraDay:e.chakraDay??`Root`,stepsPerBeat:n,stepIndex:i,userPhiKey:e.userPhiKey??null,kaiSignature:e.kaiSignature??null,canonicalHash:a,transferNonce:e.transferNonce??null,expiresAtPulse:e.expiresAtPulse??null,claimExtendUnit:s,claimExtendAmount:l},t,{localHash:W,routeHash:r,stepsPerBeat:44,stepIndexFromPulse:L})?.url||`/s/${a}`;try{let e=new URL(u,window.location.origin);e.pathname=`/s/${a}`;let t=new URLSearchParams(window.location.search).get(`d`);t&&e.searchParams.set(`d`,t),u=e.toString()}catch{}let d=new URL(u,window.location.origin);d.pathname=`/s/${a}`,new URL(window.location.href).searchParams.forEach((e,t)=>{t!==`d`&&d.searchParams.set(t,d.searchParams.get(t)??e)});let f=UT(u)||a;return Oe(u),Ae(f),Ee(!0),u},[W,r]),Bt=(0,q.useCallback)((e,t,i=!0)=>{let a=e.stepsPerBeat??44,o=L(e.pulse,a),s=e.claimExtendUnit,c=WE(s)?s:`breaths`,l=e.claimExtendAmount,u=typeof l==`number`?l:11;return yE({pulse:e.pulse,beat:e.beat,chakraDay:e.chakraDay??`Root`,stepsPerBeat:a,stepIndex:o,userPhiKey:e.userPhiKey??null,kaiSignature:e.kaiSignature??null,canonicalHash:t,transferNonce:e.transferNonce??null,expiresAtPulse:e.expiresAtPulse??null,claimExtendUnit:c,claimExtendAmount:u},t,{localHash:W,routeHash:r,stepsPerBeat:44,stepIndexFromPulse:L,getKaiPulseEternalInt:R,breathsToPulses:H,shareTransferLink:vE,publishRotation:YE,navigate:e=>{if(i)try{n(e)}catch{try{window.location.href=e}catch{}}}})??null},[W,r,n]),Vt=(0,q.useCallback)(async e=>{if(f(!1),g(`Verifying…`),!(/image\/svg\+xml/i.test(e.type)||/\.svg$/i.test(e.name))){g(`Unsupported file. Upload an SVG sigil (.svg) only.`);return}let t=null;try{let{ok:n,errors:r,payload:i,meta:a}=pe(await e.text());if(!n||!i){g(r[0]||`Invalid SVG.`);return}t=i,M(a||{})}catch{g(`Invalid or unreadable SVG uploaded.`);return}if(!O||!t){g(`Load or link a sigil first, then verify stewardship.`);return}if(!Ze(O,t)){g(`File does not match this sealed kairos moment.`),f(!1);return}if(t.canonicalHash){let e=t.canonicalHash.toLowerCase(),n=(W||``).toLowerCase(),i=(r||``).toLowerCase(),a=n&&e===n,o=i&&e===i;if(!a&&!o){g(`SVG canonicalHash doesn’t match this link’s hash.`),f(!1);return}if(o&&!a){Ue({reason:`svg.canonicalHash matched route (legacy)`,matchedHash:e}),u(`authentic`),c(`ok`),Me(`archived`),f(!0),g(`Stewardship verified (legacy SVG). Issuing modern link…`),n&&(Bt({...O},n,!0),g(`Legacy verified. Modern transfer link ready.`));return}}if(new Set([a??void 0,O.transferNonce??void 0,t.transferNonce??void 0,Ne??void 0].filter(e=>!!e)).size>1){g(`This is not the active transfer link for that Φkey.`),f(!1);return}f(!0),g(`Stewardship verified`)},[O,Ze,W,r,a,Ne,Bt]),Ht=V(async()=>{if(z)return;let e=C.current?.querySelector(`svg`),t=O??{},n=WE(t.claimExtendUnit)?t.claimExtendUnit:void 0,i=typeof t.claimExtendAmount==`number`?t.claimExtendAmount:null;await uE({expired:!!ft,exporting:z,setExporting:te,svgEl:e,payload:O?{pulse:O.pulse,beat:O.beat,chakraDay:O.chakraDay??null,stepsPerBeat:O.stepsPerBeat??void 0,stepIndex:O.stepIndex??null,exportedAtPulse:O.exportedAtPulse??null,canonicalHash:O.canonicalHash??null,userPhiKey:O.userPhiKey??null,kaiSignature:O.kaiSignature??null,transferNonce:O.transferNonce??null,expiresAtPulse:O.expiresAtPulse??null,claimExtendUnit:n,claimExtendAmount:i,attachment:O.attachment??null,provenance:O.provenance??null}:null,isFutureSealed:mt,linkStatus:je,setToast:e=>HC(y,e),expiryUnit:ce,expiryAmount:ue,localHash:W,routeHash:r,transferToken:a??null,getKaiPulseEternalInt:R,stepIndexFromPulse:L,STEPS_PER_BEAT:44})}),Ut=(0,q.useCallback)(e=>{let t=typeof e==`string`?e:e?.hash;if(!t)return;let n=t.toLowerCase();de(e=>e===n?e:n)},[]),Wt=E&&!O,Gt=s===`notfound`||s===`error`,Kt=O?.pulse??0,qt=O?.beat??0,Jt=((A??0)/1e3).toFixed(3),Yt=je===`archived`,Xt=d&&!Yt,Zt=(0,q.useMemo)(()=>l===`authentic`&&Yt&&!a&&!!r&&!!W&&r!==W,[l,Yt,a,r,W]);(0,q.useEffect)(()=>{if(!O||l!==`authentic`||s===`mismatch`||s===`error`||s===`notfound`)return;let e=!1;return(async()=>{try{let t=O.stepsPerBeat??44,n=L(O.pulse,t),r=ow(O),i=await tw(aw(O.pulse,O.beat,n,String(O.chakraDay??``),r)),a=typeof O.kaiSignature==`string`?O.kaiSignature.toLowerCase()===i.toLowerCase():!0,o=await iw(i),l=typeof O.userPhiKey==`string`?O.userPhiKey.toLowerCase()===o.toLowerCase():!0;!e&&a&&l&&s!==`verified`&&c(`verified`)}catch{}})(),()=>{e=!0}},[O,l,s,je]),(0,q.useEffect)(()=>{let e=(r||``).toLowerCase(),t=a||null,n=O?.transferNonce||null,i=!!t&&!!n&&t===n&&(lt==null||k==null||k<lt),o=je;if(i)o=`active`;else if(!(W||O?.canonicalHash||He?.matchedHash))o=`checking`;else{let r=We;o=e&&r.length&&r.includes(e)||e&&W&&e!==W&&!He?`active`:n?t?Ne&&Ne!==t?`archived`:t===n?`active`:`archived`:`archived`:He?`archived`:`active`}o!==je&&Me(o)},[r,We,W,O?.transferNonce,a,Ne,lt,k,He,je]);let[Qt,$t]=(0,q.useState)(``),[en,tn]=(0,q.useState)(``);(0,q.useEffect)(()=>{let e=!0;return(async()=>{if(!O){$t(``),tn(``);return}let t=(O.canonicalHash||W||``).toLowerCase(),n=R(new Date),r=await mw(O,t,n,ee(n),L(n,O.stepsPerBeat??44));e&&($t(r.ownerPhiKey),tn(r.kaiSig))})(),()=>{e=!1}},[O,W]);let nn=(0,q.useCallback)(async e=>{if(e?.preventDefault?.(),e?.stopPropagation?.(),!O||!W||mt||Yt)return;let t=(O.canonicalHash||W||``).toLowerCase(),n=R(new Date),r=await mw(O,t,n,ee(n),L(n,O.stepsPerBeat??44));re(r.ownerPhiKey),ie(r.kaiSig),setTimeout(()=>{try{on()}catch{}},0)},[O,W,mt,Yt]),rn=(0,q.useCallback)(e=>{let t=`/${e}`;try{window.location.assign(t)}catch{window.location.href=t}},[]),an=(0,q.useCallback)(async()=>{try{let e=await(await fetch(`/verifier.inline.html`,{cache:`no-store`})).text(),t=new Blob([e],{type:`text/html`}),n=document.createElement(`a`);n.href=URL.createObjectURL(t),n.download=`verifier.html`,document.body.appendChild(n),n.click(),setTimeout(()=>{URL.revokeObjectURL(n.href),n.remove()},0),HC(y,`Downloading verifier…`)}catch{HC(y,`Download failed`)}},[]);({...It});let on=(0,q.useCallback)(()=>{if(!O)return HC(y,`Nothing to mint`);let e=C.current?.querySelector(`svg`);if(!e)return HC(y,`No Φkey in frame`);if(!W)return HC(y,`Glyph hash not ready yet`);if(je!==`active`)return HC(y,`Archived link — cannot exhale from here`);if(mt)return HC(y,`Opens after the moment—claim unlocks then`);let t=CC(j??{},O.pulse),n=(ne||O.userPhiKey||``).trim();if(!n)return HC(y,`Owner ΦKey required`);let i=Math.max(0,Math.floor(ue||0)),a=ce===`breaths`?H(i):G(i),o=R(new Date),s=o+a,c=W.toLowerCase(),l=crypto.getRandomValues(new Uint32Array(4)).join(``),u=O.stepsPerBeat??44,d=L(O.pulse,u),f=L(o,u),p={...wC(n,B||O.kaiSignature,O,t.length?`transfer`:`mint`,(N??O.attachment)?.name,o),stepIndex:d,atStepIndex:f},m={...O,userPhiKey:n,kaiSignature:B||O.kaiSignature,stepsPerBeat:O.stepsPerBeat??44,attachment:N??O.attachment??void 0,expiresAtPulse:s,canonicalHash:c,transferNonce:l,claimExtendUnit:ce,claimExtendAmount:i,provenance:[...t,p]};(async()=>{let t=await tw(aw(m.pulse,m.beat,d,String(m.chakraDay??``),ow(m))),n=await iw(t);m.kaiSignature=t,m.userPhiKey=m.userPhiKey||n;let i=Array.from(new Set([O.canonicalHash,r,W].filter(Boolean).map(e=>e.toLowerCase())));i.length&&YE(i,l),Me(`archived`),ze(Date.now()+250),K(e,m),lw(e),T(m),M(m),HC(y,`Sealed & archived`);let a=zt(m,l)||`/s/${c}`;a=await Fe(m,c,l,a,e),Oe(IE(a)),m.canonicalHash&&YE([m.canonicalHash.toLowerCase()],l),setTimeout(()=>ze(0),0)})()},[O,j,ne,B,N,ue,ce,W,r,je,mt,zt]),sn=O,cn=(0,q.useMemo)(()=>BE(sn?.debits??[]),[sn?.debits]),ln=(0,q.useMemo)(()=>{let e=(typeof sn?.originalAmount==`number`?sn.originalAmount:qe?.valuePhi??0)-cn;return e>0?e:0},[sn?.originalAmount,qe?.valuePhi,cn]),un=(sn?.debits?.length??0)>0||typeof sn?.originalAmount==`number`,dn=(0,q.useMemo)(()=>un?ln:Je??qe?.valuePhi??0,[un,ln,Je,qe?.valuePhi]),fn=oe,{usdPerPhi:pn,phiPerUsd:mn}=(0,q.useMemo)(()=>{try{let e=k??R(new Date),t=ae({meta:O||{},nowPulse:e,usd:100,currentStreakDays:0,lifetimeUsdSoFar:0},fn);return{usdPerPhi:t.usdPerPhi??0,phiPerUsd:t.phiPerUsd??0}}catch{return{usdPerPhi:0,phiPerUsd:0}}},[O,k,fn]),hn=(dn??0)*(pn||0),gn=(0,q.useCallback)(async()=>{if(!O)return``;let e=O.stepsPerBeat??44,t=L(O.pulse,e);return await iw(O.kaiSignature??await tw(aw(O.pulse,O.beat,t,String(O.chakraDay??``),ow(O))))},[O]),[_n,vn]=(0,q.useState)([]),yn=(0,q.useCallback)(()=>{vn(XE($T(O??null,W,He),eE(a,O??null)))},[O,W,He,a]);(0,q.useEffect)(()=>{yn();let e=null;try{e=new BroadcastChannel(GE),e.onmessage=e=>{let t=e.data;if(!t||t.type!==`descendants`)return;let n=$T(O??null,W,He),r=eE(a,O??null);!n||!r||t.canonical!==n.toLowerCase()||t.token!==r||Array.isArray(t.list)&&vn(t.list)}}catch{}let t=e=>{if(!e.key||!e.newValue)return;let t=$T(O??null,W,He),n=eE(a,O??null);if(!(!t||!n)&&e.key===KE(t,n))try{let t=JSON.parse(e.newValue||`[]`);Array.isArray(t)&&vn(t)}catch{}};return window.addEventListener(`storage`,t,{passive:!0}),()=>{if(e&&typeof e.close==`function`)try{e.close()}catch{}window.removeEventListener(`storage`,t)}},[O,W,He,a,yn]);let bn=(0,q.useCallback)(async(e,t)=>{if(!O)return null;let n=R(new Date),r=crypto.getRandomValues(new Uint32Array(4)).join(``),i=O.stepsPerBeat??44,o=L(O.pulse,i),s=(W||O.canonicalHash||``).toLowerCase(),c=t??eE(a,O??null),l=Array.isArray(O.lineage)?[...O.lineage]:[],u=(l[l.length-1]?.depth??0)+1,d={token:r,parentToken:c??null,amount:Number(e.toFixed(6)),timestamp:n,depth:u,senderPhiKey:O.userPhiKey??null},f={...O,userPhiKey:void 0,originalAmount:Number(e.toFixed(6)),mintedAtPulse:n,transferNonce:r,expiresAtPulse:n+(ce===`breaths`?H(ue):G(ue)),claimExtendUnit:ce,claimExtendAmount:ue,canonicalHash:s,lineage:[...l,d]},p=await tw(aw(f.pulse,f.beat,o,String(f.chakraDay??``),ow(f))),m=await iw(p);f.kaiSignature=p,f.userPhiKey=m;let h=zt(f,r)||`/s/${s}`;try{let t=new URL(h,window.location.origin);t.pathname=`/s/${s}`,t.searchParams.set(`d`,MT({originalAmount:f.originalAmount}));let i=QT(t.toString(),f);i=await Fe(f,s,r,i);let a=UT(i)||s;LT(a,PT(new URL(i).searchParams.get(`d`))??{},r);let o=$T(O??null,W,He),l=c??null;if(o&&l){let t=[...XE(o,l),{token:r,parentToken:l,amount:Number(e.toFixed(6)),timestamp:n,depth:1,recipientPhiKey:f.userPhiKey}];ZE(o,l,t),QE(o,l,t),vn(t)}return Oe(IE(i)),Ae(a),Ee(!0),i}catch{let e=QT(h||`/s/${s}`,f);return Oe(e),Ae(s),Ee(!0),e||null}},[O,ce,ue,W,zt,He,a]);(0,q.useEffect)(()=>{let e=e=>{if(!(e instanceof HTMLElement))return!1;let t=e.tagName.toLowerCase();return t===`input`||t===`textarea`||e.isContentEditable},t=t=>{if(t.defaultPrevented||e(t.target))return;let n=t.key.toLowerCase();t.metaKey||t.ctrlKey||t.altKey||(n===`s`?tt():n===`l`?et(Qe,`Link copied`):n===`h`?W&&et(W,`Hash copied`):n===`z`?Ht.onClick?.(new MouseEvent(`click`)):n===`p`?Dt.onClick?.(new MouseEvent(`click`)):n===`g`&&Mt())};return window.addEventListener(`keydown`,t),()=>window.removeEventListener(`keydown`,t)},[tt,et,Qe,W,Ht,Dt,Mt]);let xn=(0,q.useCallback)(e=>{let t=e?.silent??!0;if(!$T(O??null,W,He))return null;let r=eE(a,O??null);if(r)return r;r=crypto.getRandomValues(new Uint32Array(4)).join(``);try{let e=new URL(window.location.href);e.searchParams.set(`t`,r),t?window.history.replaceState(null,``,`${e.pathname}${e.search}${e.hash}`):n(`${e.pathname}${e.search}${e.hash}`,{replace:!0})}catch{}return T(e=>e&&{...e,transferNonce:r}),Me(`active`),r},[O,W,He,a,T,n,Me]),[Sn,Cn]=(0,q.useState)(0),wn=(0,q.useCallback)(async()=>{if(!Xt)return HC(y,`Verify Stewardship first`);if(!O)return HC(y,`No payload`);if(fe)return;let e=Number(Sn)||0;if(e<=0)return HC(y,`Enter an amount > 0`);let t=$T(O??null,W,He),n=eE(a,O??null);if(n||=xn({silent:!0})||null,!t||!n)return HC(y,`Link not initialized`);if(Ne&&Ne!==n)return HC(y,`Archived link — cannot exhale from here`);me(!0);let{ok:r,id:i}=LE(t,n);if(ve.current=i,!r)return me(!1),HC(y,`Another exhale is in progress`);try{let{merged:r}=HT(t,new URLSearchParams(window.location.search),n),i=UE({originalAmount:typeof r.originalAmount==`number`?r.originalAmount:typeof O?.originalAmount==`number`?O.originalAmount:qe?.valuePhi??0,debits:Array.isArray(r.debits)?r.debits:[]});if(e>Math.max(0,(i.originalAmount??0)-BE(i.debits||[]))+AE)return HC(y,`Amount exceeds available`);let a=await gn();if(!a)return HC(y,`Could not derive Φkey`);let o={amount:Number(e.toFixed(6)),nonce:crypto.getRandomValues(new Uint32Array(4)).join(``),recipientPhiKey:a,timestamp:R(new Date)};VT(UE({originalAmount:i.originalAmount,debits:[...i.debits??[],o]}),t,n,{broadcast:!0});let{merged:s}=HT(t,new URLSearchParams(window.location.search),n),c=UE(s);if(!(c.debits??[]).some(e=>e.nonce===o.nonce)){HC(y,`Exhale conflicted — try again`);return}T(e=>{if(!e)return e;let t={...e};return t.originalAmount=typeof c.originalAmount==`number`?c.originalAmount:typeof t.originalAmount==`number`?t.originalAmount:qe?.valuePhi??0,t.debits=Array.isArray(c.debits)?c.debits:[],t.totalDebited=BE(t.debits),t}),Cn(0),HC(y,`Sent ${XC(o.amount)} Φ`),bn(o.amount,n)}finally{RE(t,n,ve.current),me(!1)}},[Xt,O,O?.originalAmount,qe?.valuePhi,Sn,Ne,W,He,a,T,gn,bn,Cn,fe,xn]),Tn=St||Be||Ot||Te||be&&Zt;(0,q.useEffect)(()=>{let e=`bp-open`;return Tn?document.body.classList.add(e):document.body.classList.remove(e),()=>document.body.classList.remove(e)},[Tn]);let[En,Dn]=(0,q.useState)(!1),On=(0,q.useCallback)(()=>{Dn(!0),window.setTimeout(()=>Dn(!1),2e3)},[]),kn=V(()=>{et(W||``,`Hash copied`)}),An=V(async()=>{await et(Qe,`Link copied`)&&On()}),jn=V(()=>{tt()}),Mn=(0,J.jsxs)(_e,{frameRef:C,children:[!Wt&&!Gt&&O&&(0,J.jsx)(`div`,{id:`sigil-stage`,style:{position:`relative`,width:b,height:b,margin:`0 auto`},children:(0,J.jsx)(x,{pulse:Kt,beat:qt,stepPct:vt,chakraDay:ht,size:b,hashMode:`deterministic`,origin:``,onReady:Ut})}),Wt&&(0,J.jsx)(`div`,{className:`sp-skeleton`,"aria-hidden":`true`}),Gt&&(0,J.jsx)(`div`,{className:`sp-error`,children:s===`notfound`?`Waiting for SVG upload or ?p= payload.`:`Unable to load sigil.`})]}),Nn=O?.lineage??[],Pn=(0,q.useCallback)((e,t)=>{let n=e=>typeof e==`object`&&!!e,r=e=>{if(typeof t==`string`)return t;if(!n(e))return``;let r=typeof e.reason==`string`?e.reason:``,i=n(e.detail)?e.detail:null,a=i&&typeof i.reason==`string`?i.reason:``;return r||a||``},i=e=>{if(!n(e))return null;let t=e.target;return t instanceof HTMLElement?t:null},a=r(e),o=i(e),s=a===`closeClick`||a===`close-button`||a===`explicit`||a===`close`,c=!!o?.closest?.(`[data-modal-close],[data-close],.sealmoment__close,.sp-modal__close,button[aria-label="Close"],button[aria-label="close"],button[title="Close"]`);if(s||c||e==null&&t==null){Ee(!1),Oe(``),Ae(``);return}},[]),{series:Fn,pushSample:In}=QS({maxPoints:1512*8,maxBeats:1512});return(0,q.useEffect)(()=>{let e=(3+Math.sqrt(5))*1e3,t=null,n=null,r=()=>{let i=dn;Number.isFinite(i)&&In({t:Date.now(),v:i}),n=window.setTimeout(()=>{t=requestAnimationFrame(r)},e)};return r(),()=>{n&&clearTimeout(n),t&&cancelAnimationFrame(t)}},[dn,In]),(0,J.jsxs)(`main`,{className:`sigilpage`,role:`main`,"aria-label":`Kai Sigil Page`,"data-owner-verified":Xt,"data-archived":Yt,"data-old-link":st?`true`:`false`,"data-version":`v48`,children:[(0,J.jsx)(`div`,{className:`sp-veil`,"aria-hidden":`true`}),(0,J.jsx)(`div`,{className:`sp-veil-stars`,"aria-hidden":`true`}),(0,J.jsx)(`div`,{className:`sp-viewport`,"aria-hidden":!1,children:(0,J.jsxs)(`section`,{className:`sp-shell`,"data-center":!0,children:[(0,J.jsx)(ge,{glyphAuth:l,linkStatus:je,isArchived:Yt,localHash:W,copyHashPress:kn}),(l===`authentic`||s===`verified`)&&(0,J.jsxs)(J.Fragment,{children:[(0,J.jsx)(`style`,{children:`
`).map(e=>e.trim()).filter(e=>e.length>0&&lC(e)).slice(0,6),[x.mediaLines]),E=x.text.trim().length,D=x.title.trim().length,O=!!n&&E>0&&E<=4e3&&D<=140&&b.length>0,k=(0,q.useCallback)(e=>{(e.ctrlKey||e.metaKey)&&e.key===`Enter`&&O&&(e.preventDefault(),(async()=>ee())())},[O]),A=(0,q.useCallback)(e=>{p(e),m.current&&(m.current.textContent=e)},[]),j=(0,q.useCallback)(e=>{let t=e.currentTarget.value;S(e=>({...e,title:t}))},[S]),M=(0,q.useCallback)(e=>{let t=e.currentTarget.value;S(e=>({...e,text:t}))},[S]),N=(0,q.useCallback)(e=>{let t=e.currentTarget.value;S(e=>({...e,mediaLines:t}))},[S]),P=(0,q.useCallback)(e=>{let t=e.currentTarget.checked;S(e=>({...e,shareToLocalFeed:t}))},[S]),I=(0,q.useCallback)(e=>{let t=e.currentTarget.checked;S(e=>({...e,includeCanonicalHash:t}))},[S]),L=(0,q.useCallback)(()=>{if(!i)return;let e={url:i,hash:o,appId:b,pulse:r.pulse,beat:r.beat,stepIndex:r.stepIndex,title:x.title.trim()||void 0,text:x.text.trim()||void 0,tags:w.length?w:void 0,media:T,timestamp:new Date().toISOString()},t=new Blob([JSON.stringify(e,null,2)],{type:`application/json`}),n=document.createElement(`a`),a=URL.createObjectURL(t);n.href=a,n.download=`sigil-mint-${o||`post`}.json`,document.body.appendChild(n),n.click(),n.remove(),URL.revokeObjectURL(a)},[i,o,b,r.pulse,r.beat,r.stepIndex,x.title,x.text,w,T]),ee=(0,q.useCallback)(async()=>{if(!n){alert(`Login with your user glyph first.`);return}if(!O){alert(`Please write something first.`);return}if(n.expiresAtPulse&&r.pulse>n.expiresAtPulse){alert(`Login glyph expired (pulse window). Re-mint login.`);return}d(!0),A(`Sealing capsule…`);try{let e=`post`,t=typeof crypto<`u`&&`randomUUID`in crypto?crypto.randomUUID().slice(0,8):Math.random().toString(36).slice(2,10),i=(await sC(`${b}|${n.userPhiKey}|${r.pulse}|${r.beat}|${r.stepIndex}|${e}|${t}`)).slice(0,16),o=T.length>0?T.map(e=>({kind:`url`,url:e})):void 0,c={v:1,kind:e,appId:b,userId:n.userPhiKey,pulse:r.pulse,beat:r.beat,stepIndex:r.stepIndex,userPhiKey:n.userPhiKey,kaiSignature:n.kaiSignature,post:{title:x.title.trim()||void 0,text:x.text.trim(),tags:w.length?w:void 0,media:o},nonce:t,timestamp:new Date().toISOString(),...x.includeCanonicalHash?{canonicalHash:b}:{}},u=iC(`/s/${b}/${n.userPhiKey}/${r.pulse}/${r.beat}/${r.stepIndex}/${e}/${i}`,c);if(x.shareToLocalFeed)try{let e=`sigil:feed:sources`,t=typeof localStorage<`u`&&localStorage.getItem(e)||`[]`,n=JSON.parse(t),r=Array.isArray(n)?n.filter(e=>typeof e==`string`):[],i=Array.from(new Set([u,...r]));typeof localStorage<`u`&&localStorage.setItem(e,JSON.stringify(i)),typeof window<`u`&&window.dispatchEvent(new CustomEvent(`sigil:published`,{detail:{url:u}}))}catch(e){console.warn(`Local feed cache/broadcast failed:`,e instanceof Error?e.message:String(e))}a(u),s(i),l(!0),A(`Minted ✓`),S(e=>({...e,text:``,mediaLines:``}))}catch(e){A(`Mint failed: ${e instanceof Error?e.message:String(e)}`),console.error(e)}finally{d(!1),window.setTimeout(()=>A(``),1400)}},[n,O,b,r.pulse,r.beat,r.stepIndex,T,x.title,x.text,x.shareToLocalFeed,x.includeCanonicalHash,S,A,w.length]),R=(0,q.useMemo)(()=>r.stepIndex/43*100,[r.stepIndex]),z=(0,q.useMemo)(()=>n?b?x.text.trim()?n.expiresAtPulse&&r.pulse>n.expiresAtPulse?`Session expired; re-login.`:``:`Write something first.`:`Missing app glyph context.`:`Login with your glyph to mint.`,[n,b,x.text,r.pulse]);return(0,J.jsxs)(J.Fragment,{children:[(0,J.jsxs)(`section`,{className:`publisher ks-panel`,"data-beat":r.beat,children:[(0,J.jsxs)(`header`,{className:`ks-head`,children:[(0,J.jsxs)(`div`,{className:`ks-head-left`,children:[(0,J.jsx)(`h3`,{className:`ks-title`,children:`Publish to Glyph Stream (Coming SOON!)`}),(0,J.jsxs)(`p`,{className:`ks-meta`,children:[`App: `,(0,J.jsx)(`span`,{className:`mono`,children:cC(b)}),n?(0,J.jsxs)(J.Fragment,{children:[` `,`• User: `,(0,J.jsx)(`span`,{className:`mono`,children:cC(n.userPhiKey)})]}):null]})]}),(0,J.jsx)(`div`,{className:`ks-head-right`,children:(0,J.jsxs)(`div`,{className:`ks-pulse`,role:`img`,"aria-label":`Pulse ${r.pulse}, Beat ${r.beat}, Step ${r.stepIndex}, Chakra ${r.chakraDay}`,title:`Pulse ${r.pulse} • Beat ${r.beat} • Step ${r.stepIndex} • ${r.chakraDay}`,children:[(0,J.jsx)(`div`,{className:`ks-pulse-bar`,children:(0,J.jsx)(`div`,{className:`ks-pulse-fill`,style:{width:`${R.toFixed(1)}%`}})}),(0,J.jsxs)(`div`,{className:`ks-pulse-meta`,children:[(0,J.jsxs)(`span`,{children:[`u`,r.pulse]}),(0,J.jsxs)(`span`,{children:[`b`,r.beat]}),(0,J.jsxs)(`span`,{children:[`s`,r.stepIndex]}),(0,J.jsx)(`span`,{className:`ks-chakra`,children:r.chakraDay})]})]})})]}),(0,J.jsxs)(`div`,{className:`ks-form`,children:[(0,J.jsxs)(`div`,{className:`ks-row`,children:[(0,J.jsxs)(`label`,{htmlFor:h,className:`ks-label`,children:[`Title `,(0,J.jsx)(`span`,{className:`ks-optional`,children:`(optional)`})]}),(0,J.jsx)(`input`,{id:h,className:`ks-input`,type:`text`,value:x.title,onChange:j,onKeyDown:k,maxLength:140,placeholder:`A crisp resonance headline…`,"aria-describedby":`${h}-count`}),(0,J.jsxs)(`div`,{id:`${h}-count`,className:`ks-count`,children:[D,`/140`]})]}),(0,J.jsxs)(`div`,{className:`ks-row`,children:[(0,J.jsx)(`label`,{htmlFor:g,className:`ks-label`,children:`Post`}),(0,J.jsx)(`textarea`,{id:g,className:`ks-textarea`,rows:5,value:x.text,onChange:M,onKeyDown:k,maxLength:4e3,placeholder:`Breathe once, then write…  (#tags supported)`,"aria-describedby":`${g}-count`}),(0,J.jsxs)(`div`,{id:`${g}-count`,className:`ks-count`,children:[E,`/4000`]})]}),(0,J.jsxs)(`div`,{className:`ks-row`,children:[(0,J.jsxs)(`label`,{htmlFor:_,className:`ks-label`,children:[`Media URLs `,(0,J.jsx)(`span`,{className:`ks-optional`,children:`(optional)`})]}),(0,J.jsx)(`textarea`,{id:_,className:`ks-textarea mono`,rows:2,value:x.mediaLines,onChange:N,onKeyDown:k,placeholder:`https://… (one per line, up to 6)`}),T.length>0&&(0,J.jsx)(`div`,{className:`ks-media-preview`,children:T.map(e=>(0,J.jsx)(`a`,{className:`ks-chip`,href:e,target:`_blank`,rel:`noreferrer`,title:e,children:new URL(e).host},e))})]}),(0,J.jsxs)(`div`,{className:`ks-row ks-options`,children:[(0,J.jsxs)(`label`,{className:`ks-check`,children:[(0,J.jsx)(`input`,{id:v,type:`checkbox`,checked:x.shareToLocalFeed,onChange:P}),(0,J.jsx)(`span`,{children:`Mirror to local feed pool`})]}),(0,J.jsxs)(`label`,{className:`ks-check`,children:[(0,J.jsx)(`input`,{id:y,type:`checkbox`,checked:x.includeCanonicalHash,onChange:I}),(0,J.jsx)(`span`,{children:`Embed canonicalHash for sanity`})]}),w.length>0&&(0,J.jsx)(`div`,{className:`ks-tags`,children:w.map(e=>(0,J.jsxs)(`span`,{className:`ks-tag`,children:[`#`,e]},e))})]}),(0,J.jsxs)(`div`,{className:`ks-actions`,children:[(0,J.jsxs)(`button`,{type:`button`,className:`ks-btn primary`,onClick:ee,disabled:!O||u,title:z,children:[u?`Minting…`:`Mint Post Glyph`,(0,J.jsxs)(`span`,{className:`ks-kbd`,children:[`⌘/Ctrl `,(0,J.jsx)(`span`,{className:`plus`,children:`+`}),` Enter`]})]}),(0,J.jsx)(`button`,{type:`button`,className:`ks-btn ghost`,onClick:C,disabled:u||!x.title&&!x.text&&!x.mediaLines,title:`Clear draft`,children:`Clear Draft`}),i&&(0,J.jsxs)(J.Fragment,{children:[(0,J.jsx)(`a`,{className:`ks-btn`,href:i,target:`_blank`,rel:`noreferrer`,children:`Open`}),(0,J.jsx)(`button`,{type:`button`,className:`ks-btn`,onClick:async()=>{try{await navigator.clipboard.writeText(i),A(`URL copied`),window.setTimeout(()=>A(``),1e3)}catch(e){console.warn(`Remember failed:`,e instanceof Error?e.message:String(e))}},children:`Remember`})]})]}),(0,J.jsx)(`div`,{className:`ks-status`,role:`status`,"aria-live":`polite`,ref:m,children:f}),i&&(0,J.jsx)(`div`,{className:`ks-minted mono`,"data-testid":`minted-url`,children:i})]})]}),(0,J.jsx)(F,{open:c,url:i,hash:o,onClose:()=>l(!1),onDownloadZip:L})]})}const yC=e=>e===`verified`?`ok`:e;var bC=e=>typeof e==`number`&&Number.isFinite(e),xC=(e,t=0)=>{if(bC(e))return e;if(typeof e==`string`&&e.trim()!==``){let n=Number(e);return Number.isFinite(n)?n:t}return t},SC=e=>e===`mint`||e===`transfer`||e===`claim`;function CC(e,t){let n=t??xC(e.pulse,0);return(Array.isArray(e.provenance)?e.provenance:[]).flatMap(e=>{if(!e||typeof e!=`object`)return[];let t=e,r=typeof t.ownerPhiKey==`string`?t.ownerPhiKey:``,i=typeof t.kaiSignature==`string`?t.kaiSignature:void 0,a=xC(t.pulse,n),o=xC(t.beat,0),s;if(bC(t.stepIndex))s=t.stepIndex;else if(typeof t.stepIndex==`string`&&t.stepIndex.trim()!==``){let e=xC(t.stepIndex,NaN);Number.isFinite(e)&&(s=e)}let c=typeof t.atPulse==`string`&&t.atPulse.trim()!==``||bC(t.atPulse)?xC(t.atPulse,a):a,l=typeof t.attachmentName==`string`?t.attachmentName:void 0,u=SC(t.action)?t.action:`mint`;return[{ownerPhiKey:r,kaiSignature:i,pulse:a,beat:o,stepIndex:s,atPulse:c,attachmentName:l,action:u}]})}function wC(e,t,n,r,i,a){let o=n.stepsPerBeat??44,s=ue(n.pulse,o);return{ownerPhiKey:e,kaiSignature:t,pulse:n.pulse,beat:n.beat,stepIndex:s,atPulse:a,attachmentName:i,action:r}}function TC(e,t){let n=document.head.querySelectorAll(`meta[name], meta[property]`);for(let r of n)if(r.getAttribute(e)===t)return r;return null}function EC(e,t){let n=TC(e,t);return n||(n=document.createElement(`meta`),n.setAttribute(e,t),document.head.appendChild(n)),n}function DC(e,t,n){let r=EC(e,t);n==null?r.removeAttribute(`content`):r.setAttribute(`content`,n)}function OC(e){let t=document.head.querySelectorAll(`link[rel]`);for(let n of t)if((n.getAttribute(`rel`)||``).toLowerCase()===e.toLowerCase())return n;return null}function kC(e){let t=OC(e);return t||(t=document.createElement(`link`),t.setAttribute(`rel`,e),document.head.appendChild(t)),t}function AC(e,t){let n=document.getElementById(e);n||(n=document.createElement(`script`),n.id=e,n.type=`application/ld+json`,document.head.appendChild(n)),n.textContent=JSON.stringify(t)}const jC={Root:{hue:0,accent:`#CC3F3F`},Sacral:{hue:24,accent:`#E86428`},"Solar Plexus":{hue:48,accent:`#E6B844`},Heart:{hue:140,accent:`#2CCB99`},Throat:{hue:190,accent:`#00D5AA`},"Third Eye":{hue:260,accent:`#6B4AC0`},Crown:{hue:300,accent:`#C25AA4`}},MC=()=>/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform===`MacIntel`&&(navigator.maxTouchPoints??0)>1;function NC(){let[e,t]=(0,q.useState)(null),[n,r]=(0,q.useState)(s),i=(0,q.useRef)(null),a=(0,q.useRef)(null);return(0,q.useEffect)(()=>{let e=null,n=()=>{let e=c(new Date),n=Date.now();if(a.current==null||e.pulse!==a.current)a.current=e.pulse,i.current=n,t(e.pulse),r(s);else{let a=i.current,o=a==null?s:Math.max(0,s-(n-a));t(e.pulse),r(o)}};return e=window.setInterval(n,50),n(),()=>{e!=null&&window.clearInterval(e)}},[]),{pulse:e,msToNextPulse:n}}function PC(e){if(!e||typeof e!=`object`)return!1;let t=e;return typeof t.name==`string`&&typeof t.mime==`string`&&typeof t.dataUri==`string`&&typeof t.size==`number`}function FC(e){if(!e||typeof e!=`object`)return!1;let t=e,n=t.action,r=n===`mint`||n===`transfer`||n===`claim`;return typeof t.ownerPhiKey==`string`&&typeof t.pulse==`number`&&typeof t.beat==`number`&&typeof t.atPulse==`number`&&r}function IC(e){return!!e&&typeof e==`object`}function LC(e){if(!e)return{};if(typeof e==`object`)return e;if(typeof e==`string`)try{let t=JSON.parse(e);if(t&&typeof t==`object`)return t}catch{}return{}}function RC(e){try{let t=new URLSearchParams(e),n=t.get(`p`);if(!n)return null;let r=y(n);if(!r||typeof r!=`object`)return null;let i=r.stepsPerBeat,a=i!=null&&!Number.isNaN(Number(i))?Math.max(1,Math.floor(Number(i))):44,o=r.stepIndex,s=o!=null&&!Number.isNaN(Number(o))?Math.max(0,Math.min(a-1,Math.floor(Number(o)))):void 0,c=typeof r.stepPct==`number`?Math.max(0,Math.min(1,r.stepPct)):s==null?0:(s+1e-9)/a,l=r.expiresAtPulse==null?NaN:Number(r.expiresAtPulse),u=r.exportedAtPulse==null?NaN:Number(r.exportedAtPulse),d=(r.claimExtendUnit||``).toString().toLowerCase(),f=d===`steps`?`steps`:d===`breaths`?`breaths`:void 0,p=r.claimExtendAmount!=null&&!Number.isNaN(Number(r.claimExtendAmount))?Math.max(0,Math.floor(Number(r.claimExtendAmount))):void 0,m=Array.isArray(r.provenance)?r.provenance.filter(FC):void 0,h=PC(r.attachment)?r.attachment:void 0,g=typeof r.zkPoseidonHash==`string`?r.zkPoseidonHash:`0x`,_=IC(r.zkProof)?r.zkProof:{},v=LC(r.ownerPubKey),b=typeof r.ownerSig==`string`?r.ownerSig:``,x=r.eternalRecord??null,S=typeof r.creatorResolved==`boolean`?r.creatorResolved:!1,C=typeof r.origin==`string`?r.origin:``,w=Array.isArray(r.proofHints)?r.proofHints??[]:[],T={pulse:Number(r.pulse)||0,beat:Number(r.beat)||0,chakraDay:r.chakraDay,stepIndex:s,stepPct:c,kaiSignature:typeof r.kaiSignature==`string`?r.kaiSignature:void 0,userPhiKey:typeof r.userPhiKey==`string`?r.userPhiKey:void 0,stepsPerBeat:a,provenance:m,attachment:h,expiresAtPulse:Number.isFinite(l)?l:void 0,canonicalHash:typeof r.canonicalHash==`string`?r.canonicalHash:void 0,transferNonce:typeof r.transferNonce==`string`?r.transferNonce:void 0,exportedAtPulse:Number.isFinite(u)?u:void 0,claimExtendUnit:f,claimExtendAmount:p,zkPoseidonHash:g,zkProof:_,ownerPubKey:v,ownerSig:b,eternalRecord:x,creatorResolved:S,origin:C,proofHints:w},E=t.get(`t`);return E&&!T.transferNonce&&(T.transferNonce=E),T}catch{return null}}function zC(e,t){try{let n=RC(e);return n?{payload:n,verified:`ok`,error:null,loading:!1}:{payload:null,verified:t?`notfound`:`checking`,error:null,loading:!1}}catch(e){return{payload:null,verified:`error`,error:e instanceof Error?e.message:`Failed to decode payload`,loading:!1}}}function BC(e,t=null){let[n,r]=(0,q.useState)(void 0),[i,a]=(0,q.useState)(void 0),o=(0,q.useMemo)(()=>zC(e,t),[e,t]),s=n===void 0?o.payload:n,c=i===void 0?o.loading:i;return{payload:s,loading:c,verified:o.verified,error:o.error,setPayload:e=>{r(()=>typeof e==`function`?e(s):e)},setLoading:e=>{a(()=>typeof e==`function`?e(c):e)}}}const VC=e=>typeof window>`u`?``:window.btoa(String.fromCharCode(...new Uint8Array(e)));function HC(e,t){e(t),window.setTimeout(()=>e(``),1400)}async function UC(){return(await i(()=>import(`./jszip.min-Bb-dHT90.js`).then(l(1)),__vite__mapDeps([0,1,2,3]))).default}const WC=(e,t=600)=>{let n=window;return typeof n.requestIdleCallback==`function`?n.requestIdleCallback(e,{timeout:t}):window.setTimeout(()=>e({didTimeout:!0,timeRemaining:()=>0}),90)},GC=e=>{let t=window;typeof t.cancelIdleCallback==`function`?t.cancelIdleCallback(e):window.clearTimeout(e)},KC=async e=>{let t=new TextEncoder().encode(e),n=await crypto.subtle.digest(`SHA-256`,t);return Array.from(new Uint8Array(n)).map(e=>e.toString(16).padStart(2,`0`)).join(``)};function qC(e,t,n){return`hsl(${e} ${t}% ${n}%)`}function JC(e){if(!e)return 0;let t=parseInt(e.slice(-2),16);return Number.isFinite(t)?t%12:0}function YC(e,t,n){return qC(((jC[e]?.hue??180)+JC(n||void 0)*2.5)%360,100,50+15*Math.sin(t*2*Math.PI))}const XC=e=>e.toFixed(6);function ZC(e){let t=String(e||``);return t.startsWith(`h:`)?t:`h:${t}`}var QC=`123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz`;const $C=e=>Array.from(e).map(e=>e.toString(16).padStart(2,`0`)).join(``);function ew(e){let t=e.buffer;if(t instanceof ArrayBuffer)return e.byteOffset===0&&e.byteLength===t.byteLength?t:t.slice(e.byteOffset,e.byteOffset+e.byteLength);let n=new ArrayBuffer(e.byteLength);return new Uint8Array(n).set(e),n}async function tw(e){let t=typeof e==`string`?new TextEncoder().encode(e):e,n=await crypto.subtle.digest(`SHA-256`,ew(t));return $C(new Uint8Array(n))}function nw(e){let t=0n;for(let n of e)t=(t<<8n)+BigInt(n);let n=``;for(;t>0n;)n=QC[Number(t%58n)]+n,t/=58n;for(let t=0;t<e.length&&e[t]===0;t++)n=`1`+n;return n}async function rw(e,t=0){let n=new Uint8Array(1+e.length);n[0]=t,n.set(e,1);let r=await crypto.subtle.digest(`SHA-256`,ew(n)),i=await crypto.subtle.digest(`SHA-256`,r),a=new Uint8Array(i).slice(0,4),o=new Uint8Array(n.length+4);return o.set(n),o.set(a,n.length),nw(o)}async function iw(e){let t=await tw(e+`φ`),n=new Uint8Array(20);for(let e=0;e<20;e++)n[e]=parseInt(t.slice(e*2,e*2+2),16);return rw(n,0)}function aw(e,t,n,r,i){return`${e}|${t}|${n}|${r}|${i??``}`}function ow(e){if(typeof e!=`object`||!e)return;let t=e.intentionSigil;return typeof t==`string`?t:void 0}function sw(e){return typeof e==`object`&&!!e&&!Array.isArray(e)}function cw(e){if(!e)return null;try{let t=JSON.parse(e);return sw(t)?t:null}catch{return null}}function lw(e){try{let t=Array.from(e.querySelectorAll(`metadata`));if(!t.length)return;let n=t.find(e=>e.getAttribute(`data-noncanonical`)!==`1`&&e.id!==`sigil-display`)??t[0];n&&e.firstChild!==n&&e.insertBefore(n,e.firstChild)}catch(e){console.debug(`ensureCanonicalMetadataFirst failed:`,e)}}function uw(e){let t=Array.from(e.querySelectorAll(`metadata`));return t.length?t.find(e=>e.getAttribute(`data-noncanonical`)!==`1`&&e.id!==`sigil-display`)??t[0]:null}function dw(e,t){try{let n=uw(e);if(!n)return;let r=cw(n.textContent?.trim()??``)??{},i=t(Object.freeze(r));n.textContent=JSON.stringify(i),e.firstChild!==n&&e.insertBefore(n,e.firstChild)}catch(e){console.debug(`rewriteCanonicalMetadata failed:`,e)}}function fw(e,t,n,r){try{let i=`ks-${t}-${n}-`,a=`${i}${r}`,o=a;e.setAttribute(`id`,o),e.setAttribute(`aria-describedby`,`${o}-desc`);let s=e.querySelector(`desc`);s&&s.setAttribute(`id`,`${o}-desc`),e.setAttribute(`data-step-index`,String(r));let c=new Map,l=RegExp(`^${i}(\\d+)(.*)$`);e.querySelectorAll(`[id]`).forEach(e=>{let t=e.getAttribute(`id`)||``,n=l.exec(t);if(!n)return;let i=n[1],o=n[2]||``;if(i!==String(r)){let e=`${a}${o}`;c.set(t,e)}});let u=e.getAttribute(`id`)||``,d=l.exec(u);d&&d[1]!==String(r)&&c.set(u,o),c.forEach((t,n)=>{let r=e.querySelector(`[id="${n}"]`);r&&r.setAttribute(`id`,t)});let f=[`href`,`xlink:href`,`filter`,`mask`,`fill`,`stroke`,`style`,`aria-describedby`],p=(e,t,n)=>e.indexOf(t)===-1?e:e.split(t).join(n);e.querySelectorAll(`*`).forEach(e=>{for(let t of f){let n=e.getAttribute(t);if(!n)continue;let r=n;c.forEach((e,t)=>{r=p(r,`url(#${t}`,`url(#${e}`),r=p(r,`"#${t}"`,`"#${e}"`),r=p(r,`'#${t}'`,`'#${e}'`),r=p(r,`#${t}`,`#${e}`),r=p(r,`&quot;#${t}&quot;`,`&quot;#${e}&quot;`)}),r!==n&&e.setAttribute(t,r)}});let m=RegExp(`(Day\\s+Seal:\\s*${n}\\s*:)\\s*\\d+`);e.querySelectorAll(`text`).forEach(e=>{let t=e.textContent||``,n=t.replace(m,`$1${r}`);n!==t&&(e.textContent=n)});let h=44;try{let t=uw(e),n=t?cw(t.textContent?.trim()):null,r=Number(n?.stepsPerBeat);Number.isFinite(r)&&r>0&&(h=Math.max(1,Math.floor(r)))}catch{}let g=Number(e.getAttribute(`data-steps-per-beat`));Number.isFinite(g)&&g>0&&(h=Math.max(1,Math.floor(g))),dw(e,e=>{let i={...e};if(i.pulse=t,i.kaiPulse=t,i.beat=n,i.stepIndex=r,i.stepsPerBeat=h,typeof i.eternalRecord==`string`){let e=RegExp(`(Day\\s*Seal:\\s*${n}\\s*:)\\s*\\d+`);i.eternalRecord=i.eternalRecord.replace(e,`$1${r}`)}return i}),lw(e)}catch(e){console.debug(`retagSvgIdsForStep failed:`,e)}}function pw(){let e=`sigilpage-crystal-styles`;if(document.getElementById(e))return;let t=document.createElement(`style`);t.id=e,t.innerHTML=`
`;return typeof a==`function`&&a(null,p),p}})),vT=n(t((e=>{var t=Gw(),n=mT(),r=gT(),i=_T();function a(e,r,i,a,o){let s=[].slice.call(arguments,1),c=s.length,l=typeof s[c-1]==`function`;if(!l&&!t())throw Error(`Callback required as last argument`);if(l){if(c<2)throw Error(`Too few arguments provided`);c===2?(o=i,i=r,r=a=void 0):c===3&&(r.getContext&&o===void 0?(o=a,a=void 0):(o=a,a=i,i=r,r=void 0))}else{if(c<1)throw Error(`Too few arguments provided`);return c===1?(i=r,r=a=void 0):c===2&&!r.getContext&&(a=i,i=r,r=void 0),new Promise(function(t,o){try{t(e(n.create(i,a),r,a))}catch(e){o(e)}})}try{let t=n.create(i,a);o(null,e(t,r,a))}catch(e){o(e)}}e.create=n.create,e.toCanvas=a.bind(null,r.render),e.toDataURL=a.bind(null,r.renderToDataURL),e.toString=a.bind(null,function(e,t,n){return i.render(e,n)})}))(),1);const yT=1024,bT=2048,xT=1200;function ST(e,t){let n=e.querySelector(`defs`);n||(n=e.ownerDocument.createElementNS(fe.SVG_NS,`defs`),e.insertBefore(n,e.firstChild));let r=`ep-neon-glow`;if(!e.querySelector(`#${r}`)){let t=e.ownerDocument.createElementNS(fe.SVG_NS,`filter`);t.setAttribute(`id`,r),t.setAttribute(`x`,`-50%`),t.setAttribute(`y`,`-50%`),t.setAttribute(`width`,`200%`),t.setAttribute(`height`,`200%`);let i=e.ownerDocument.createElementNS(fe.SVG_NS,`feGaussianBlur`);i.setAttribute(`stdDeviation`,`3`),i.setAttribute(`result`,`b1`);let a=e.ownerDocument.createElementNS(fe.SVG_NS,`feGaussianBlur`);a.setAttribute(`in`,`SourceGraphic`),a.setAttribute(`stdDeviation`,`1.2`),a.setAttribute(`result`,`b2`);let o=e.ownerDocument.createElementNS(fe.SVG_NS,`feMerge`),s=e.ownerDocument.createElementNS(fe.SVG_NS,`feMergeNode`);s.setAttribute(`in`,`b1`);let c=e.ownerDocument.createElementNS(fe.SVG_NS,`feMergeNode`);c.setAttribute(`in`,`b2`);let l=e.ownerDocument.createElementNS(fe.SVG_NS,`feMergeNode`);l.setAttribute(`in`,`SourceGraphic`),o.appendChild(s),o.appendChild(c),o.appendChild(l),t.appendChild(i),t.appendChild(a),t.appendChild(o),n.appendChild(t)}let i=`ep-gloss-gradient`;if(!e.querySelector(`#${i}`)){let t=e.ownerDocument.createElementNS(fe.SVG_NS,`linearGradient`);t.setAttribute(`id`,i),t.setAttribute(`x1`,`0`),t.setAttribute(`y1`,`0`),t.setAttribute(`x2`,`0`),t.setAttribute(`y2`,`1`);let r=e.ownerDocument.createElementNS(fe.SVG_NS,`stop`);r.setAttribute(`offset`,`0%`),r.setAttribute(`stop-color`,`rgba(255,255,255,0.15)`);let a=e.ownerDocument.createElementNS(fe.SVG_NS,`stop`);a.setAttribute(`offset`,`100%`),a.setAttribute(`stop-color`,`rgba(255,255,255,0.05)`),t.appendChild(r),t.appendChild(a),n.appendChild(t)}let a=`ep-bar-outer-glow`;if(!e.querySelector(`#${a}`)){let r=e.ownerDocument.createElementNS(fe.SVG_NS,`filter`);r.setAttribute(`id`,a),r.setAttribute(`x`,`-50%`),r.setAttribute(`y`,`-50%`),r.setAttribute(`width`,`200%`),r.setAttribute(`height`,`200%`);let i=e.ownerDocument.createElementNS(fe.SVG_NS,`feFlood`);i.setAttribute(`flood-color`,t),i.setAttribute(`flood-opacity`,`0.5`),i.setAttribute(`result`,`c`);let o=e.ownerDocument.createElementNS(fe.SVG_NS,`feComposite`);o.setAttribute(`in`,`c`),o.setAttribute(`in2`,`SourceAlpha`),o.setAttribute(`operator`,`in`),o.setAttribute(`result`,`glow`);let s=e.ownerDocument.createElementNS(fe.SVG_NS,`feGaussianBlur`);s.setAttribute(`in`,`glow`),s.setAttribute(`stdDeviation`,`4`),s.setAttribute(`result`,`blurGlow`);let c=e.ownerDocument.createElementNS(fe.SVG_NS,`feMerge`),l=e.ownerDocument.createElementNS(fe.SVG_NS,`feMergeNode`);l.setAttribute(`in`,`blurGlow`);let u=e.ownerDocument.createElementNS(fe.SVG_NS,`feMergeNode`);u.setAttribute(`in`,`SourceGraphic`),c.appendChild(l),c.appendChild(u),r.appendChild(i),r.appendChild(o),r.appendChild(s),r.appendChild(c),n.appendChild(r)}return{neonId:`ep-neon-glow`,glossId:`ep-gloss-gradient`,barGlowId:`ep-bar-outer-glow`}}async function CT(e,t){let{accent:n,qrUrl:r}=t,i=(e.getAttribute(`viewBox`)||`0 0 ${e.getAttribute(`width`)||1024} ${e.getAttribute(`height`)||1024}`).trim().split(/\s+/).map(Number),a=i[0]||0,o=i[1]||0,s=i[2]||1024,c=i[3]||1024,l=e.ownerDocument.createElementNS(fe.SVG_NS,`g`);l.setAttribute(`data-export-qr`,`1`);let u=Math.min(s,c),d=Math.max(u*.035,18),f=Math.max(u*.1,96),p=await vT.toDataURL(r,{margin:0,color:{dark:n,light:`#00000000`},scale:8}),m=e.ownerDocument.createElementNS(fe.SVG_NS,`image`);m.setAttributeNS(fe.XLINK_NS,`xlink:href`,p),m.setAttribute(`href`,p),m.setAttribute(`x`,String(a+d)),m.setAttribute(`y`,String(o+c-f-d)),m.setAttribute(`width`,String(f)),m.setAttribute(`height`,String(f)),m.setAttribute(`preserveAspectRatio`,`xMidYMid meet`),l.appendChild(m),e.appendChild(l)}async function wT(e,t=yT,n){let r=e.cloneNode(!0);if(U(r,t),le(r),de(r,n?.title||`Kairos Sigil-Glyph — Sealed Kairos Moment`,n?.desc||`Deterministic sigil-glyph with sovereign metadata.`),n?.metaOverride){let e=W(r);e.textContent=JSON.stringify(n.metaOverride)}if(r.querySelectorAll(`[data-export-qr="1"],[data-export-pulsebar="1"]`).forEach(e=>e.parentNode?.removeChild(e)),n?.addQR&&await CT(r,n.addQR),n?.addPulseBar){let{accent:e,pulseNumber:i}=n.addPulseBar,{barGlowId:a,neonId:o,glossId:s}=ST(r,e),c=(r.getAttribute(`viewBox`)||`0 0 ${t} ${t}`).split(/\s+/).map(Number),[l,u,d,f]=[c[0]||0,c[1]||0,c[2]||t,c[3]||t],p=r.ownerDocument.createElementNS(fe.SVG_NS,`g`);p.setAttribute(`data-export-pulsebar`,`1`);let m=Math.min(d,f),h=Math.max(m*.035,18),g=Math.max(m*.34,320),_=Math.max(m*.085,96),v=Math.max(_*.22,18),y=l+d-g-h,b=u+f-_-h,x=r.ownerDocument.createElementNS(fe.SVG_NS,`rect`);x.setAttribute(`x`,String(y)),x.setAttribute(`y`,String(b)),x.setAttribute(`rx`,String(v)),x.setAttribute(`ry`,String(v)),x.setAttribute(`width`,String(g)),x.setAttribute(`height`,String(_)),x.setAttribute(`fill`,`url(#${s})`),x.setAttribute(`stroke`,`rgba(255,255,255,0.16)`),x.setAttribute(`stroke-width`,String(Math.max(1.5,m*.0018))),x.setAttribute(`filter`,`url(#${a})`),p.appendChild(x);let S=r.ownerDocument.createElementNS(fe.SVG_NS,`text`);S.setAttribute(`x`,String(y+g/2)),S.setAttribute(`y`,String(b+_/2+Math.max(6,_*.06))),S.setAttribute(`text-anchor`,`middle`),S.setAttribute(`dominant-baseline`,`middle`),S.setAttribute(`fill`,e),S.setAttribute(`filter`,`url(#${o})`),S.setAttribute(`font-weight`,`900`),S.setAttribute(`font-family`,`Inter, ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica Neue, Arial`),S.setAttribute(`font-size`,String(Math.floor(_*.46))),S.textContent=i.toLocaleString(),p.appendChild(S),r.appendChild(p)}let i=new XMLSerializer().serializeToString(r),a=i.startsWith(`<?xml`)?i:`<?xml version="1.0" encoding="UTF-8"?>\n${i}`;return new Blob([a],{type:`image/svg+xml;charset=utf-8`})}async function TT(e,t=yT){let n=URL.createObjectURL(e);try{let e=new Image;await new Promise((t,r)=>{e.onload=()=>t(),e.onerror=r,e.src=n});let r=document.createElement(`canvas`);r.width=t,r.height=t;let i=r.getContext(`2d`);if(!i)throw Error(`Canvas unsupported`);return i.drawImage(e,0,0,t,t),await new Promise((e,t)=>r.toBlob(n=>n?e(n):t(Error(`PNG encode failed`)),`image/png`))}finally{URL.revokeObjectURL(n)}}const ET=`sigil-debits-v1`,DT=(e,t)=>t?`sigil:debits:${e}:t:${t}`:`sigil:debits:${e}`,OT=(e,t)=>e===DT(t)||e.startsWith(`${DT(t)}:t:`),kT=(e,t)=>{let n=`sigil:debits:${t}`;if(e===n)return null;let r=`${n}:t:`;return e.startsWith(r)?e.slice(r.length):void 0};function AT(e){let t=new TextEncoder().encode(e),n=``;for(let e=0;e<t.length;e++)n+=String.fromCharCode(t[e]);return btoa(n).replace(/\+/g,`-`).replace(/\//g,`_`).replace(/=+$/g,``)}function jT(e){let t=(4-e.length%4)%4,n=e.replace(/-/g,`+`).replace(/_/g,`/`)+`=`.repeat(t),r=atob(n),i=new Uint8Array(r.length);for(let e=0;e<r.length;e++)i[e]=r.charCodeAt(e);return new TextDecoder().decode(i)}function MT(e){try{let t={originalAmount:typeof e.originalAmount==`number`&&Number.isFinite(e.originalAmount)?e.originalAmount:null,debits:Array.isArray(e.debits)?e.debits:[]};return AT(JSON.stringify(t))}catch{return``}}function NT(e){if(typeof e!=`object`||!e)return!1;let t=e;return typeof t.nonce==`string`&&t.nonce.length>0&&typeof t.recipientPhiKey==`string`&&t.recipientPhiKey.length>0&&typeof t.amount==`number`&&Number.isFinite(t.amount)&&t.amount>0&&typeof t.timestamp==`number`&&Number.isFinite(t.timestamp)}function PT(e){if(!e)return null;try{let t=JSON.parse(jT(e));if(typeof t!=`object`||!t)return null;let n={},r=t;if(typeof r.originalAmount==`number`&&Number.isFinite(r.originalAmount)&&(n.originalAmount=r.originalAmount),Array.isArray(r.debits)){let e=[];for(let t of r.debits)NT(t)&&e.push(t);e.length&&(n.debits=e)}return n}catch{return null}}function FT(e,t){try{let n=new URL(window.location.href),r=typeof e.originalAmount==`number`&&Number.isFinite(e.originalAmount),i=Array.isArray(e.debits)&&e.debits.length>0;!r&&!i?n.searchParams.delete(`d`):n.searchParams.set(`d`,MT(e));let a=`${n.pathname}${n.search}${n.hash}`;t?.navigate?window.location.replace(a):window.history.replaceState(null,``,a)}catch{}}function IT(e,t){let n=(e||``).toLowerCase();if(!n)return null;try{let e=t?localStorage.getItem(DT(n,t)):null;if(e)return PT(e);let r=localStorage.getItem(DT(n));return r?PT(r):null}catch{return null}}function LT(e,t,n){let r=(e||``).toLowerCase();if(r)try{localStorage.setItem(DT(r,n),MT(t))}catch{}}function RT(e){let t=new Set,n=[];for(let r of e)!r||typeof r.nonce!=`string`||t.has(r.nonce)||(t.add(r.nonce),n.push(r));return n.sort((e,t)=>(e.timestamp||0)-(t.timestamp||0))}function zT(e,t){let n={},r=typeof e?.originalAmount==`number`?e.originalAmount:void 0,i=typeof t?.originalAmount==`number`?t.originalAmount:void 0;n.originalAmount=typeof r==`number`?r:typeof i==`number`?i:void 0;let a=Array.isArray(e?.debits)?e.debits:[],o=Array.isArray(t?.debits)?t.debits:[],s=RT([...a,...o]);return s.length&&(n.debits=s),n}function BT(e,t){let n=typeof e?.originalAmount==`number`&&Number.isFinite(e.originalAmount)?Number(e.originalAmount):NaN,r=typeof t?.originalAmount==`number`&&Number.isFinite(t.originalAmount)?Number(t.originalAmount):NaN,i=Number.isNaN(n)&&Number.isNaN(r)||Math.abs(n-r)<1e-12,a=new Set((Array.isArray(e?.debits)?e.debits:[]).map(e=>e?.nonce)),o=new Set((Array.isArray(t?.debits)?t.debits:[]).map(e=>e?.nonce));if(!i||a.size!==o.size)return!1;for(let e of a)if(!o.has(e))return!1;return!0}function VT(e,t,n,r){FT(e,{navigate:!!r?.navigate});let i=(t||``).toLowerCase();if(i&&(LT(i,e,n??null),r?.broadcast!==!1))try{let t=new BroadcastChannel(ET),r={type:`debits`,canonical:i,qs:MT(e),stamp:Date.now(),token:n??null};t.postMessage(r),t.close()}catch{}}function HT(e,t,n){let r=PT(t.get(`d`)),i=zT(n?IT(e,n):IT(e,null),r);return{merged:i,urlIsStale:!BT(i,r)}}function UT(e){try{let t=new URL(e,window.location.origin).pathname.match(/\/s\/([0-9a-fA-F]+)/);return t?t[1].toLowerCase():null}catch{return null}}function WT(e){if(typeof e==`string`)switch(e.trim().toLowerCase().replace(/\s+/g,` `)){case`root`:return`Root`;case`sacral`:return`Sacral`;case`solar plexus`:case`solarplexus`:return`Solar Plexus`;case`heart`:return`Heart`;case`throat`:return`Throat`;case`third eye`:case`thirdeye`:return`Third Eye`;case`crown`:return`Crown`;default:return}}function GT(e){return e===`breaths`||e===`steps`?e:void 0}var KT=e=>!!e&&typeof e==`object`,qT=e=>{if(!KT(e))return!1;let t=`u`in e&&`b`in e,n=`d`in e;return t||n},JT=e=>typeof e==`number`&&Number.isFinite(e)?e:void 0,YT=e=>typeof e==`string`&&e.trim()?e:void 0;function XT(e){if(!e)return{};try{let t=String(e).trim(),n=!1;/^c:/i.test(t)&&(t=t.slice(2),n=!0);let r=JSON.parse(jT(t));if(n||qT(r)){let e=r,t={},n=JT(e.u),i=JT(e.b),a=JT(e.d),o=JT(e.s),s=WT(e.c);return n!==void 0&&(t.pulse=n),i!==void 0&&(t.beat=i),a!==void 0&&(t.stepsPerBeat=a),o!==void 0&&(t.stepIndex=o),s!==void 0&&(t.chakraDay=s),t}if(KT(r)){let e=r,t={},n=JT(e.pulse),i=JT(e.beat),a=JT(e.stepsPerBeat),o=JT(e.stepIndex),s=WT(e.chakraDay),c=YT(e.canonicalHash),l=YT(e.kaiSignature),u=YT(e.userPhiKey),d=YT(e.transferNonce),f=JT(e.expiresAtPulse),p=GT(e.claimExtendUnit),m=JT(e.claimExtendAmount);return n!==void 0&&(t.pulse=n),i!==void 0&&(t.beat=i),a!==void 0&&(t.stepsPerBeat=a),o!==void 0&&(t.stepIndex=o),s!==void 0&&(t.chakraDay=s),c!==void 0&&(t.canonicalHash=c.toLowerCase()),l!==void 0&&(t.kaiSignature=l),u!==void 0&&(t.userPhiKey=u),d!==void 0&&(t.transferNonce=d),f!==void 0&&(t.expiresAtPulse=f),p!==void 0&&(t.claimExtendUnit=p),m!==void 0&&(t.claimExtendAmount=m),Array.isArray(e.lineage)&&(t.lineage=e.lineage),t}return{}}catch{return{}}}function ZT(e,t){let n={...e};typeof t.expiresAtPulse==`number`&&(n.expiresAtPulse=t.expiresAtPulse),t.claimExtendUnit!=null&&(n.claimExtendUnit=t.claimExtendUnit),typeof t.claimExtendAmount==`number`&&(n.claimExtendAmount=t.claimExtendAmount),typeof t.pulse==`number`&&(n.pulse=t.pulse),typeof t.beat==`number`&&(n.beat=t.beat),typeof t.stepsPerBeat==`number`&&(n.stepsPerBeat=t.stepsPerBeat),t.chakraDay!==void 0&&(n.chakraDay=t.chakraDay),t.canonicalHash&&(n.canonicalHash=String(t.canonicalHash).toLowerCase()),t.kaiSignature&&(n.kaiSignature=t.kaiSignature),t.userPhiKey&&(n.userPhiKey=t.userPhiKey),t.transferNonce&&(n.transferNonce=t.transferNonce),Array.isArray(t.lineage)&&(n.lineage=t.lineage);let r=typeof n.stepsPerBeat==`number`&&Number.isFinite(n.stepsPerBeat)?n.stepsPerBeat:44,i=JT(t?.stepIndex),a=JT(n.stepIndex);return i===void 0?a===void 0?typeof n.pulse==`number`&&Number.isFinite(n.pulse)&&(n.stepIndex=L(n.pulse,r)):n.stepIndex=a:n.stepIndex=i,n}function QT(e,t){try{let n=new URL(e,window.location.origin),r=ZT(XT(n.searchParams.get(`p`)),t);return r.canonicalHash&&=String(r.canonicalHash).toLowerCase(),n.searchParams.set(`p`,AT(JSON.stringify(r))),n.toString()}catch{return e}}function $T(e,t,n){let r=[e?.canonicalHash,t,n?.matchedHash];for(let e of r)if(typeof e==`string`&&e.trim())return e.toLowerCase();return null}function eE(e,t){return typeof e==`string`&&e.trim()?e:typeof t?.transferNonce==`string`&&t.transferNonce.trim()?t.transferNonce:null}async function tE(e){let{stageEl:t,payload:n,localHash:r,routeHash:a,qr:o,onToast:s}=e;if(!t)return s(`No stage found`);try{let e=(await i(async()=>{let{default:e}=await import(`./html2canvas-Cts9xj26.js`).then(l(1));return{default:e}},__vite__mapDeps([4,5,2,3]))).default,u=await e(t,{backgroundColor:null}),d=document.createElement(`canvas`);d.width=bT,d.height=bT;let f=d.getContext(`2d`);if(!f)throw Error(`No canvas context`);f.clearRect(0,0,d.width,d.height);let p=Math.floor(bT*.06),m=bT-p*2,h=bT-p*2,g=u.width,_=u.height,v=Math.min(m/g,h/_),y=Math.floor(g*v),b=Math.floor(_*v),x=Math.floor((bT-y)/2),S=Math.floor((bT-b)/2);f.drawImage(u,x,S,y,b);let C=n?.chakraDay??`Throat`,w=jC[C]?.accent||`#00FFD0`,T=YC(C,typeof n?.stepPct==`number`?n.stepPct:n?n.pulse%11/11:0,r||void 0),E=Math.max(bT*.33,720),D=Math.max(bT*.08,160),O=Math.max(D*.24,30),k=bT-E-p,A=bT-D-p;f.save(),f.shadowColor=w,f.shadowBlur=Math.max(18,Math.floor(bT*.012));let j=f.createLinearGradient(0,A,0,A+D);j.addColorStop(0,`rgba(255,255,255,0.16)`),j.addColorStop(1,`rgba(255,255,255,0.05)`),c(f,k,A,E,D,O),f.fillStyle=j,f.fill(),f.shadowBlur=0,f.lineWidth=Math.max(2,Math.floor(bT*.0016)),f.strokeStyle=`rgba(255,255,255,0.18)`,f.stroke();let M=(n?.pulse??0).toLocaleString();f.textBaseline=`alphabetic`,f.fillStyle=T,f.font=`900 ${Math.floor(D*.48)}px Inter, ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica Neue, Arial`,f.shadowColor=T,f.shadowBlur=Math.max(16,Math.floor(bT*.008));let N=f.measureText(M).width,P=Math.floor(k+E/2-N/2),F=Math.floor(A+D/2+D*.18);f.fillText(M,P,F),f.restore();let I=Math.floor(bT*.32),L=Math.floor((bT-I)/2),ee=Math.floor((bT-I)/2),R=nE({provided:o.url,payload:n,localHash:r,routeHash:a}),z=(0,_w.renderToStaticMarkup)((0,J.jsx)(`svg`,{xmlns:`http://www.w3.org/2000/svg`,viewBox:`0 0 1000 1000`,children:(0,J.jsx)(Ww,{uid:o.uid,url:R,size:800,phaseHue:o.hue,phaseColor:o.accent,animate:!1,pulseMs:5236})})),te=new Blob([z],{type:`image/svg+xml;charset=utf-8`}),ne=URL.createObjectURL(te);await new Promise((e,t)=>{let n=new Image;n.onload=()=>{try{f.drawImage(n,L,ee,I,I)}finally{URL.revokeObjectURL(ne),e()}},n.onerror=e=>{URL.revokeObjectURL(ne),t(e)},n.src=ne});let re=d.toDataURL(`image/png`),B=document.createElement(`a`);B.href=re,B.download=`sigil_poster_${(r||a||`mint`).slice(0,16)}.png`,document.body.appendChild(B),B.click(),B.remove(),s(`Public key PNG saved`)}catch(e){console.error(e),s(`Poster export failed`)}function c(e,t,n,r,i,a){e.beginPath(),e.moveTo(t+a,n),e.lineTo(t+r-a,n),e.quadraticCurveTo(t+r,n,t+r,n+a),e.lineTo(t+r,n+i-a),e.quadraticCurveTo(t+r,n+i,t+r-a,n+i),e.lineTo(t+a,n+i),e.quadraticCurveTo(t,n+i,t,n+i-a),e.lineTo(t,n+a),e.quadraticCurveTo(t,n,t+a,n),e.closePath()}}function nE(e){let{provided:t,payload:n,localHash:r,routeHash:i}=e,a=t&&rE(t)?t:(typeof window<`u`?window.location.href:``)||``;if(!n)return a;try{let e=(n.canonicalHash||r||i||``).toLowerCase();if(!e)return a;let t=new URL(a,typeof window<`u`?window.location.origin:`https://local.test`);t.pathname=`/s/${e}`;let o=n.transferNonce||t.searchParams.get(`t`);o&&t.searchParams.set(`t`,o);let s=`${t.pathname}${t.search}${t.hash}`;return QT(s,n)||s}catch{return a}}function rE(e){try{let t=new URL(e,typeof window<`u`?window.location.origin:`https://local.test`);return t.protocol===`http:`||t.protocol===`https:`}catch{return!1}}function iE(e){let t=JSON.stringify(e);return btoa(unescape(encodeURIComponent(t))).replace(/\+/g,`-`).replace(/\//g,`_`).replace(/=+$/g,``)}function aE(e,t,n){let r=new URL(e,typeof window<`u`?window.location.origin:`http://localhost`);return r.searchParams.set(`p`,iE(t)),n&&r.searchParams.set(`t`,n),r.toString()}function oE(e){switch(String(e??``).trim().toLowerCase()){case`root`:return`Root`;case`sacral`:return`Sacral`;case`solar plexus`:case`solar_plexus`:case`solar-plexus`:return`Solar Plexus`;case`heart`:return`Heart`;case`throat`:return`Throat`;case`third eye`:case`third_eye`:case`third-eye`:return`Third Eye`;case`crown`:return`Crown`;default:return`Root`}}function sE(e,t){let n={pulse:e.pulse,beat:e.beat,chakraDay:oE(e.chakraDay),stepsPerBeat:e.stepsPerBeat??void 0,stepIndex:t,userPhiKey:e.userPhiKey??void 0,kaiSignature:e.kaiSignature??void 0,canonicalHash:e.canonicalHash??void 0,transferNonce:e.transferNonce??void 0,expiresAtPulse:e.expiresAtPulse??void 0,claimExtendUnit:e.claimExtendUnit??void 0,claimExtendAmount:e.claimExtendAmount??void 0,attachment:e.attachment??void 0,provenance:e.provenance??void 0};return Object.keys(n).forEach(e=>{n[e]===void 0&&delete n[e]}),n}function cE(e){return{pulse:e.pulse,beat:e.beat,stepIndex:e.stepIndex,chakraDay:oE(e.chakraDay),stepsPerBeat:e.stepsPerBeat??void 0,userPhiKey:e.userPhiKey??void 0,kaiSignature:e.kaiSignature??void 0}}function lE(e,t){e.setAttribute(`data-share-url`,t),e.querySelectorAll(`a`).forEach(e=>{e.setAttribute(`href`,t);try{e.setAttributeNS(`http://www.w3.org/1999/xlink`,`xlink:href`,t)}catch{}});let n=/\bu=([^·\n\r]+?)(?=\s*·|$)/;e.querySelectorAll(`text`).forEach(e=>{let r=e.textContent||``;n.test(r)&&(e.textContent=r.replace(n,`u=${t}`))})}async function uE(e){let{expired:t,exporting:n,setExporting:r,svgEl:a,payload:o,isFutureSealed:s,linkStatus:c,setToast:l,expiryUnit:u,expiryAmount:d,localHash:f,routeHash:p,transferToken:m,getKaiPulseEternalInt:h,stepIndexFromPulse:g,STEPS_PER_BEAT:_}=e;if(t)return HC(l,`Seal window closed`);if(!n){if(!a)return HC(l,`No SVG found`);if(!o)return HC(l,`No payload`);if(s)return HC(l,`Opens after the moment—claim unlocks then`);if(c!==`active`)return HC(l,`Archived link — cannot claim from here`);try{r(!0);let e=`sigil_${(f||p||`mint`).slice(0,16)}`,t=o.stepsPerBeat??_,n=g(o.pulse,t),s=h(new Date),c=g(s,t),v=sE(o,n),y={...wC(o.userPhiKey||``,o.kaiSignature??void 0,v,`claim`,o.attachment?.name??void 0,s),stepIndex:n,atStepIndex:c},x={...o,exportedAtPulse:s,stepIndex:n,stepsPerBeat:t,provenance:[...o.provenance??[],y],claimExtendUnit:o.claimExtendUnit??u,claimExtendAmount:o.claimExtendAmount??d,canonicalHash:(f||o.canonicalHash||p||null)?.toString()??null},S=await tw(aw(x.pulse,x.beat,n,String(x.chakraDay??``),ow(sE(x,n)))),C=await iw(S),w={...x,kaiSignature:S,userPhiKey:x.userPhiKey||C},T=(f||p||``).toLowerCase(),E=cE({pulse:w.pulse,beat:w.beat,stepIndex:n,chakraDay:w.chakraDay??null,stepsPerBeat:t,userPhiKey:w.userPhiKey??null,kaiSignature:w.kaiSignature??null}),D=aE(b(T,E),E,w.transferNonce??m??void 0),{putMetadata:O}=await i(async()=>{let{putMetadata:e}=await import(`./svgMeta-DgHerpdT.js`);return{putMetadata:e}},__vite__mapDeps([6,7,2,3])),k={...w,stepsPerBeat:t,shareUrl:D,fullUrl:D};O(a,k);try{a.setAttribute(`data-step-index`,String(n));let e=a.querySelector(`metadata#sigil-display`);e||(e=document.createElementNS(`http://www.w3.org/2000/svg`,`metadata`),e.setAttribute(`id`,`sigil-display`),e.setAttribute(`data-noncanonical`,`1`),a.appendChild(e)),e.textContent=JSON.stringify({stepIndex:n,stepsPerBeat:t})}catch{console.debug(`Display metadata write failed`)}fw(a,w.pulse,w.beat,n),lw(a),lE(a,D);let A=null,j=null;try{let e=new URL(D);A=e.searchParams.get(`p`),j=e.searchParams.get(`t`)}catch{console.debug(`URL parse failed`)}let M=await wT(a,yT,{metaOverride:k,addQR:!1,addPulseBar:!1,title:`Kairos Sigil-Glyph — Sealed KairosMoment`,desc:`Deterministic sigil-glyph with sovereign metadata. Exported as archived key.`}),N=await TT(M,yT),P=new(await(UC()));P.file(`${e}.svg`,M),P.file(`${e}.png`,N);let F={hash:f||p||``,canonicalHash:w.canonicalHash??null,pulse:w.pulse,beat:w.beat,stepIndex:n,atStepIndex:c,chakraDay:w.chakraDay??null,userPhiKey:w.userPhiKey??null,kaiSignature:w.kaiSignature??null,transferNonce:w.transferNonce??null,expiresAtPulse:w.expiresAtPulse??null,exportedAtPulse:w.exportedAtPulse??null,claimedAtPulse:s,overlays:{qr:!1,eternalPulseBar:!1},claimExtendUnit:w.claimExtendUnit??null,claimExtendAmount:w.claimExtendAmount??null,fullUrl:D,p:A,urlQuery:{p:A,t:j}};P.file(`${e}.manifest.json`,JSON.stringify(F,null,2));let I=await P.generateAsync({type:`blob`}),L=URL.createObjectURL(I),ee=document.createElement(`a`);ee.href=L,ee.download=`${e}.zip`,document.body.appendChild(ee),ee.click(),ee.remove(),requestAnimationFrame(()=>URL.revokeObjectURL(L)),HC(l,`Access key generated`)}catch(e){console.error(e),HC(l,`Claim failed`)}finally{r(!1)}}}function dE(){return(0,q.useMemo)(()=>async e=>{let t=new TextEncoder().encode(e),n=await crypto.subtle.digest(`SHA-256`,t);return Array.from(new Uint8Array(n)).map(e=>e.toString(16).padStart(2,`0`)).join(``)},[])}function fE({payload:e,urlSearchParams:t,currentPulse:n}){let[r,i]=(0,q.useState)(null),[a,o]=(0,q.useState)(null),[s,c]=(0,q.useState)(null),l=(0,q.useRef)(null),u=(0,q.useRef)(null),d=dE(),f=t?.get(`vpol`)??``;(0,q.useEffect)(()=>{let t=!0;return(async()=>{if(!e||!Number.isFinite(n??NaN)){if(!t)return;i(e=>e===null?e:null),o(e=>e===null?e:null),c(e=>e===null?e:null),l.current=null,u.current=null;return}let{seal:r}=await k({pulse:e.pulse,kaiPulse:e.pulse,beat:e.beat,stepIndex:e.stepIndex,stepsPerBeat:e.stepsPerBeat,seriesSize:e.seriesSize,quality:e.quality,creatorVerified:e.creatorVerified,creatorRep:e.creatorRep,frequencyHz:e.frequencyHz,chakraDay:e.chakraDay,chakraGate:e.chakraGate,transfers:e.transfers,cumulativeTransfers:e.cumulativeTransfers,segments:e.segments,segmentsMerkleRoot:e.segmentsMerkleRoot,transfersWindowRoot:e.transfersWindowRoot,ip:e.ip,kaiSignature:e.kaiSignature,userPhiKey:e.userPhiKey,valuationPolicyId:f||void 0},n,d);if(!t)return;u.current!==r.stamp&&(i(e=>e&&e.stamp===r.stamp?e:r),u.current=r.stamp);let a=r.valuePhi,s=l.current;s!==a&&(o(e=>e===a?e:a),s!=null&&Math.abs(a-s)>1e-9?c(e=>e===`up`&&a>s?e:a>s?`up`:`down`):c(e=>e===null?e:null),l.current=a)})(),()=>{t=!1}},[e,n,f,d]);let p=(0,q.useMemo)(()=>e?.pulse,[e]),m=(0,q.useMemo)(()=>Number.isFinite(p??NaN)?{score:P(p),lines:C(p)}:{score:null,lines:[]},[p]),h=(0,q.useMemo)(()=>{if(!Number.isFinite(p??NaN)||!Number.isFinite(n??NaN))return null;let t=r?.inputs?.pulsesPerBeat?Math.max(1,Math.round(r.inputs.pulsesPerBeat/11)):e?.stepsPerBeat??44,i=r?.inputs?.cadenceRegularity??1,a=r?.inputs?.resonancePhi??.5,o=e?.stepIndex;return N(p,n,{stepsPerBeat:t,cadenceRegularity:i,resonancePhi:a,stepIndexClaimOverride:o})},[p,n,r,e]),g=(0,q.useMemo)(()=>{let t=e?.transfers;return!t||!t.length?[`No closed transfers yet — lineage still forming.`]:A(t,{stepsPerBeat:e?.stepsPerBeat??44})},[e]);return{valSeal:r,livePrice:a,priceFlash:s,rarity:m,oscillation:h,lineageNarrative:g,trust:(0,q.useMemo)(()=>r?S(r.inputs):null,[r]),marketTier:(0,q.useMemo)(()=>Number.isFinite(p??NaN)?M(p,r??void 0):null,[p,r]),kairos:(0,q.useMemo)(()=>Number.isFinite(n??NaN)?{window:O(n,144,1,{stepsPerBeat:e?.stepsPerBeat??44})}:{window:[]},[n,e]),visuals:(0,q.useMemo)(()=>{if(!r||!Number.isFinite(p??NaN))return{spiralSVG:null,scrollSVG:null,scrollText:null,scrollHTML:null};let e=w(p),{scrollSVG:t,scrollText:n}=E(r,{title:`Kai-Sigil Valuation Scroll`});return{spiralSVG:e,scrollSVG:t,scrollText:n,scrollHTML:T(r,{title:`Kai-Sigil Valuation Scroll`})}},[r,p]),audio:(0,q.useMemo)(()=>{if(!Number.isFinite(p??NaN))return{dataURI:null,renderWav:void 0};let{dataURI:e}=j(p,2,44100,{stereo:!0});return{dataURI:e,renderWav:(e=2,t=44100,n)=>j(p,e,t,n)}},[p]),motifSimilarityWith:(0,q.useMemo)(()=>e=>!Number.isFinite(e??NaN)||!Number.isFinite(p??NaN)?null:D(p,e),[p]),helpers:(0,q.useMemo)(()=>({explainRarity:()=>m.lines,explainLineage:()=>g,scanKairos:(t,n,r=1,i)=>O(t,n,r,{stepsPerBeat:i??e?.stepsPerBeat??44}),makeScroll:e=>r?E(r,{title:e??`Kai-Sigil Valuation Scroll`}):null,makeScrollHTML:e=>r?T(r,{title:e}):null,makeSpiral:e=>Number.isFinite(e??p)?w(e??p):null}),[m.lines,g,e,r,p])}}function pE(e){let{stageId:t,payload:n,localHash:r,setOgImgUrl:i,setMeta:a,seoTitle:o,seoDesc:s}=e,c=!1,l=null,u=async()=>{let e=document.getElementById(t);if(!e||!n){i(null),a(`property`,`og:image`,``),a(`property`,`og:image:alt`,``),a(`property`,`og:image:width`,``),a(`property`,`og:image:height`,``),a(`name`,`twitter:image`,``);return}try{let t=n.chakraDay??`Throat`,l=jC[t]?.accent||`#00FFD0`,u=n.pulse||0,f=n.stepsPerBeat??44,p=Math.floor(n.pulse%(f*11)/11),m=YC(t,typeof n.stepPct==`number`?n.stepPct:n.pulse%11/11,r||void 0),h=`Pulse ${u.toLocaleString()} • Beat ${n.beat}/36 • Step ${p+1}/${f} • ${t}`,g=await(0,me.default)(e),_=document.createElement(`canvas`);_.width=xT,_.height=630;let v=_.getContext(`2d`);if(!v)throw Error(`Canvas unsupported`);let y=v.createLinearGradient(0,0,xT,630);y.addColorStop(0,`rgba(0,0,0,0.92)`),y.addColorStop(1,`rgba(0,0,0,0.70)`),v.fillStyle=y,v.fillRect(0,0,xT,630),v.save(),v.globalCompositeOperation=`lighter`;let b=v.createRadialGradient(xT*.8,630*.2,20,xT*.8,630*.2,600);b.addColorStop(0,`${l}CC`),b.addColorStop(1,`rgba(0,0,0,0)`),v.fillStyle=b,v.beginPath(),v.arc(xT*.8,630*.2,600,0,Math.PI*2),v.fill(),v.restore();let x=Math.floor(xT*.52),S=Math.min(x/g.width,558/g.height),C=Math.floor(g.width*S),w=Math.floor(g.height*S),T=36+Math.floor((x-C)/2),E=36+Math.floor((558-w)/2);v.drawImage(g,T,E,C,w);let D=36+x+32,O=xT-D-36;v.fillStyle=`#EAFBFF`,v.font=`700 38px Inter, ui-sans-serif, -apple-system, Segoe UI, Roboto`,v.fillText(`Kairos Sigil-Glyph — Sealed Kairos Moment`,D,94),v.fillStyle=`rgba(255,255,255,0.82)`,v.font=`400 24px Inter, ui-sans-serif, -apple-system, Segoe UI, Roboto`,d(v,`“${o}” — ${s}`,D,136,O,30);let k=`${u.toLocaleString()}`;v.textBaseline=`alphabetic`,v.font=`900 120px Inter, ui-sans-serif, -apple-system, Segoe UI, Roboto`,v.shadowColor=m,v.shadowBlur=20,v.fillStyle=m;let A=v.measureText(k).width,j=D+Math.floor((O-A)/2);v.fillText(k,j,554),v.shadowBlur=0;let M=_.toDataURL(`image/png`);if(c)return;i(M),a(`property`,`og:image`,M),a(`property`,`og:image:alt`,h),a(`property`,`og:image:type`,`image/png`),a(`property`,`og:image:width`,`1200`),a(`property`,`og:image:height`,`630`),a(`name`,`twitter:image`,M)}catch{if(c)return;i(null)}};return l=WC(()=>{c||u()}),()=>{c=!0,l!=null&&GC(l)};function d(e,t,n,r,i,a){let o=t.split(` `),s=``;for(let t=0;t<o.length;t++){let c=s+o[t]+` `;e.measureText(c).width>i&&t>0?(e.fillText(s,n,r),s=o[t]+` `,r+=a):s=c}e.fillText(s.trim(),n,r)}}function mE(e){switch(String(e??``).trim().toLowerCase()){case`root`:case`earth`:case`earth gate`:return`Root`;case`sacral`:return`Sacral`;case`solar plexus`:case`solar_plexus`:case`solar-plexus`:return`Solar Plexus`;case`heart`:return`Heart`;case`throat`:return`Throat`;case`third eye`:case`third_eye`:case`third-eye`:return`Third Eye`;case`crown`:return`Crown`;default:return`Root`}}function hE(){return crypto.getRandomValues(new Uint32Array(4)).join(``)}function gE(e){let{meta:t,stepIndex:n,stepsPerBeat:r}=e;return{pulse:t.pulse,beat:t.beat,stepIndex:n,chakraDay:mE(t.chakraDay),stepsPerBeat:r,userPhiKey:t.userPhiKey??void 0,kaiSignature:t.kaiSignature??void 0}}function _E(e,t,n){let r=e.stepIndex;return typeof r==`number`&&Number.isFinite(r)&&r>=0&&r<t&&Math.floor(r)===r?r:n.stepIndexFromPulse(e.pulse,t)}function vE(e,t,n){let r=(e.canonicalHash??n.localHash??n.routeHash??``).toLowerCase();if(!r)return null;let i=t??hE(),a=e.stepsPerBeat??n.stepsPerBeat,o=_E(e,a,n),s=gE({meta:e,stepIndex:o,stepsPerBeat:a});return{url:QT(aE(b(r,s),s,i),{pulse:e.pulse,beat:e.beat,stepsPerBeat:a,stepIndex:o,chakraDay:mE(e.chakraDay),canonicalHash:r,kaiSignature:e.kaiSignature??void 0,userPhiKey:e.userPhiKey??void 0,transferNonce:i,expiresAtPulse:e.expiresAtPulse??void 0,claimExtendUnit:e.claimExtendUnit??void 0,claimExtendAmount:e.claimExtendAmount??void 0}),token:i}}function yE(e,t,n){let r=n.getKaiPulseEternalInt(new Date)+n.breathsToPulses(11),i=hE(),a={...e,canonicalHash:t,transferNonce:i,expiresAtPulse:r,claimExtendUnit:`breaths`,claimExtendAmount:11},o=n.shareTransferLink(a,i,{localHash:n.localHash,routeHash:n.routeHash,stepsPerBeat:n.stepsPerBeat,stepIndexFromPulse:n.stepIndexFromPulse});if(!o?.url)return null;t&&i&&n.publishRotation([t],i);try{n.navigate(o.url)}catch{try{window.location.href=o.url}catch{}}return o.url}var bE=[`canonicalHash`,`token`,`expiresAtPulse`,`issuedAt`,`version`],xE=e=>JSON.stringify({canonicalHash:e.canonicalHash,token:e.token,expiresAtPulse:e.expiresAtPulse,issuedAt:e.issuedAt,version:e.version},bE),SE=e=>btoa(String.fromCharCode(...e)).replace(/\+/g,`-`).replace(/\//g,`_`).replace(/=+$/g,``);const CE=e=>SE(new TextEncoder().encode(xE(e)));async function wE(e){try{let t=await fetch(`/api/sign-claim`,{method:`POST`,headers:{"content-type":`text/plain;charset=UTF-8`},body:xE(e)});if(!t.ok)return null;let n=await t.json();return!n||!n.s||!n.kid?null:{r:n.r??CE(e),s:n.s,kid:n.kid}}catch{return null}}function TE(e,t,n,r){e.searchParams.set(`r`,t),e.searchParams.set(`s`,n),e.searchParams.set(`kid`,r)}function EE(e,t,n,r){K(e,{registryClaim:CE(t),registrySig:n,registryKid:r})}function DE(e,t,n){return{canonicalHash:t.toLowerCase(),token:n,expiresAtPulse:e.expiresAtPulse??null,issuedAt:Math.floor(Date.now()/1e3),version:1}}function OE(){if(typeof window>`u`||typeof document>`u`){let e=()=>{},t=()=>{};return{openModal:t,closeModal:t,disable:e,teardown:e,destroy:e}}let e=document,t=e.body,n=[`.sp-breathproof__backdrop`,`.stargate-overlay`,`.valuechart-backdrop`,`.sp-modal`,`.ownership-overlay`],r={".sp-breathproof__backdrop":`.sp-breathproof`,".valuechart-backdrop":`.valuechart`,".ownership-overlay":`.ownership-panel`,".stargate-overlay":`.stargate-content, .stargate-frame, .stargate__content`,".sp-modal":`.sp-modal__content, .sp-modal__card, .sp-card`},i={capture:!0,passive:!1},a={capture:!0},o=0,s=0,c=0,l=``,u=``,d=``,f=``,p=``,m=()=>{o===0&&(s=window.scrollY||e.documentElement.scrollTop||0,c=window.scrollX||e.documentElement.scrollLeft||0,l=t.style.top,u=t.style.left,d=t.style.width,f=t.style.position,p=t.style.overflow,t.style.position=`fixed`,t.style.top=`-${s}px`,t.style.left=`-${c}px`,t.style.width=`100%`,t.style.overflow=`hidden`,t.classList.add(`modal-open`,`bp-open`)),o++},h=()=>{o=Math.max(0,o-1),!(o>0)&&(t.style.position=f,t.style.top=l,t.style.left=u,t.style.width=d,t.style.overflow=p,requestAnimationFrame(()=>{window.scrollTo(c,s)}),t.classList.remove(`modal-open`),t.classList.remove(`bp-open`))},g=e=>{if(!e)return!1;let t=window.getComputedStyle(e);return!(t.display===`none`||t.visibility===`hidden`||e.hasAttribute(`hidden`))},_=()=>{let t=[];return n.forEach(n=>{e.querySelectorAll(n).forEach(e=>{g(e)&&t.push(e)})}),t},v=t=>{if(!t)return null;let r=t;for(;r&&r!==e.documentElement;){for(let e of n)if(r.matches(e))return r;r=r.parentElement}return null},y=(e,t)=>{if(!e||!t)return!1;let i=n.find(t=>e.matches(t))||``,a=i?r[i]:``;return a&&e.querySelector(a)?!t.closest(a):t===e},b=()=>{_().length>0?m():h()},x=e=>{e&&(e.classList.add(`is-open`),e.removeAttribute(`hidden`),b())},S=e=>{e&&(e.classList.remove(`is-open`),e.setAttribute(`hidden`,``),b())},C=e=>{let t=e.target;if(!t)return;let n=t.closest(`.sp-breathproof__close, .stargate-exit, .sp-modal__close, .sealmoment__close, [data-modal-close], [data-dismiss="modal"], button[aria-label="Close"], button[aria-label="close"]`);if(n){let t=v(n);t&&(S(t),e.preventDefault(),e.stopPropagation());return}let r=v(t);if(r&&y(r,t)&&r.getAttribute(`data-backdrop-dismiss`)!==`false`){S(r),e.preventDefault(),e.stopPropagation();return}},w=e=>{if(_().length===0)return;let t=e.target;if(!t)return;let n=t.closest(`[data-scroll], .sp-breathproof, .valuechart, .ownership-panel, .sp-modal__content, .sp-card, .stargate-content`);if(!n){e.preventDefault(),e.stopPropagation();return}if(!(n.scrollHeight>n.clientHeight)){e.preventDefault(),e.stopPropagation();return}},T=e=>{if(e.key!==`Escape`)return;let t=_();if(t.length===0)return;let n=t[t.length-1];n.getAttribute(`data-escape-dismiss`)!==`false`&&(S(n),e.preventDefault(),e.stopPropagation())};e.addEventListener(`click`,C,i),e.addEventListener(`pointerup`,C,i),e.addEventListener(`touchend`,C,i),e.addEventListener(`touchmove`,w,i),e.addEventListener(`keydown`,T,i),b();let E=()=>{e.removeEventListener(`click`,C,a),e.removeEventListener(`pointerup`,C,a),e.removeEventListener(`touchend`,C,a),e.removeEventListener(`touchmove`,w,a),e.removeEventListener(`keydown`,T,a);try{o=1,h()}catch{}};return{openModal:x,closeModal:S,disable:E,teardown:E,destroy:E}}var kE=n(g(),1),AE=1e-9,jE=`sigil-sendlock-v1`,ME=(e,t)=>`sigil:sendlock:${e}:t:${t}`,NE=15e3,PE=()=>Date.now(),FE={"--phi-url":`url(/assets/phi.svg)`},IE=e=>{try{return new URL(e,window.location.origin).toString()}catch{return e}},LE=(e,t)=>{let n=crypto.getRandomValues(new Uint32Array(4)).join(``);if(!e||!t)return{ok:!1,id:n};let r=ME(e.toLowerCase(),t);try{let i=localStorage.getItem(r),a=i?JSON.parse(i):null,o=!a||!Number.isFinite(a.at)||PE()-a.at>NE;if(!a||o){localStorage.setItem(r,JSON.stringify({id:n,at:PE()}));try{let r=new BroadcastChannel(jE),i={type:`lock`,canonical:e.toLowerCase(),token:t,id:n,at:PE()};r.postMessage(i),r.close()}catch{}return{ok:!0,id:n}}}catch{}return{ok:!1,id:n}},RE=(e,t,n)=>{if(!e||!t)return;let r=ME(e.toLowerCase(),t);try{let i=localStorage.getItem(r),a=i?JSON.parse(i):null;if(!a||a.id===n){localStorage.removeItem(r);try{let r=new BroadcastChannel(jE),i={type:`unlock`,canonical:e.toLowerCase(),token:t,id:n,at:PE()};r.postMessage(i),r.close()}catch{}}}catch{}},zE=e=>{if(!e||typeof e!=`object`)return!1;let t=e;return typeof t.amount==`number`&&Number.isFinite(t.amount)&&t.amount>0&&typeof t.nonce==`string`&&t.nonce.length>0&&typeof t.timestamp==`number`&&Number.isFinite(t.timestamp)&&(typeof t.recipientPhiKey==`string`||t.recipientPhiKey===void 0)},BE=e=>{if(!Array.isArray(e))return 0;let t=0;for(let n of e)zE(n)&&(t+=n.amount);return t},VE=e=>[...e].sort((e,t)=>{let n=(e.timestamp||0)-(t.timestamp||0);return n===0?e.nonce.localeCompare(t.nonce):n}),HE=e=>{let t=new Set,n=[];for(let r of e)zE(r)&&(t.has(r.nonce)||(t.add(r.nonce),n.push(r)));return n},UE=e=>{let t=typeof e.originalAmount==`number`&&Number.isFinite(e.originalAmount)?e.originalAmount:NaN,n=VE(Array.isArray(e.debits)?HE(e.debits):[]);if(!Number.isFinite(t))return{originalAmount:e.originalAmount,debits:n.length?n:void 0};let r=[],i=0;for(let e of n)zE(e)&&i+e.amount<=t+AE&&(r.push(e),i+=e.amount);return{originalAmount:t,debits:r.length?r:void 0}},WE=e=>e===`breaths`||e===`steps`,GE=`sigil-lineage-v1`,KE=(e,t)=>t?`sigil:desc:${e}:t:${t}`:`sigil:desc:${e}`,qE=`sigil-xfer-v1`,JE=e=>`sigil:rotated:${e}`,YE=(e,t)=>{Array.from(new Set(e.map(e=>e.toLowerCase()).filter(Boolean))).forEach(e=>{try{localStorage.setItem(JE(e),`${t}@${Date.now()}`)}catch{}try{let n=new BroadcastChannel(qE);n.postMessage({type:`rotated`,canonical:e,token:t}),n.close()}catch{}try{window.dispatchEvent(new CustomEvent(`sigil:transfer-rotated`,{detail:{canonical:e,token:t}}))}catch{}})};function XE(e,t){let n=(e||``).toLowerCase();if(!n||!t)return[];try{let e=localStorage.getItem(KE(n,t));if(!e)return[];let r=JSON.parse(e);return Array.isArray(r)?r:[]}catch{return[]}}function ZE(e,t,n){let r=(e||``).toLowerCase();if(!(!r||!t))try{localStorage.setItem(KE(r,t),JSON.stringify(n||[]))}catch{}}function QE(e,t,n){try{let r=new BroadcastChannel(GE),i={type:`descendants`,canonical:e.toLowerCase(),token:t,list:n,stamp:Date.now()};r.postMessage(i),r.close()}catch{}}function $E(){let{hash:e}=m(),t=h(),n=o(),r=(e??``).toLowerCase(),i=(0,q.useMemo)(()=>new URLSearchParams(t.search),[t.search]),a=i.get(`t`),[s,c]=(0,q.useState)(`checking`),[l,u]=(0,q.useState)(`checking`),[d,f]=(0,q.useState)(!1),[p,g]=(0,q.useState)(`Awaiting Proof Of Breath™`),[v,y]=(0,q.useState)(``),[b,S]=(0,q.useState)(320),C=(0,q.useRef)(null),{payload:w,setPayload:T,loading:E,setLoading:D}=BC(t.search),O=w,{pulse:k,msToNextPulse:A}=NC(),[j,M]=(0,q.useState)(null),[N,P]=(0,q.useState)(null),[z,te]=(0,q.useState)(!1),[ne,re]=(0,q.useState)(``),[B,ie]=(0,q.useState)(``),[ce,le]=(0,q.useState)(`breaths`),[ue,U]=(0,q.useState)(44),[W,de]=(0,q.useState)(``),[fe,me]=(0,q.useState)(!1),ve=(0,q.useRef)(``),ye=(0,q.useMemo)(()=>r?`sigil:legacy-upgraded:${r}`:``,[r]),[be,xe]=(0,q.useState)(!1),[Se,Ce]=(0,q.useState)(!1);(0,q.useEffect)(()=>{if(ye)try{Ce(localStorage.getItem(ye)===`1`)}catch{}},[ye]);let we=(0,q.useCallback)(()=>{if(ye){try{localStorage.setItem(ye,`1`)}catch{}Ce(!0),HC(y,`Upgraded — legacy link locked`)}},[ye]),[Te,Ee]=(0,q.useState)(!1),[De,Oe]=(0,q.useState)(``),[ke,Ae]=(0,q.useState)(``),[je,Me]=(0,q.useState)(`checking`),[Ne,Pe]=(0,q.useState)(null);(0,q.useEffect)(()=>{let e=Array.from(new Set([O?.canonicalHash,r,W].filter(Boolean).map(e=>e.toLowerCase())));if(e.length===0)return;let t=()=>{let t=null;try{for(let n of e){let e=localStorage.getItem(JE(n)),r=e?String(e).split(`@`)[0]:null;if(r){t=r;break}}}catch{}Pe(t)};t();let n=null;try{n=new BroadcastChannel(qE),n.onmessage=t=>{let n=t.data;if(n?.type===`rotated`){let t=(n.canonical||``).toLowerCase();e.includes(t)&&Pe(n.token||null)}}}catch{}let i=n=>{if(n.key){for(let r of e)if(n.key===JE(r)){t();break}}};return window.addEventListener(`storage`,i,{passive:!0}),()=>{if(window.removeEventListener(`storage`,i),n&&typeof n.close==`function`)try{n.close()}catch{}}},[O?.canonicalHash,r,W]);let Fe=(0,q.useCallback)(async(e,t,n,r,i)=>{try{let a=DE(e,t,n),o=await wE(a);if(!o)return r;let s=new URL(r,window.location.origin);return TE(s,o.r,o.s,o.kid),i&&EE(i,a,o.s,o.kid),s.toString()}catch{return r}},[]);(0,q.useEffect)(()=>{let e=null;try{e=new BroadcastChannel(jE),e.onmessage=()=>{}}catch{}return()=>{if(e&&typeof e.close==`function`)try{e.close()}catch{}}},[]),(0,q.useEffect)(()=>{let e=OE();return()=>{e.destroy?.(),e.teardown?.(),e.disable?.()}},[]);let[Ie,ze]=(0,q.useState)(0),[Be,Ve]=(0,q.useState)(!1),[He,Ue]=(0,q.useState)(null),We=(0,q.useMemo)(()=>{let e=[O?.canonicalHash,W,j?.canonicalHash,He?.matchedHash].filter(Boolean).map(e=>e.toLowerCase());return Array.from(new Set(e))},[O?.canonicalHash,W,j?.canonicalHash,He]);(0,q.useLayoutEffect)(()=>{pw()},[]),(0,q.useEffect)(()=>{let e=jC[O?.chakraDay??`Throat`]??{hue:180,accent:`#00FFD0`},t=document.querySelector(`.sigilpage`);t&&(t.style.setProperty(`--crystal-hue`,String(e.hue)),t.style.setProperty(`--crystal-accent`,e.accent))},[O?.chakraDay]);let[Ge,Ke]=(0,q.useState)(null),{valSeal:qe,livePrice:Je,priceFlash:Ye}=fE({payload:O,urlSearchParams:i,currentPulse:k,routeHash:r}),Xe=i.get(`h`)??``;(0,q.useEffect)(()=>{if(!Xe){Ke(e=>e===null?e:null);return}try{let e=_(ZC(Xe.trim()));Ke(t=>Array.isArray(t)&&Array.isArray(e)&&t.length===e.length&&t.every((t,n)=>t===e[n])?t:e)}catch{Ke(e=>e===null?e:null)}},[Xe]);let Ze=(0,q.useCallback)((e,t)=>{let n=e.stepsPerBeat??44,r=t.stepsPerBeat??44,i=L(e.pulse,n),a=L(t.pulse,r);return e.pulse===t.pulse&&e.beat===t.beat&&i===a&&e.chakraDay===t.chakraDay},[]),Qe=(0,q.useMemo)(()=>typeof window<`u`?new URL(window.location.href).toString():`${`/s/${encodeURIComponent(e??``)}`}${t.search||``}${t.hash||``}`,[e,t.search,t.hash]),$e=(0,q.useMemo)(()=>e?e.slice(0,16):`—`,[e]),et=(0,q.useCallback)(async(e,t=`Copied`)=>{try{return await navigator.clipboard.writeText(e),HC(y,t),!0}catch{return HC(y,`Copy failed`),!1}},[]),tt=(0,q.useCallback)(async()=>{try{let e=navigator;typeof e?.share==`function`?(await e.share({title:`Kairos Sigil-glyph`,text:`Sealed Kairos Moment`,url:Qe}),HC(y,`Share sheet opened`)):await et(Qe,`Link copied`)}catch{}},[Qe,et]);(0,q.useEffect)(()=>{let e=Date.now(),t=(r||``).toLowerCase();if(Ie>e||!t||We.length===0)return;let n=We.includes(t),i=l,a=s;!n&&W&&t!==W&&!He||!n&&(He||je===`archived`)?i=`authentic`:(i=n?`authentic`:`forged`,s!==`verified`&&(a=n?`ok`:`mismatch`)),i!==l&&u(i),a!==s&&c(a)},[We,r,je,Ie,He,W,l,s]);let[nt,rt]=(0,q.useState)(null),it=(0,q.useDeferredValue)(O),at=(0,q.useMemo)(()=>{let t=it?.stepsPerBeat??44,n=it?L(it.pulse,t):0,r=it?.chakraDay??`Throat`,i=(it?.userPhiKey??``).slice(0,12),a=(it?.pulse??0).toLocaleString();return{title:`Kai Sigil — ${e?e.slice(0,16):`—`}`,desc:it?`Sealed Sigil-Glyph • Pulse ${a} • Beat ${it.beat}/36 • Step ${n+1}/${t} • ${r}${i?` • Owner ${i}…`:``}.`:`Sealed Sigil-Glyph`}},[it,e]);(0,q.useEffect)(()=>{let e=Qe;document.title=at.title;let t=kC(`canonical`);t.href=e,DC(`name`,`theme-color`,jC[O?.chakraDay??`Throat`]?.accent||`#00FFD0`),DC(`property`,`og:title`,at.title),DC(`property`,`og:description`,at.desc),DC(`property`,`og:type`,`website`),DC(`property`,`og:url`,e),DC(`name`,`twitter:card`,`summary_large_image`),DC(`name`,`twitter:title`,at.title),DC(`name`,`twitter:description`,at.desc),DC(`property`,`og:site_name`,`Kairos Harmonik Kingdom`);let n=O?.stepsPerBeat??44,r=O?L(O.pulse,n):0,i=O,a=O??{},o={"@context":`https://schema.org`,"@type":`VisualArtwork`,name:at.title,description:at.desc,url:e,image:nt||void 0,genre:`Sigil-Glyph`,identifier:[{"@type":`PropertyValue`,name:`pulse`,value:O?.pulse??null},{"@type":`PropertyValue`,name:`beat`,value:O?.beat??null},{"@type":`PropertyValue`,name:`stepIndex`,value:r},{"@type":`PropertyValue`,name:`stepsPerBeat`,value:n},{"@type":`PropertyValue`,name:`chakraDay`,value:O?.chakraDay??null},{"@type":`PropertyValue`,name:`userPhiKey`,value:O?.userPhiKey??null},{"@type":`PropertyValue`,name:`kaiSignature`,value:O?.kaiSignature??null},{"@type":`PropertyValue`,name:`canonicalHash`,value:(O?.canonicalHash??W)||null},{"@type":`PropertyValue`,name:`expiresAtPulse`,value:O?.expiresAtPulse??null},{"@type":`PropertyValue`,name:`transferNonce`,value:new URLSearchParams(location.search).get(`t`)??O?.transferNonce??null},{"@type":`PropertyValue`,name:`claimExtendUnit`,value:WE(a.claimExtendUnit)?a.claimExtendUnit:null},{"@type":`PropertyValue`,name:`claimExtendAmount`,value:a.claimExtendAmount??null},{"@type":`PropertyValue`,name:`historyLiteCount`,value:Ge?.length??0}].filter(e=>e.value!=null)};i?.lineage?.length&&o.identifier.push({"@type":`PropertyValue`,name:`lineageDepth`,value:i.lineage.length}),AC(`sigil-jsonld`,o)},[Qe,at.title,at.desc,O,nt,W,Ge?.length]),(0,q.useEffect)(()=>pE({stageId:`sigil-stage`,payload:O?{...O}:null,localHash:W,setOgImgUrl:rt,setMeta:DC,seoTitle:at.title,seoDesc:at.desc}),[O,W,b,at.title,at.desc]),(0,q.useLayoutEffect)(()=>(document.documentElement.classList.add(`sigil-scroll`),()=>document.documentElement.classList.remove(`sigil-scroll`)),[]),(0,q.useEffect)(()=>{let e=0,t=()=>{cancelAnimationFrame(e),e=requestAnimationFrame(()=>{let e=window.innerWidth,t=window.innerHeight,n=e<640?Math.max(220,Math.min(360,t*.48)):Math.max(160,Math.min(320,t*.35)),r=Math.max(160,Math.min(640,Math.min(e,t-n))),i=C.current?.clientWidth??e,a=Math.max(160,Math.min(640,i-24));S(Math.round(Math.min(r,a)))})},n=C.current??document.body,r=new ResizeObserver(()=>t());return r.observe(n),window.addEventListener(`resize`,t,{passive:!0}),t(),()=>{r.disconnect(),window.removeEventListener(`resize`,t),cancelAnimationFrame(e)}},[]),(0,q.useEffect)(()=>{E?(c(e=>e===`verified`?`verified`:`checking`),u(e=>e===`authentic`?`authentic`:`checking`),f(!1),g(`Awaiting Verifikation`)):O||(c(e=>e===`verified`?`verified`:r?`notfound`:`checking`),u(e=>e===`authentic`?`authentic`:r?`forged`:`checking`))},[E,O,r]);let ot=e=>Array.isArray(e)?[...e].map(e=>({nonce:e.nonce,amount:Number.isFinite(e.amount)?Number(e.amount):0,recipient:e.recipientPhiKey??``,ts:e.timestamp??``})).sort((e,t)=>e.nonce.localeCompare(t.nonce)).map(e=>`${e.nonce}:${e.amount}:${e.recipient}:${e.ts}`).join(`|`):``;(0,q.useEffect)(()=>{let e=PT(i.get(`d`));if(!e)return;let t=$T(O??null,W,He),n=eE(a,O??null),r=UE(e);t&&LT(t,r,n);let o=typeof r.originalAmount==`number`?r.originalAmount:void 0,s=Array.isArray(r.debits)?r.debits:void 0;T(e=>{if(!e)return e;let t=e,n=(t.originalAmount??void 0)===o,r=ot(t.debits)===ot(s);if(n&&r)return e;let i={...e};return o!==void 0&&(i.originalAmount=o),s&&(i.debits=s,i.totalDebited=BE(s)),i})},[i,O,W,He,a,T]);let[st,ct]=(0,q.useState)(!1);(0,q.useEffect)(()=>{let e=$T(O??null,W,He);if(!e)return;let t=eE(a,O??null),{merged:n,urlIsStale:r}=HT(e,i,t),o=UE(n);r&&ct(!0),VT(o,e,t,{broadcast:!1,navigate:r});let s=typeof o.originalAmount==`number`?o.originalAmount:void 0,c=Array.isArray(o.debits)?o.debits:void 0;T(e=>{if(!e)return e;let t=e,n=(t.originalAmount??void 0)===s,r=ot(t.debits)===ot(c);if(n&&r)return e;let i={...e};return s!==void 0&&(i.originalAmount=s),c&&(i.debits=c,i.totalDebited=BE(c)),i})},[O?.canonicalHash,W,He,i,a,T]),(0,q.useEffect)(()=>{if(!O?.canonicalHash)return;let e=O.canonicalHash.toLowerCase();if(r&&e&&e!==r&&je===`active`&&!He){let t=new URL(window.location.href);t.pathname=`/s/${e}`,n(`${t.pathname}${t.search}${t.hash}`,{replace:!0})}},[O?.canonicalHash,r,je,He,n]),(0,q.useEffect)(()=>{if(O&&!O.canonicalHash&&W&&r&&W!==r&&je===`active`&&!He){let e=new URL(window.location.href);e.pathname=`/s/${W}`,n(`${e.pathname}${e.search}${e.hash}`,{replace:!0})}},[O?.canonicalHash,W,r,je,He,n]),(0,q.useEffect)(()=>{let e=We;if(!e.length)return;let t=eE(a,O??null),n=(e,t)=>{let n={};typeof e?.originalAmount==`number`&&(n.originalAmount=e.originalAmount),n.originalAmount===void 0&&typeof t?.originalAmount==`number`&&(n.originalAmount=t.originalAmount);let r=Array.isArray(e?.debits)?e.debits:[],i=Array.isArray(t?.debits)?t.debits:[],a=HE([...r,...i]);return UE({originalAmount:n.originalAmount,debits:a})},r=(e,t)=>{let n=UE(e??{}),r=UE(t??{}),i=typeof n.originalAmount==`number`?n.originalAmount:NaN,a=typeof r.originalAmount==`number`?r.originalAmount:NaN,o=Number.isNaN(i)&&Number.isNaN(a)||Math.abs(i-a)<AE,s=new Set((Array.isArray(n.debits)?n.debits:[]).map(e=>e.nonce)),c=new Set((Array.isArray(r.debits)?r.debits:[]).map(e=>e.nonce));if(!o||s.size!==c.size)return!1;for(let e of s)if(!c.has(e))return!1;return!0},i=(i,a,o)=>{let s=i.toLowerCase();if(!e.includes(s))return;let c=t??null;if(c!==(o??null))return;let l=PT(a);if(!l)return;let u=PT(new URLSearchParams(window.location.search).get(`d`)),d=n(u,l);r(u,d)||(VT(d,s,c,{broadcast:!1}),T(e=>{if(!e)return e;let t={...e};return typeof d.originalAmount==`number`&&(t.originalAmount=d.originalAmount),Array.isArray(d.debits)&&(t.debits=d.debits,t.totalDebited=BE(d.debits)),t}))},o=null;try{o=new BroadcastChannel(ET),o.onmessage=e=>{let t=e.data;t?.type===`debits`&&t.canonical&&t.qs&&i(t.canonical,t.qs,t.token)}}catch{}let s=t=>{if(!(!t.key||typeof t.newValue!=`string`))for(let n of e){if(!OT(t.key,n))continue;let e=kT(t.key,n);i(n,t.newValue,e);break}};return window.addEventListener(`storage`,s,{passive:!0}),()=>{if(window.removeEventListener(`storage`,s),o&&typeof o.close==`function`)try{o.close()}catch{}}},[We,a,O,T]);let lt=(0,q.useMemo)(()=>O?typeof O.expiresAtPulse==`number`?O.expiresAtPulse:O.pulse+11:null,[O]),dt=(0,q.useMemo)(()=>k==null||lt==null?null:Math.max(0,lt-k),[k,lt]),ft=(0,q.useMemo)(()=>dt===0,[dt]),pt=(0,q.useMemo)(()=>k==null||!O?null:Math.max(0,O.pulse-k),[O,k]),mt=(0,q.useMemo)(()=>k==null||!O?!1:O.pulse>k,[O,k]),ht=O?.chakraDay??`Throat`,gt=O?.stepsPerBeat??44,_t=L(O?.pulse??0,gt),vt=typeof O?.stepPct==`number`?Math.max(0,Math.min(1,O.stepPct)):I(O?.pulse??0),yt=(0,q.useMemo)(()=>`hsl(${((jC[ht]?.hue??180)+(W&&/^[0-9a-f]+$/i.test(W)?parseInt(W.slice(-2),16)%12:0)*2.5)%360} 100% ${50+15*Math.sin(vt*2*Math.PI)}%)`,[ht,vt,W]),bt=jC[ht]?.hue??180,xt=(0,q.useMemo)(()=>`qr-${(W||r||`seed`).slice(0,12)}-${ht}-${_t}`,[W,r,ht,_t]),[St,Ct]=(0,q.useState)(!1),[Tt,Et]=(0,q.useState)(null);(0,q.useEffect)(()=>{let e=!1;return(async()=>{try{if(!O){Et(null);return}let t=O.stepsPerBeat??44,n=L(O.pulse,t),r=ow(O),i=aw(O.pulse,O.beat,n,String(O.chakraDay??``),r),a=await tw(i),o=await iw(a),s=typeof O.kaiSignature==`string`?O.kaiSignature.toLowerCase()===a.toLowerCase():!0,c=typeof O.userPhiKey==`string`?O.userPhiKey.toLowerCase()===o.toLowerCase():!0,l={pulse:O.pulse,beat:O.beat,stepsPerBeat:t,stepIndex:n,chakraDay:String(O.chakraDay??``),intention:r??null,sigmaString:i,sigmaHash:a,derivedPhiKey:o,payloadKaiSignature:O.kaiSignature??null,payloadUserPhiKey:O.userPhiKey??null,matches:{sigma:s,phi:c}};e||Et(l)}catch{e||Et(null)}})(),()=>{e=!0}},[O]);let Dt=V(()=>{tE({stageEl:document.getElementById(`sigil-stage`),payload:O,localHash:W,routeHash:r,qr:{uid:xt,url:Qe,hue:bt,accent:yt},onToast:e=>HC(y,e)})}),[Ot,kt]=(0,q.useState)(!1),[At,jt]=(0,q.useState)(``),Mt=(0,q.useCallback)(async()=>{let e=C.current;e&&(jt((await(0,kE.default)(e,{backgroundColor:null})).toDataURL(`image/png`)),kt(!0),MC()||document.querySelector(`.stargate-overlay`)?.requestFullscreen?.().catch(()=>{}))},[]),Nt=(0,q.useCallback)(()=>{kt(!1),document.fullscreenElement&&!MC()&&document.exitFullscreen?.().catch(()=>{})},[]),Pt=V(()=>{Mt()}),Ft=V(()=>{Nt()}),It=V(()=>Ct(e=>!e)),Lt=V(()=>Ve(!0)),Rt=(0,q.useCallback)(async e=>{let t=await e.arrayBuffer(),n=e.type||`application/octet-stream`,r=`data:${n};base64,${VC(t)}`;P({name:e.name,mime:n,size:e.size,dataUri:r}),HC(y,`Remembered ${e.name}`)},[]),zt=(0,q.useCallback)((e,t)=>{let n=e.stepsPerBeat??44,i=L(e.pulse,n),a=(e.canonicalHash||W||``).toLowerCase(),o=e.claimExtendUnit,s=WE(o)?o:null,c=e.claimExtendAmount,l=typeof c==`number`?c:null,u=vE({pulse:e.pulse,beat:e.beat,chakraDay:e.chakraDay??`Root`,stepsPerBeat:n,stepIndex:i,userPhiKey:e.userPhiKey??null,kaiSignature:e.kaiSignature??null,canonicalHash:a,transferNonce:e.transferNonce??null,expiresAtPulse:e.expiresAtPulse??null,claimExtendUnit:s,claimExtendAmount:l},t,{localHash:W,routeHash:r,stepsPerBeat:44,stepIndexFromPulse:L})?.url||`/s/${a}`;try{let e=new URL(u,window.location.origin);e.pathname=`/s/${a}`;let t=new URLSearchParams(window.location.search).get(`d`);t&&e.searchParams.set(`d`,t),u=e.toString()}catch{}let d=new URL(u,window.location.origin);d.pathname=`/s/${a}`,new URL(window.location.href).searchParams.forEach((e,t)=>{t!==`d`&&d.searchParams.set(t,d.searchParams.get(t)??e)});let f=UT(u)||a;return Oe(u),Ae(f),Ee(!0),u},[W,r]),Bt=(0,q.useCallback)((e,t,i=!0)=>{let a=e.stepsPerBeat??44,o=L(e.pulse,a),s=e.claimExtendUnit,c=WE(s)?s:`breaths`,l=e.claimExtendAmount,u=typeof l==`number`?l:11;return yE({pulse:e.pulse,beat:e.beat,chakraDay:e.chakraDay??`Root`,stepsPerBeat:a,stepIndex:o,userPhiKey:e.userPhiKey??null,kaiSignature:e.kaiSignature??null,canonicalHash:t,transferNonce:e.transferNonce??null,expiresAtPulse:e.expiresAtPulse??null,claimExtendUnit:c,claimExtendAmount:u},t,{localHash:W,routeHash:r,stepsPerBeat:44,stepIndexFromPulse:L,getKaiPulseEternalInt:R,breathsToPulses:H,shareTransferLink:vE,publishRotation:YE,navigate:e=>{if(i)try{n(e)}catch{try{window.location.href=e}catch{}}}})??null},[W,r,n]),Vt=(0,q.useCallback)(async e=>{if(f(!1),g(`Verifying…`),!(/image\/svg\+xml/i.test(e.type)||/\.svg$/i.test(e.name))){g(`Unsupported file. Upload an SVG sigil (.svg) only.`);return}let t=null;try{let{ok:n,errors:r,payload:i,meta:a}=pe(await e.text());if(!n||!i){g(r[0]||`Invalid SVG.`);return}t=i,M(a||{})}catch{g(`Invalid or unreadable SVG uploaded.`);return}if(!O||!t){g(`Load or link a sigil first, then verify stewardship.`);return}if(!Ze(O,t)){g(`File does not match this sealed kairos moment.`),f(!1);return}if(t.canonicalHash){let e=t.canonicalHash.toLowerCase(),n=(W||``).toLowerCase(),i=(r||``).toLowerCase(),a=n&&e===n,o=i&&e===i;if(!a&&!o){g(`SVG canonicalHash doesn’t match this link’s hash.`),f(!1);return}if(o&&!a){Ue({reason:`svg.canonicalHash matched route (legacy)`,matchedHash:e}),u(`authentic`),c(`ok`),Me(`archived`),f(!0),g(`Stewardship verified (legacy SVG). Issuing modern link…`),n&&(Bt({...O},n,!0),g(`Legacy verified. Modern transfer link ready.`));return}}if(new Set([a??void 0,O.transferNonce??void 0,t.transferNonce??void 0,Ne??void 0].filter(e=>!!e)).size>1){g(`This is not the active transfer link for that Φkey.`),f(!1);return}f(!0),g(`Stewardship verified`)},[O,Ze,W,r,a,Ne,Bt]),Ht=V(async()=>{if(z)return;let e=C.current?.querySelector(`svg`),t=O??{},n=WE(t.claimExtendUnit)?t.claimExtendUnit:void 0,i=typeof t.claimExtendAmount==`number`?t.claimExtendAmount:null;await uE({expired:!!ft,exporting:z,setExporting:te,svgEl:e,payload:O?{pulse:O.pulse,beat:O.beat,chakraDay:O.chakraDay??null,stepsPerBeat:O.stepsPerBeat??void 0,stepIndex:O.stepIndex??null,exportedAtPulse:O.exportedAtPulse??null,canonicalHash:O.canonicalHash??null,userPhiKey:O.userPhiKey??null,kaiSignature:O.kaiSignature??null,transferNonce:O.transferNonce??null,expiresAtPulse:O.expiresAtPulse??null,claimExtendUnit:n,claimExtendAmount:i,attachment:O.attachment??null,provenance:O.provenance??null}:null,isFutureSealed:mt,linkStatus:je,setToast:e=>HC(y,e),expiryUnit:ce,expiryAmount:ue,localHash:W,routeHash:r,transferToken:a??null,getKaiPulseEternalInt:R,stepIndexFromPulse:L,STEPS_PER_BEAT:44})}),Ut=(0,q.useCallback)(e=>{let t=typeof e==`string`?e:e?.hash;if(!t)return;let n=t.toLowerCase();de(e=>e===n?e:n)},[]),Wt=E&&!O,Gt=s===`notfound`||s===`error`,Kt=O?.pulse??0,qt=O?.beat??0,Jt=((A??0)/1e3).toFixed(3),Yt=je===`archived`,Xt=d&&!Yt,Zt=(0,q.useMemo)(()=>l===`authentic`&&Yt&&!a&&!!r&&!!W&&r!==W,[l,Yt,a,r,W]);(0,q.useEffect)(()=>{if(!O||l!==`authentic`||s===`mismatch`||s===`error`||s===`notfound`)return;let e=!1;return(async()=>{try{let t=O.stepsPerBeat??44,n=L(O.pulse,t),r=ow(O),i=await tw(aw(O.pulse,O.beat,n,String(O.chakraDay??``),r)),a=typeof O.kaiSignature==`string`?O.kaiSignature.toLowerCase()===i.toLowerCase():!0,o=await iw(i),l=typeof O.userPhiKey==`string`?O.userPhiKey.toLowerCase()===o.toLowerCase():!0;!e&&a&&l&&s!==`verified`&&c(`verified`)}catch{}})(),()=>{e=!0}},[O,l,s,je]),(0,q.useEffect)(()=>{let e=(r||``).toLowerCase(),t=a||null,n=O?.transferNonce||null,i=!!t&&!!n&&t===n&&(lt==null||k==null||k<lt),o=je;if(i)o=`active`;else if(!(W||O?.canonicalHash||He?.matchedHash))o=`checking`;else{let r=We;o=e&&r.length&&r.includes(e)||e&&W&&e!==W&&!He?`active`:n?t?Ne&&Ne!==t?`archived`:t===n?`active`:`archived`:`archived`:He?`archived`:`active`}o!==je&&Me(o)},[r,We,W,O?.transferNonce,a,Ne,lt,k,He,je]);let[Qt,$t]=(0,q.useState)(``),[en,tn]=(0,q.useState)(``);(0,q.useEffect)(()=>{let e=!0;return(async()=>{if(!O){$t(``),tn(``);return}let t=(O.canonicalHash||W||``).toLowerCase(),n=R(new Date),r=await mw(O,t,n,ee(n),L(n,O.stepsPerBeat??44));e&&($t(r.ownerPhiKey),tn(r.kaiSig))})(),()=>{e=!1}},[O,W]);let nn=(0,q.useCallback)(async e=>{if(e?.preventDefault?.(),e?.stopPropagation?.(),!O||!W||mt||Yt)return;let t=(O.canonicalHash||W||``).toLowerCase(),n=R(new Date),r=await mw(O,t,n,ee(n),L(n,O.stepsPerBeat??44));re(r.ownerPhiKey),ie(r.kaiSig),setTimeout(()=>{try{on()}catch{}},0)},[O,W,mt,Yt]),rn=(0,q.useCallback)(e=>{let t=`/${e}`;try{window.location.assign(t)}catch{window.location.href=t}},[]),an=(0,q.useCallback)(async()=>{try{let e=await(await fetch(`/verifier.inline.html`,{cache:`no-store`})).text(),t=new Blob([e],{type:`text/html`}),n=document.createElement(`a`);n.href=URL.createObjectURL(t),n.download=`verifier.html`,document.body.appendChild(n),n.click(),setTimeout(()=>{URL.revokeObjectURL(n.href),n.remove()},0),HC(y,`Downloading verifier…`)}catch{HC(y,`Download failed`)}},[]);({...It});let on=(0,q.useCallback)(()=>{if(!O)return HC(y,`Nothing to mint`);let e=C.current?.querySelector(`svg`);if(!e)return HC(y,`No Φkey in frame`);if(!W)return HC(y,`Glyph hash not ready yet`);if(je!==`active`)return HC(y,`Archived link — cannot exhale from here`);if(mt)return HC(y,`Opens after the moment—claim unlocks then`);let t=CC(j??{},O.pulse),n=(ne||O.userPhiKey||``).trim();if(!n)return HC(y,`Owner ΦKey required`);let i=Math.max(0,Math.floor(ue||0)),a=ce===`breaths`?H(i):G(i),o=R(new Date),s=o+a,c=W.toLowerCase(),l=crypto.getRandomValues(new Uint32Array(4)).join(``),u=O.stepsPerBeat??44,d=L(O.pulse,u),f=L(o,u),p={...wC(n,B||O.kaiSignature,O,t.length?`transfer`:`mint`,(N??O.attachment)?.name,o),stepIndex:d,atStepIndex:f},m={...O,userPhiKey:n,kaiSignature:B||O.kaiSignature,stepsPerBeat:O.stepsPerBeat??44,attachment:N??O.attachment??void 0,expiresAtPulse:s,canonicalHash:c,transferNonce:l,claimExtendUnit:ce,claimExtendAmount:i,provenance:[...t,p]};(async()=>{let t=await tw(aw(m.pulse,m.beat,d,String(m.chakraDay??``),ow(m))),n=await iw(t);m.kaiSignature=t,m.userPhiKey=m.userPhiKey||n;let i=Array.from(new Set([O.canonicalHash,r,W].filter(Boolean).map(e=>e.toLowerCase())));i.length&&YE(i,l),Me(`archived`),ze(Date.now()+250),K(e,m),lw(e),T(m),M(m),HC(y,`Sealed & archived`);let a=zt(m,l)||`/s/${c}`;a=await Fe(m,c,l,a,e),Oe(IE(a)),m.canonicalHash&&YE([m.canonicalHash.toLowerCase()],l),setTimeout(()=>ze(0),0)})()},[O,j,ne,B,N,ue,ce,W,r,je,mt,zt]),sn=O,cn=(0,q.useMemo)(()=>BE(sn?.debits??[]),[sn?.debits]),ln=(0,q.useMemo)(()=>{let e=(typeof sn?.originalAmount==`number`?sn.originalAmount:qe?.valuePhi??0)-cn;return e>0?e:0},[sn?.originalAmount,qe?.valuePhi,cn]),un=(sn?.debits?.length??0)>0||typeof sn?.originalAmount==`number`,dn=(0,q.useMemo)(()=>un?ln:Je??qe?.valuePhi??0,[un,ln,Je,qe?.valuePhi]),fn=oe,{usdPerPhi:pn,phiPerUsd:mn}=(0,q.useMemo)(()=>{try{let e=k??R(new Date),t=ae({meta:O||{},nowPulse:e,usd:100,currentStreakDays:0,lifetimeUsdSoFar:0},fn);return{usdPerPhi:t.usdPerPhi??0,phiPerUsd:t.phiPerUsd??0}}catch{return{usdPerPhi:0,phiPerUsd:0}}},[O,k,fn]),hn=(dn??0)*(pn||0),gn=(0,q.useCallback)(async()=>{if(!O)return``;let e=O.stepsPerBeat??44,t=L(O.pulse,e);return await iw(O.kaiSignature??await tw(aw(O.pulse,O.beat,t,String(O.chakraDay??``),ow(O))))},[O]),[_n,vn]=(0,q.useState)([]),yn=(0,q.useCallback)(()=>{vn(XE($T(O??null,W,He),eE(a,O??null)))},[O,W,He,a]);(0,q.useEffect)(()=>{yn();let e=null;try{e=new BroadcastChannel(GE),e.onmessage=e=>{let t=e.data;if(!t||t.type!==`descendants`)return;let n=$T(O??null,W,He),r=eE(a,O??null);!n||!r||t.canonical!==n.toLowerCase()||t.token!==r||Array.isArray(t.list)&&vn(t.list)}}catch{}let t=e=>{if(!e.key||!e.newValue)return;let t=$T(O??null,W,He),n=eE(a,O??null);if(!(!t||!n)&&e.key===KE(t,n))try{let t=JSON.parse(e.newValue||`[]`);Array.isArray(t)&&vn(t)}catch{}};return window.addEventListener(`storage`,t,{passive:!0}),()=>{if(e&&typeof e.close==`function`)try{e.close()}catch{}window.removeEventListener(`storage`,t)}},[O,W,He,a,yn]);let bn=(0,q.useCallback)(async(e,t)=>{if(!O)return null;let n=R(new Date),r=crypto.getRandomValues(new Uint32Array(4)).join(``),i=O.stepsPerBeat??44,o=L(O.pulse,i),s=(W||O.canonicalHash||``).toLowerCase(),c=t??eE(a,O??null),l=Array.isArray(O.lineage)?[...O.lineage]:[],u=(l[l.length-1]?.depth??0)+1,d={token:r,parentToken:c??null,amount:Number(e.toFixed(6)),timestamp:n,depth:u,senderPhiKey:O.userPhiKey??null},f={...O,userPhiKey:void 0,originalAmount:Number(e.toFixed(6)),mintedAtPulse:n,transferNonce:r,expiresAtPulse:n+(ce===`breaths`?H(ue):G(ue)),claimExtendUnit:ce,claimExtendAmount:ue,canonicalHash:s,lineage:[...l,d]},p=await tw(aw(f.pulse,f.beat,o,String(f.chakraDay??``),ow(f))),m=await iw(p);f.kaiSignature=p,f.userPhiKey=m;let h=zt(f,r)||`/s/${s}`;try{let t=new URL(h,window.location.origin);t.pathname=`/s/${s}`,t.searchParams.set(`d`,MT({originalAmount:f.originalAmount}));let i=QT(t.toString(),f);i=await Fe(f,s,r,i);let a=UT(i)||s;LT(a,PT(new URL(i).searchParams.get(`d`))??{},r);let o=$T(O??null,W,He),l=c??null;if(o&&l){let t=[...XE(o,l),{token:r,parentToken:l,amount:Number(e.toFixed(6)),timestamp:n,depth:1,recipientPhiKey:f.userPhiKey}];ZE(o,l,t),QE(o,l,t),vn(t)}return Oe(IE(i)),Ae(a),Ee(!0),i}catch{let e=QT(h||`/s/${s}`,f);return Oe(e),Ae(s),Ee(!0),e||null}},[O,ce,ue,W,zt,He,a]);(0,q.useEffect)(()=>{let e=e=>{if(!(e instanceof HTMLElement))return!1;let t=e.tagName.toLowerCase();return t===`input`||t===`textarea`||e.isContentEditable},t=t=>{if(t.defaultPrevented||e(t.target))return;let n=t.key.toLowerCase();t.metaKey||t.ctrlKey||t.altKey||(n===`s`?tt():n===`l`?et(Qe,`Link copied`):n===`h`?W&&et(W,`Hash copied`):n===`z`?Ht.onClick?.(new MouseEvent(`click`)):n===`p`?Dt.onClick?.(new MouseEvent(`click`)):n===`g`&&Mt())};return window.addEventListener(`keydown`,t),()=>window.removeEventListener(`keydown`,t)},[tt,et,Qe,W,Ht,Dt,Mt]);let xn=(0,q.useCallback)(e=>{let t=e?.silent??!0;if(!$T(O??null,W,He))return null;let r=eE(a,O??null);if(r)return r;r=crypto.getRandomValues(new Uint32Array(4)).join(``);try{let e=new URL(window.location.href);e.searchParams.set(`t`,r),t?window.history.replaceState(null,``,`${e.pathname}${e.search}${e.hash}`):n(`${e.pathname}${e.search}${e.hash}`,{replace:!0})}catch{}return T(e=>e&&{...e,transferNonce:r}),Me(`active`),r},[O,W,He,a,T,n,Me]),[Sn,Cn]=(0,q.useState)(0),wn=(0,q.useCallback)(async()=>{if(!Xt)return HC(y,`Verify Stewardship first`);if(!O)return HC(y,`No payload`);if(fe)return;let e=Number(Sn)||0;if(e<=0)return HC(y,`Enter an amount > 0`);let t=$T(O??null,W,He),n=eE(a,O??null);if(n||=xn({silent:!0})||null,!t||!n)return HC(y,`Link not initialized`);if(Ne&&Ne!==n)return HC(y,`Archived link — cannot exhale from here`);me(!0);let{ok:r,id:i}=LE(t,n);if(ve.current=i,!r)return me(!1),HC(y,`Another exhale is in progress`);try{let{merged:r}=HT(t,new URLSearchParams(window.location.search),n),i=UE({originalAmount:typeof r.originalAmount==`number`?r.originalAmount:typeof O?.originalAmount==`number`?O.originalAmount:qe?.valuePhi??0,debits:Array.isArray(r.debits)?r.debits:[]});if(e>Math.max(0,(i.originalAmount??0)-BE(i.debits||[]))+AE)return HC(y,`Amount exceeds available`);let a=await gn();if(!a)return HC(y,`Could not derive Φkey`);let o={amount:Number(e.toFixed(6)),nonce:crypto.getRandomValues(new Uint32Array(4)).join(``),recipientPhiKey:a,timestamp:R(new Date)};VT(UE({originalAmount:i.originalAmount,debits:[...i.debits??[],o]}),t,n,{broadcast:!0});let{merged:s}=HT(t,new URLSearchParams(window.location.search),n),c=UE(s);if(!(c.debits??[]).some(e=>e.nonce===o.nonce)){HC(y,`Exhale conflicted — try again`);return}T(e=>{if(!e)return e;let t={...e};return t.originalAmount=typeof c.originalAmount==`number`?c.originalAmount:typeof t.originalAmount==`number`?t.originalAmount:qe?.valuePhi??0,t.debits=Array.isArray(c.debits)?c.debits:[],t.totalDebited=BE(t.debits),t}),Cn(0),HC(y,`Sent ${XC(o.amount)} Φ`),bn(o.amount,n)}finally{RE(t,n,ve.current),me(!1)}},[Xt,O,O?.originalAmount,qe?.valuePhi,Sn,Ne,W,He,a,T,gn,bn,Cn,fe,xn]),Tn=St||Be||Ot||Te||be&&Zt;(0,q.useEffect)(()=>{let e=`bp-open`;return Tn?document.body.classList.add(e):document.body.classList.remove(e),()=>document.body.classList.remove(e)},[Tn]);let[En,Dn]=(0,q.useState)(!1),On=(0,q.useCallback)(()=>{Dn(!0),window.setTimeout(()=>Dn(!1),2e3)},[]),kn=V(()=>{et(W||``,`Hash copied`)}),An=V(async()=>{await et(Qe,`Link copied`)&&On()}),jn=V(()=>{tt()}),Mn=(0,J.jsxs)(_e,{frameRef:C,children:[!Wt&&!Gt&&O&&(0,J.jsx)(`div`,{id:`sigil-stage`,style:{position:`relative`,width:b,height:b,margin:`0 auto`},children:(0,J.jsx)(x,{pulse:Kt,beat:qt,stepPct:vt,chakraDay:ht,size:b,hashMode:`deterministic`,origin:``,onReady:Ut})}),Wt&&(0,J.jsx)(`div`,{className:`sp-skeleton`,"aria-hidden":`true`}),Gt&&(0,J.jsx)(`div`,{className:`sp-error`,children:s===`notfound`?`Waiting for SVG upload or ?p= payload.`:`Unable to load sigil.`})]}),Nn=O?.lineage??[],Pn=(0,q.useCallback)((e,t)=>{let n=e=>typeof e==`object`&&!!e,r=e=>{if(typeof t==`string`)return t;if(!n(e))return``;let r=typeof e.reason==`string`?e.reason:``,i=n(e.detail)?e.detail:null,a=i&&typeof i.reason==`string`?i.reason:``;return r||a||``},i=e=>{if(!n(e))return null;let t=e.target;return t instanceof HTMLElement?t:null},a=r(e),o=i(e),s=a===`closeClick`||a===`close-button`||a===`explicit`||a===`close`,c=!!o?.closest?.(`[data-modal-close],[data-close],.sealmoment__close,.sp-modal__close,button[aria-label="Close"],button[aria-label="close"],button[title="Close"]`);if(s||c||e==null&&t==null){Ee(!1),Oe(``),Ae(``);return}},[]),{series:Fn,pushSample:In}=QS({maxPoints:1512*8,maxBeats:1512});return(0,q.useEffect)(()=>{let e=(3+Math.sqrt(5))*1e3,t=null,n=null,r=()=>{let i=dn;Number.isFinite(i)&&In({t:Date.now(),v:i}),n=window.setTimeout(()=>{t=requestAnimationFrame(r)},e)};return r(),()=>{n&&clearTimeout(n),t&&cancelAnimationFrame(t)}},[dn,In]),(0,J.jsxs)(`main`,{className:`sigilpage`,role:`main`,"aria-label":`Kai Sigil Page`,"data-owner-verified":Xt,"data-archived":Yt,"data-old-link":st?`true`:`false`,"data-version":`v48`,children:[(0,J.jsx)(`div`,{className:`sp-veil`,"aria-hidden":`true`}),(0,J.jsx)(`div`,{className:`sp-veil-stars`,"aria-hidden":`true`}),(0,J.jsx)(`div`,{className:`sp-viewport`,"aria-hidden":!1,children:(0,J.jsxs)(`section`,{className:`sp-shell`,"data-center":!0,children:[(0,J.jsx)(ge,{glyphAuth:l,linkStatus:je,isArchived:Yt,localHash:W,copyHashPress:kn}),(l===`authentic`||s===`verified`)&&(0,J.jsxs)(J.Fragment,{children:[(0,J.jsx)(`style`,{children:`
